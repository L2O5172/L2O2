<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>美味廚房點餐系統</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --primary: #e74c3c;
      --primary-dark: #c0392b;
      --bg: #f8f9fa;
      --card: #ffffff;
      --text: #2c3e50;
      --border: #dee2e6;
      --success: #27ae60;
      --warning: #f39c12;
      --gray: #95a5a6;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 10px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 1.5rem;
      text-align: center;
    }

    header h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }

    header p {
      opacity: 0.9;
      font-size: 0.95rem;
    }

    .order-type {
      display: flex;
      justify-content: center;
      gap: 1rem;
      padding: 1rem;
      background: #f1f2f6;
      border-bottom: 1px solid var(--border);
    }

    .type-btn {
      flex: 1;
      padding: 0.8rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .type-btn.active {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }

    .section {
      padding: 1.5rem;
    }

    .section-title {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      color: var(--primary-dark);
      border-bottom: 2px solid var(--primary);
      padding-bottom: 0.5rem;
    }

    .menu-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .cat-btn {
      padding: 0.5rem 1rem;
      background: #ecf0f1;
      border: none;
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .cat-btn.active {
      background: var(--primary);
      color: white;
    }

    .menu-items {
      display: grid;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .menu-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
      display: none;
    }

    .menu-card.show {
      display: block;
    }

    .menu-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }

    .item-header {
      background: #f8f9fa;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .item-name {
      font-weight: bold;
      font-size: 1.1rem;
    }

    .item-price {
      color: var(--primary);
      font-weight: bold;
    }

    .item-desc {
      padding: 0 1rem 1rem;
      font-size: 0.9rem;
      color: var(--gray);
    }

    .item-options {
      padding: 1rem;
      border-top: 1px dashed var(--border);
      display: none;
    }

    .item-options.show {
      display: block;
    }

    .option-group {
      margin-bottom: 1rem;
    }

    .option-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text);
    }

    select, input[type="text"], textarea {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .qty-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      background: white;
      border-radius: 50%;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
    }

    .qty-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .qty-display {
      min-width: 40px;
      text-align: center;
      font-weight: bold;
    }

    .add-to-cart {
      margin-top: 1rem;
      padding: 0.7rem 1.2rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      transition: background 0.3s;
    }

    .add-to-cart:hover {
      background: var(--primary-dark);
    }

    .add-to-cart:disabled {
      background: var(--gray);
      cursor: not-allowed;
    }

    .cart-section {
      border-top: 1px solid var(--border);
      background: #f8f9fa;
    }

    .cart-items {
      max-height: 300px;
      overflow-y: auto;
      padding: 0 1rem;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      padding: 0.8rem 0;
      border-bottom: 1px dashed var(--border);
      font-size: 0.95rem;
    }

    .cart-item-name {
      flex: 1;
      font-weight: 600;
    }

    .cart-item-details {
      flex: 2;
      font-size: 0.85rem;
      color: var(--gray);
      margin-left: 1rem;
    }

    .cart-item-price {
      font-weight: bold;
      color: var(--primary);
    }

    .cart-summary {
      padding: 1rem;
      background: white;
      border-top: 1px solid var(--border);
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--primary-dark);
    }

    .customer-form {
      padding: 1rem;
      background: #f1f2f6;
      border-top: 1px solid var(--border);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.full {
      grid-column: span 2;
    }

    label {
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text);
    }

    input {
      padding: 0.7rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
    }

    .submit-btn {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--success);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      transition: background 0.3s;
    }

    .submit-btn:hover {
      background: #219653;
    }

    .submit-btn:disabled {
      background: var(--gray);
      cursor: not-allowed;
    }

    .sold-out {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #e74c3c;
      color: white;
      padding: 0.3rem 0.6rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .addon-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 0;
      border-bottom: 1px solid #eee;
    }

    .addon-name {
      flex: 1;
    }

    .addon-price {
      color: var(--primary);
      font-weight: bold;
      margin-left: 1rem;
    }

    .empty-cart {
      text-align: center;
      padding: 2rem;
      color: var(--gray);
      font-style: italic;
    }

    @media (max-width: 600px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      .form-group.full {
        grid-column: span 1;
      }
      .menu-items {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>美味廚房</h1>
      <p>精選牛排與套餐料理</p>
    </header>

    <div class="order-type">
      <div class="type-btn active" data-type="內用">內用</div>
      <div class="type-btn" data-type="外帶">外帶</div>
    </div>

    <div class="section">
      <div class="section-title">菜單</div>
      <div class="menu-categories" id="categoryTabs"></div>
      <div class="menu-items" id="menuItems"></div>
    </div>

    <div class="section">
      <div class="section-title">加購項目</div>
      <div id="addonsContainer"></div>
    </div>

    <div class="cart-section">
      <div class="section-title">購物車</div>
      <div class="cart-items" id="cartItems">
        <div class="empty-cart">尚未加入任何餐點</div>
      </div>
      <div class="cart-summary">
        <div class="total-row">
          <span>總計</span>
          <span id="totalAmount">$0</span>
        </div>
      </div>
    </div>

    <div class="customer-form">
      <div class="form-grid">
        <div class="form-group">
          <label>姓名 *</label>
          <input type="text" id="customerName" placeholder="請輸入姓名" required />
        </div>
        <div class="form-group">
          <label>電話 *</label>
          <input type="tel" id="customerPhone" placeholder="09xxxxxxxx" required />
        </div>
        <div class="form-group" id="tableGroup">
          <label>桌號 *</label>
          <input type="text" id="tableNumber" placeholder="例如：A1" />
        </div>
        <div class="form-group full">
          <label>備註（選填）</label>
          <textarea id="orderNotes" rows="2" placeholder="有其他需求請告知"></textarea>
        </div>
      </div>
      <button class="submit-btn" id="submitOrder">送出訂單</button>
    </div>
  </div>

  <script>
    // ==== 全域變數 ====
    const API_URL = 'https://script.google.com/macros/s/AKfycbx83vpj3iuB6rPorzWodu9pVw3UyMSzsfUBwQZe9a90ZSvWdZvr16D_uhIbjV3mpvvJ/exec';
    let menuData = { menu: [], addons: [] };
    let cart = [];
    let orderType = '內用';

    // ==== DOM 元素 ====
    const categoryTabs = document.getElementById('categoryTabs');
    const menuItemsContainer = document.getElementById('menuItems');
    const addonsContainer = document.getElementById('addonsContainer');
    const cartItems = document.getElementById('cartItems');
    const totalAmountEl = document.getElementById('totalAmount');
    const typeButtons = document.querySelectorAll('.type-btn');
    const tableGroup = document.getElementById('tableGroup');

    // ==== 初始化 ====
    document.addEventListener('DOMContentLoaded', async () => {
      await loadMenu();
      setupEventListeners();
      updateCartDisplay();
    });

    // ==== 載入菜單 ====
    async function loadMenu() {
      try {
        const response = await fetch(`${API_URL}?action=getMenu`);
        const result = await response.json();
        if (!result.menu) throw new Error('載入菜單失敗');
        menuData = result;
        renderCategories();
        renderMenuItems();
        renderAddons();
      } catch (err) {
        Swal.fire('錯誤', '無法載入菜單，請稍後再試', 'error');
      }
    }

    // ==== 渲染分類標籤 ====
    function renderCategories() {
      categoryTabs.innerHTML = '';
      menuData.menu.forEach((cat, index) => {
        const btn = document.createElement('button');
        btn.className = 'cat-btn';
        btn.textContent = cat.title;
        btn.dataset.index = index;
        btn.onclick = () => filterByCategory(index);
        categoryTabs.appendChild(btn);
      });
      // 預設顯示第一個
      if (menuData.menu.length > 0) {
        document.querySelector('.cat-btn').classList.add('active');
        filterByCategory(0);
      }
    }

    // ==== 依分類過濾 ====
    function filterByCategory(index) {
      document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`.cat-btn[data-index="${index}"]`).classList.add('active');

      document.querySelectorAll('.menu-card').forEach(card => {
        card.classList.remove('show');
        if (parseInt(card.dataset.catIndex) === index) {
          card.classList.add('show');
        }
      });
    }

    // ==== 渲染菜單項目 ====
    function renderMenuItems() {
      menuItemsContainer.innerHTML = '';
      menuData.menu.forEach((category, catIndex) => {
        category.items.forEach(item => {
          if (!item.isAvailable) return;

          const card = document.createElement('div');
          card.className = 'menu-card';
          card.dataset.catIndex = catIndex;

          const header = document.createElement('div');
          header.className = 'item-header';
          header.onclick = () => toggleOptions(card);

          const nameDiv = document.createElement('div');
          nameDiv.className = 'item-name';
          nameDiv.textContent = `${item.name} (${item.weight})`;

          const priceDiv = document.createElement('div');
          priceDiv.className = 'item-price';
          priceDiv.textContent = `$${item.price}`;

          header.appendChild(nameDiv);
          header.appendChild(priceDiv);

          const desc = document.createElement('div');
          desc.className = 'item-desc';
          desc.textContent = category.description;

          const options = document.createElement('div');
          options.className = 'item-options';

          // 自訂選項
          if (item.customizations.doneness) {
            options.appendChild(createSelect('熟度', 'doneness', ['三分', '五分', '七分', '全熟']));
          }
          if (item.customizations.sauceChoice) {
            options.appendChild(createSelect('沾醬', 'sauces', ['黑胡椒', '蘑菇', '紅酒', '無']));
          }
          if (item.customizations.drinkChoice) {
            options.appendChild(createSelect('飲料', 'drinks', ['可樂', '雪碧', '紅茶', '無']));
          }
          if (item.customizations.notes) {
            options.appendChild(createTextarea('備註', 'notes'));
          }

          // 數量控制
          const qtyCtrl = document.createElement('div');
          qtyCtrl.className = 'quantity-controls';
          qtyCtrl.innerHTML = `
            <div class="qty-btn" onclick="updateQty(this, -1, event)">-</div>
            <div class="qty-display">1</div>
            <div class="qty-btn" onclick="updateQty(this, 1, event)">+</div>
          `;
          options.appendChild(qtyCtrl);

          // 加入購物車按鈕
          const addBtn = document.createElement('button');
          addBtn.className = 'add-to-cart';
          addBtn.textContent = '加入購物車';
          addBtn.onclick = (e) => {
            e.stopPropagation();
            addToCart(item, options, qtyCtrl);
          };
          options.appendChild(addBtn);

          card.appendChild(header);
          card.appendChild(desc);
          card.appendChild(options);
          menuItemsContainer.appendChild(card);
        });
      });
    }

    function createSelect(label, name, options) {
      const group = document.createElement('div');
      group.className = 'option-group';
      group.innerHTML = `<label class="option-label">${label}</label>`;
      const select = document.createElement('select');
      select.name = name;
      options.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt;
        o.textContent = opt;
        select.appendChild(o);
      });
      group.appendChild(select);
      return group;
    }

    function createTextarea(label, name) {
      const group = document.createElement('div');
      group.className = 'option-group';
      group.innerHTML = `<label class="option-label">${label}</label>`;
      const ta = document.createElement('textarea');
      ta.name = name;
      ta.rows = 2;
      ta.placeholder = '例如：不要洋蔥';
      group.appendChild(ta);
      return group;
    }

    // ==== 展開/收合選項 ====
    function toggleOptions(card) {
      const options = card.querySelector('.item-options');
      options.classList.toggle('show');
    }

    // ==== 更新數量 ====
    function updateQty(btn, change, event) {
      event.stopPropagation();
      const display = btn.parentElement.querySelector('.qty-display');
      let qty = parseInt(display.textContent) + change;
      qty = Math.max(1, qty);
      display.textContent = qty;
    }

    // ==== 加入購物車 ====
    function addToCart(item, optionsDiv, qtyCtrl) {
      const qty = parseInt(qtyCtrl.querySelector('.qty-display').textContent);
      const customizations = {};

      optionsDiv.querySelectorAll('select, textarea').forEach(el => {
        if (el.value) customizations[el.name] = el.value;
      });

      const cartItem = {
        id: item.id,
        name: item.name,
        price: item.price,
        quantity: qty,
        customizations: customizations,
        type: 'menu'
      };

      // 檢查是否已存在相同項目
      const existingIndex = cart.findIndex(c =>
        c.id === cartItem.id &&
        JSON.stringify(c.customizations) === JSON.stringify(cartItem.customizations)
      );

      if (existingIndex > -1) {
        cart[existingIndex].quantity += qty;
      } else {
        cart.push(cartItem);
      }

      updateCartDisplay();
      Swal.fire({
        icon: 'success',
        title: '已加入',
        text: `${item.name} x${qty}`,
        timer: 1000,
        showConfirmButton: false
      });
    }

    // ==== 渲染加購項目 ====
    function renderAddons() {
      addonsContainer.innerHTML = '';
      menuData.addons.forEach(addon => {
        if (!addon.isAvailable) return;

        const item = document.createElement('div');
        item.className = 'addon-item';

        const name = document.createElement('div');
        name.className = 'addon-name';
        name.textContent = addon.name;

        const price = document.createElement('div');
        price.className = 'addon-price';
        price.textContent = `+$${addon.price}`;

        const addBtn = document.createElement('button');
        addBtn.className = 'qty-btn';
        addBtn.textContent = '+';
        addBtn.onclick = () => addAddonToCart(addon);

        item.appendChild(name);
        item.appendChild(price);
        item.appendChild(addBtn);
        addonsContainer.appendChild(item);
      });
    }

    function addAddonToCart(addon) {
      const existing = cart.find(c => c.id === addon.id && c.type === 'addon');
      if (existing) {
        existing.quantity += 1;
      } else {
        cart.push({
          id: addon.id,
          name: addon.name,
          price: addon.price,
          quantity: 1,
          type: 'addon'
        });
      }
      updateCartDisplay();
    }

    // ==== 更新購物車顯示 ====
    function updateCartDisplay() {
      if (cart.length === 0) {
        cartItems.innerHTML = '<div class="empty-cart">尚未加入任何餐點</div>';
        totalAmountEl.textContent = '$0';
        return;
      }

      cartItems.innerHTML = '';
      let total = 0;

      cart.forEach((item, index) => {
        const row = document.createElement('div');
        row.className = 'cart-item';

        const name = document.createElement('div');
        name.className = 'cart-item-name';
        name.textContent = `${item.name} x${item.quantity}`;

        const details = document.createElement('div');
        details.className = 'cart-item-details';
        const dets = [];
        if (item.customizations) {
          Object.entries(item.customizations).forEach(([k, v]) => {
            if (v && v !== 'N/A' && v !== 'None') dets.push(`${k === 'notes' ? '備註' : k}: ${v}`);
          });
        }
        details.textContent = dets.join(' | ');

        const price = document.createElement('div');
        price.className = 'cart-item-price';
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        price.textContent = `$${itemTotal}`;

        const remove = document.createElement('button');
        remove.textContent = '×';
        remove.style.marginLeft = '10px';
        remove.style.color = '#e74c3c';
        remove.style.fontWeight = 'bold';
        remove.onclick = () => {
          cart.splice(index, 1);
          updateCartDisplay();
        };

        row.appendChild(name);
        row.appendChild(details);
        row.appendChild(price);
        row.appendChild(remove);
        cartItems.appendChild(row);
      });

      totalAmountEl.textContent = `$${total}`;
    }

    // ==== 事件監聽 ====
    function setupEventListeners() {
      typeButtons.forEach(btn => {
        btn.onclick = () => {
          typeButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          orderType = btn.dataset.type;
          tableGroup.style.display = orderType === '內用' ? 'block' : 'none';
        };
      });

      document.getElementById('submitOrder').onclick = submitOrder;
    }

    // ==== 送出訂單 ====
    async function submitOrder() {
      const name = document.getElementById('customerName').value.trim();
      const phone = document.getElementById('customerPhone').value.trim();
      const table = orderType === '內用' ? document.getElementById('tableNumber').value.trim() : 'N/A';

      if (!name || !phone) {
        Swal.fire('請填寫完整', '姓名與電話為必填', 'warning');
        return;
      }

      if (orderType === '內用' && !table) {
        Swal.fire('請填寫桌號', '內用需提供桌號', 'warning');
        return;
      }

      if (cart.length === 0) {
        Swal.fire('購物車為空', '請先選擇餐點', 'warning');
        return;
      }

      const orderData = {
        customerName: name,
        customerPhone: phone,
        tableNumber: table,
        totalAmount: cart.reduce((sum, i) => sum + i.price * i.quantity, 0),
        orderType: orderType,
        items: JSON.stringify(cart.map(item => ({
          name: item.name,
          quantity: item.quantity,
          customizations: {
            doneness: item.customizations?.doneness || 'N/A',
            drinks: item.customizations?.drinks || 'N/A',
            sauces: item.customizations?.sauces || 'None',
            addons: item.customizations?.addons || 'None',
            notes: item.customizations?.notes || 'None'
          }
        })))
      };

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'createOrder', orderData }),
          headers: { 'Content-Type': 'text/plain' }
        });

        const result = await response.json();

        if (result.success) {
          Swal.fire({
            icon: 'success',
            title: '訂單送出成功！',
            text: `訂單編號：${result.orderId}\n請記住您的訂單編號`,
            confirmButtonText: '完成'
          }).then(() => {
            resetForm();
          });
        } else {
          throw new Error(result.message || '送出失敗');
        }
      } catch (err) {
        Swal.fire('送出失敗', err.message, 'error');
      }
    }

    function resetForm() {
      cart = [];
      updateCartDisplay();
      document.getElementById('customerName').value = '';
      document.getElementById('customerPhone').value = '';
      document.getElementById('tableNumber').value = '';
      document.getElementById('orderNotes').value = '';
    }
  </script>
</body>
</html>
