<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å°ç£å°åƒåº— - åº—å®¶ç®¡ç†å¾Œå°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; width: 80mm; font-size: 12px; }
      button, nav, .no-print { display: none !important; }
    }
    .status-pending { @apply bg-yellow-100 text-yellow-800 border-yellow-300; }
    .status-confirmed { @apply bg-blue-100 text-blue-800 border-blue-300; }
    .status-ready { @apply bg-purple-100 text-purple-800 border-purple-300; }
    .status-completed { @apply bg-green-100 text-green-800 border-green-300; }
    .status-cancelled { @apply bg-red-100 text-red-800 border-red-300; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Navigation -->
  <nav class="bg-green-600 text-white p-4 shadow-lg no-print">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold">ğŸœ å°ç£å°åƒåº— - ç®¡ç†å¾Œå°</h1>
      <div class="space-x-4">
        <button onclick="showTab('orders')" class="hover:underline">è¨‚å–®ç®¡ç†</button>
        <button onclick="showTab('stats')" class="hover:underline">éŠ·å”®çµ±è¨ˆ</button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto p-4 max-w-6xl">

    <!-- Tabs -->
    <div id="ordersTab" class="tab-content">
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“‹ è¨‚å–®ç®¡ç†</h2>
        <div class="flex flex-wrap gap-2 mb-4">
          <button onclick="filterOrders('all')" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">å…¨éƒ¨</button>
          <button onclick="filterOrders('pending')" class="px-4 py-2 bg-yellow-200 rounded hover:bg-yellow-300">å¾…ç¢ºèª</button>
          <button onclick="filterOrders('confirmed')" class="px-4 py-2 bg-blue-200 rounded hover:bg-blue-300">å·²ç¢ºèª</button>
          <button onclick="filterOrders('ready')" class="px-4 py-2 bg-purple-200 rounded hover:bg-purple-300">æº–å‚™ä¸­</button>
          <button onclick="filterOrders('completed')" class="px-4 py-2 bg-green-200 rounded hover:bg-green-300">å·²å®Œæˆ</button>
        </div>
        <div id="ordersList" class="space-y-4">
          <p class="text-center text-gray-500">è¼‰å…¥ä¸­...</p>
        </div>
      </div>
    </div>

    <div id="statsTab" class="tab-content hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Summary Cards -->
        <div class="bg-white p-6 rounded-xl shadow-md">
          <h3 class="text-lg font-bold text-gray-700 mb-4">ğŸ’° ä»Šæ—¥ç‡Ÿæ”¶</h3>
          <p id="todayRevenue" class="text-3xl font-bold text-green-600">$0</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md">
          <h3 class="text-lg font-bold text-gray-700 mb-4">ğŸ§¾ ä»Šæ—¥è¨‚å–®æ•¸</h3>
          <p id="todayOrders" class="text-3xl font-bold text-blue-600">0</p>
        </div>
      </div>

      <!-- Chart -->
      <div class="mt-6 bg-white p-6 rounded-xl shadow-md">
        <h3 class="text-lg font-bold text-gray-700 mb-4">ğŸ“Š è¿‘7å¤©ç‡Ÿæ”¶è¶¨å‹¢</h3>
        <canvas id="revenueChart"></canvas>
      </div>

      <!-- Top Items -->
      <div class="mt-6 bg-white p-6 rounded-xl shadow-md">
        <h3 class="text-lg font-bold text-gray-700 mb-4">ğŸ”¥ ç†±é–€å•†å“æ’è¡Œ</h3>
        <div id="topItems" class="space-y-2"></div>
      </div>
    </div>

  </div>

  <!-- Print Area (Hidden) -->
  <div id="printArea" class="hidden"></div>

  <script>
    const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyMokpZvcSC-EbZIWyDqmcG7I2glRXMXHnXMk_6a0uvyIg5ASwiJPXqyoASR2svE6Bp/exec';
    let allOrders = [];
    let currentFilter = 'pending';
    let revenueChart = null;

    // Tab Control
    function showTab(tab) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      document.getElementById(tab + 'Tab').classList.remove('hidden');
      if (tab === 'stats') loadStats();
    }

    // Filter Orders
    function filterOrders(status) {
      currentFilter = status;
      renderOrders();
    }

    // Fetch Orders
    async function fetchOrders() {
      try {
        const res = await fetch(API_ENDPOINT + '?action=getOrders');
        const data = await res.json();
        if (data.success) {
          allOrders = data.data || [];
          renderOrders();
          if (document.getElementById('statsTab').classList.contains('hidden') === false) {
            loadStats();
          }
        } else {
          alert('è¼‰å…¥è¨‚å–®å¤±æ•—ï¼š' + data.message);
        }
      } catch (err) {
        console.error(err);
        alert('é€£ç·šéŒ¯èª¤');
      }
    }

    // Render Orders
    function renderOrders() {
      const container = document.getElementById('ordersList');
      let filtered = allOrders;

      if (currentFilter !== 'all') {
        filtered = allOrders.filter(o => o.status === currentFilter);
      }

      if (filtered.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500">ç„¡è¨‚å–®</p>';
        return;
      }

      container.innerHTML = filtered.map(order => {
        const items = order.items.map(i => `${i.name} x${i.quantity}`).join('<br>');
        const statusClass = `status-${order.status} px-3 py-1 rounded-full text-xs font-bold border`;
        return `
          <div class="bg-white p-5 rounded-lg shadow border-l-4 ${order.status === 'pending' ? 'border-yellow-400' : 'border-gray-300'}">
            <div class="flex justify-between items-start mb-3">
              <div>
                <p class="font-bold text-lg">#${order.orderId}</p>
                <p class="text-sm text-gray-600">${new Date(order.timestamp).toLocaleString('zh-TW')}</p>
              </div>
              <span class="${statusClass}">${getStatusText(order.status)}</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <p><strong>é¡§å®¢ï¼š</strong>${order.customerName} (${order.customerPhone})</p>
                <p><strong>å–é¤æ™‚é–“ï¼š</strong>${new Date(order.pickupTime).toLocaleString('zh-TW')}</p>
                ${order.deliveryAddress ? `<p><strong>å¤–é€ï¼š</strong>${order.deliveryAddress} (+$30)</p>` : ''}
                ${order.notes ? `<p><strong>å‚™è¨»ï¼š</strong>${order.notes}</p>` : ''}
              </div>
              <div>
                <p class="font-bold mb-1">é¤é»ï¼š</p>
                <p class="text-xs leading-relaxed">${items}</p>
                <p class="mt-2 font-bold text-lg text-green-600">ç¸½é‡‘é¡ï¼š$${order.totalAmount}</p>
              </div>
            </div>
            <div class="mt-4 flex flex-wrap gap-2">
              ${order.status === 'pending' ? `<button onclick="updateStatus('${order.orderId}', 'confirmed')" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">ç¢ºèªè¨‚å–®</button>` : ''}
              ${['pending', 'confirmed'].includes(order.status) ? `<button onclick="updateStatus('${order.orderId}', 'ready')" class="px-3 py-1 bg-purple-500 text-white rounded text-sm hover:bg-purple-600">æº–å‚™ä¸­</button>` : ''}
              ${['ready', 'confirmed'].includes(order.status) ? `<button onclick="updateStatus('${order.orderId}', 'completed')" class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600">å®Œæˆå–é¤</button>` : ''}
              ${!['completed', 'cancelled'].includes(order.status) ? `<button onclick="updateStatus('${order.orderId}', 'cancelled')" class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">å–æ¶ˆ</button>` : ''}
              <button onclick="printOrder('${order.orderId}')" class="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700">ğŸ–¨ï¸ åˆ—å°</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function getStatusText(status) {
      const map = { pending: 'å¾…ç¢ºèª', confirmed: 'å·²ç¢ºèª', ready: 'æº–å‚™ä¸­', completed: 'å·²å®Œæˆ', cancelled: 'å·²å–æ¶ˆ' };
      return map[status] || status;
    }

    // Update Order Status
    async function updateStatus(orderId, newStatus) {
      if (!confirm(`ç¢ºå®šè¦å°‡è¨‚å–® #${orderId} è®Šæ›´ç‚ºã€Œ${getStatusText(newStatus)}ã€ï¼Ÿ`)) return;

      try {
        const res = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action: 'updateStatus', orderId, status: newStatus })
        });
        const data = await res.json();
        if (data.success) {
          fetchOrders();
          alert('ç‹€æ…‹æ›´æ–°æˆåŠŸï¼');
        } else {
          alert('æ›´æ–°å¤±æ•—ï¼š' + data.message);
        }
      } catch (err) {
        alert('é€£ç·šéŒ¯èª¤');
      }
    }

    // Print Order
    function printOrder(orderId) {
      const order = allOrders.find(o => o.orderId === orderId);
      if (!order) return;

      const items = order.items.map(i => `${i.icon} ${i.name} x${i.quantity}   $${i.price * i.quantity}`).join('\n');
      const printContent = `
        <div style="font-family: monospace; width: 80mm; padding: 10px;">
          <h2 style="text-align: center; font-size: 16px;">å°ç£å°åƒåº—</h2>
          <p style="text-align: center; font-size: 12px;">è¨‚å–®ç·¨è™Ÿ: #${order.orderId}</p>
          <p style="text-align: center; font-size: 12px;">${new Date(order.timestamp).toLocaleString('zh-TW')}</p>
          <hr>
          <p><strong>é¡§å®¢ï¼š</strong>${order.customerName}</p>
          <p><strong>é›»è©±ï¼š</strong>${order.customerPhone}</p>
          <p><strong>å–é¤ï¼š</strong>${new Date(order.pickupTime).toLocaleString('zh-TW')}</p>
          ${order.deliveryAddress ? `<p><strong>å¤–é€ï¼š</strong>${order.deliveryAddress}</p>` : ''}
          <hr>
          <pre style="font-size: 12px; white-space: pre-wrap;">${items}</pre>
          <hr>
          <p style="text-align: right;"><strong>é¤é»åˆè¨ˆ: $${order.totalAmount - (order.deliveryAddress ? 30 : 0)}</strong></p>
          ${order.deliveryAddress ? `<p style="text-align: right;"><strong>å¤–é€è²»: $30</strong></p>` : ''}
          <p style="text-align: right; font-size: 16px;"><strong>ç¸½è¨ˆ: $${order.totalAmount}</strong></p>
          ${order.notes ? `<hr><p style="font-size: 11px;"><strong>å‚™è¨»ï¼š</strong>${order.notes}</p>` : ''}
          <p style="text-align: center; margin-top: 20px; font-size: 10px;">æ„Ÿè¬æ‚¨çš„å…‰è‡¨ï¼</p>
        </div>
      `;

      const printArea = document.getElementById('printArea');
      printArea.innerHTML = printContent;
      window.print();
      printArea.innerHTML = '';
    }

    // Load Statistics
    async function loadStats() {
      const today = new Date().toISOString().split('T')[0];
      const sevenDaysAgo = new Date(Date.now() - 6*24*60*60*1000).toISOString().split('T')[0];

      const todayOrders = allOrders.filter(o => 
        o.timestamp.startsWith(today) && o.status === 'completed'
      );
      const recentOrders = allOrders.filter(o => 
        o.timestamp >= sevenDaysAgo + 'T00:00:00' && o.status === 'completed'
      );

      // Today Summary
      const todayRevenue = todayOrders.reduce((sum, o) => sum + o.totalAmount, 0);
      document.getElementById('todayRevenue').textContent = `$${todayRevenue}`;
      document.getElementById('todayOrders').textContent = todayOrders.length;

      // Revenue Chart
      const dates = {};
      for (let d = new Date(sevenDaysAgo); d <= new Date(); d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        dates[dateStr] = 0;
      }
      recentOrders.forEach(o => {
        const date = o.timestamp.split('T')[0];
        dates[date] = (dates[date] || 0) + o.totalAmount;
      });

      const labels = Object.keys(dates);
      const data = Object.values(dates);

      if (revenueChart) revenueChart.destroy();
      const ctx = document.getElementById('revenueChart').getContext('2d');
      revenueChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.map(l => l.slice(5).replace('-', '/')),
          datasets: [{
            label: 'ç‡Ÿæ”¶ (å…ƒ)',
            data: data,
            borderColor: 'rgb(34, 197, 94)',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.3,
            fill: true
          }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });

      // Top Items
      const itemCount = {};
      recentOrders.forEach(o => {
        o.items.forEach(i => {
          itemCount[i.name] = (itemCount[i.name] || 0) + i.quantity;
        });
      });
      const topItems = Object.entries(itemCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      document.getElementById('topItems').innerHTML = topItems.map(([name, qty], i) => `
        <div class="flex justify-between items-center py-2 border-b ${i === 0 ? 'font-bold text-green-600' : ''}">
          <span>${i+1}. ${name}</span>
          <span class="bg-gray-200 px-3 py-1 rounded-full text-sm">${qty} ä»½</span>
        </div>
      `).join('') || '<p class="text-gray-500">ç„¡è³‡æ–™</p>';
    }

    // Auto Refresh
    setInterval(fetchOrders, 30000); // æ¯30ç§’æ›´æ–°

    // Init
    window.onload = () => {
      fetchOrders();
      showTab('orders');
    };
  </script>
</body>
</html>
