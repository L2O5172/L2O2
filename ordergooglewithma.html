<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>無名牛排點餐系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            .print-area * {
                color: #000 !important;
                background-color: transparent !important;
                box-shadow: none !important;
                border-color: #ddd !important;
            }
            .no-print {
                display: none !important;
            }
        }
        /* For custom bar chart tooltip */
        .group:hover .group-hover\:opacity-100 {
            opacity: 1;
        }
        .text-xxs {
            font-size: 0.65rem;
            line-height: 0.85rem;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.28.0"
  }
}
</script>
</head>
<body class="bg-slate-100">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI } from "@google/genai";

// START OF components/icons.tsx
const PlusIcon = ({ className = "h-5 w-5" }) => (
  <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
  </svg>
);

const MinusIcon = ({ className = "h-5 w-5" }) => (
  <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 12H6" />
  </svg>
);

const TrashIcon = ({ className = "h-5 w-5" }) => (
  <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
  </svg>
);

const CloseIcon = ({ className = "h-6 w-6" }) => (
  <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
  </svg>
);

const CartIcon = ({ className = "h-6 w-6" }) => (
  <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m-6 4a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
  </svg>
);

const CheckIcon = ({ className = "h-6 w-6" }) => (
  <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
  </svg>
);

const SearchIcon = ({ className = "h-5 w-5" }) => (
    <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
    </svg>
);

const RefreshIcon = ({ className = "h-5 w-5" }) => (
    <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
    </svg>
);

const PencilIcon = ({ className = "h-5 w-5" }) => (
    <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" />
    </svg>
);

const SparklesIcon = ({ className = "h-6 w-6" }) => (
    <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.455-2.456L12.75 18l1.178-.398a3.375 3.375 0 002.455-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.25 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" />
    </svg>
);

const SendIcon = ({ className = "h-5 w-5" }) => (
    <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
    </svg>
);
// END OF components/icons.tsx

// START OF constants.ts
const MENU_DATA = [
  {
    title: "簡餐",
    items: [
        { id: 'new-nuggets-single', name: '黃金脆皮炸雞塊', price: 75, description: "單點。可於下方選擇加購。", customizations: { notes: true, sauceChoice: true, saucesPerItem: 1 }, isAvailable: true },
        { id: 'new-nuggets-set', name: '雞塊套餐', price: 175, description: "附: 湯品, 飲料, 脆薯, 甜品", customizations: { notes: true, sauceChoice: true, saucesPerItem: 1, drinkChoice: true }, isAvailable: true },
        { id: 'new-peanut-burger-single', name: '波士頓花生冰淇淋吃到堡', price: 75, description: "單點。可於下方選擇加購。", customizations: { notes: true }, isAvailable: true },
        { id: 'new-peanut-burger-set', name: '花生冰淇淋吃到堡套餐', price: 175, description: "附: 湯品, 飲料, 脆薯, 雞塊", customizations: { notes: true, drinkChoice: true }, isAvailable: true },
        { id: 'new-eggsalad-burger-single', name: '蛋沙拉脆皮雞塊吃到堡', price: 75, description: "單點。可於下方選擇加購。", customizations: { notes: true }, isAvailable: true },
        { id: 'new-eggsalad-burger-set', name: '蛋沙拉脆皮雞塊吃到堡套餐', price: 175, description: "附: 湯品, 飲料, 脆薯, 甜品", customizations: { notes: true, drinkChoice: true }, isAvailable: true },
        { id: 'new-kimchi-burger-single', name: '黃金泡菜脆皮雞塊吃到堡', price: 75, description: "單點。可於下方選擇加購。", customizations: { notes: true }, isAvailable: true },
        { id: 'new-kimchi-burger-set', name: '黃金泡菜脆皮雞塊吃到堡套餐', price: 175, description: "附: 湯品, 飲料, 脆薯, 甜品", customizations: { notes: true, drinkChoice: true }, isAvailable: true },
        { id: 'new-waldorf-burger-single', name: '華道夫蘋果沙拉雞塊吃到堡', price: 75, description: "單點。可於下方選擇加購。", customizations: { notes: true }, isAvailable: true },
        { id: 'new-waldorf-burger-set', name: '華道夫蘋果沙拉雞塊吃到堡套餐', price: 175, description: "附: 湯品, 飲料, 脆薯, 甜品", customizations: { notes: true, drinkChoice: true }, isAvailable: true },
        { id: 'new-cold-noodle-single', name: '是日涼麵', price: 75, description: "單點。可於下方選擇加購。", customizations: { multiChoice: { title: '涼麵口味', options: ['台式', '泰式', '日式', '法式'] }, notes: true }, isAvailable: true },
        { id: 'new-cold-noodle-set', name: '涼麵套餐', price: 175, description: "附: 湯品, 飲料, 脆薯, 雞塊", customizations: { multiChoice: { title: '涼麵口味', options: ['台式', '泰式', '日式', '法式'] }, drinkChoice: true, notes: true }, isAvailable: true },
        { id: 'new-chicken-porridge-drink', name: '脆皮炸雞塊+粥品+飲料', description: "超值組合", price: 99, customizations: { drinkChoice: true, notes: true, sauceChoice: true, saucesPerItem: 1 }, isAvailable: true },
    ]
  },
  {
    title: "甜品",
    items: [
        { id: 'new-dessert-choice-single', name: '任選甜品', price: 99, description: "A、B區各任選一種。可於下方選擇加購。", customizations: { dessertChoice: true, notes: true }, isAvailable: true },
        { id: 'new-dessert-choice-set', name: '任選甜品套餐', price: 199, description: "附: 湯品, 飲料, 脆薯, 雞塊", customizations: { dessertChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
    ]
  },
  {
    title: "套餐",
    items: [
      { id: 'set-1', name: '香煎海盜牛排套餐', weight: '7oz', price: 299, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤飲料", customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      { id: 'set-2', name: '香煎海盜牛排套餐', weight: '14oz', price: 399, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤飲料", customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      { id: 'set-3', name: '香煎海盜牛排套餐', weight: '21oz', price: 499, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤飲料", customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      { id: 'set-4', name: '香煎特選板腱套餐', weight: '10oz', price: 399, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤飲料", customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      { id: 'set-5', name: '香煎老饕上蓋套餐', weight: '7oz', price: 399, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤飲料", customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      { id: 'set-6', name: '香煎紐菲力套餐', weight: '7oz', price: 499, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤飲料", customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      { id: 'set-7', name: '香煎櫻桃鴨胸套餐', weight: '10oz', price: 320, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤飲料", customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      { id: 'set-8', name: '香煎鮮嫩鱸魚套餐', weight: '10oz', price: 320, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤飲料", customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      { id: 'set-9', name: '香煎鮮嫩雞腿套餐', weight: '10oz', price: 250, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤飲料", customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      { id: 'set-10', name: '香煎美味豬排套餐', weight: '10oz', price: 299, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤飲料", customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      { id: 'set-11', name: '英式炸魚套餐', weight: '10oz', price: 250, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤飲料", customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      { id: 'set-12', name: '日式豬排套餐', weight: '10oz', price: 250, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤飲料", customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: false },
    ]
  },
  {
    title: "組合餐",
    items: [
      { id: 'combo-1', name: '日豬、雞腿、上蓋組合餐', weight: '15oz', price: 529, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤沙拉 ⑥飲料", customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      { id: 'combo-2', name: '炸魚、雞腿、板腱組合餐', weight: '15oz', price: 529, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤沙拉 ⑥飲料", customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      { id: 'combo-3', name: '鱸魚、鴨胸、豬排組合餐', weight: '15oz', price: 529, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤沙拉 ⑥飲料", customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      { id: 'combo-4', name: '鴨胸、鱸魚、上蓋組合餐', weight: '15oz', price: 599, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤沙拉 ⑥飲料", customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      { id: 'combo-5', name: 'N菲、上蓋、板腱組合餐', weight: '15oz', price: 699, description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤沙拉 ⑥飲料", customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      { id: 'new-chicken-pasta-single', name: '黃金脆皮炸雞塊+是日義大利天使麵', price: 140, description: "單點", customizations: { notes: true, sauceChoice: true, saucesPerItem: 1 }, isAvailable: true },
      { id: 'new-chicken-pasta-set', name: '黃金脆皮炸雞塊+是日義大利天使麵套餐', price: 220, description: "附: 湯品, 飲料", customizations: { drinkChoice: true, notes: true, sauceChoice: true, saucesPerItem: 1 }, isAvailable: true },
    ]
  }
];

const ADDONS = [
    { id: 'addon-top-blade-5oz', name: '板腱加購 5oz', price: 200, category: '主餐加購', isAvailable: true },
    { id: 'addon-ribeye-cap-5oz', name: '上蓋加購 5oz', price: 200, category: '主餐加購', isAvailable: true },
    { id: 'addon-duck-breast-5oz', name: '鴨胸加購 5oz', price: 150, category: '主餐加購', isAvailable: true },
    { id: 'addon-sea-bass-5oz', name: '鱸魚加購 5oz', price: 150, category: '主餐加購', isAvailable: true },
    { id: 'addon-chicken-leg-5oz', name: '雞腿加購 5oz', price: 120, category: '主餐加購', isAvailable: true },
    { id: 'addon-pork-chop-5oz', name: '豬排加購 5oz', price: 120, category: '主餐加購', isAvailable: true },
    { id: 'addon-jp-pork-cutlet-5oz', name: '日豬加購 5oz', price: 120, category: '主餐加購', isAvailable: true },
    { id: 'addon-fried-fish-5oz', name: '炸魚加購 5oz', price: 120, category: '主餐加購', isAvailable: true },
    { id: 'addon-soup', name: '湯品 加購', price: 30, category: '單點加購', isAvailable: true },
    { id: 'addon-congee', name: '粥品 加購', price: 40, category: '單點加購', isAvailable: true },
    { id: 'addon-fries', name: '脆薯 加購', price: 40, category: '單點加購', isAvailable: true },
    { id: 'addon-dessert-side', name: '甜品 加購', price: 40, category: '單點加購', isAvailable: true },
    { id: 'addon-drink-side', name: '飲料 加購', price: 20, category: '單點加購', isAvailable: true },
    { id: 'addon-nuggets-side', name: '雞塊 加購', price: 45, category: '單點加購', isAvailable: true },
];

const DONENESS_LEVELS = ['3分熟', '5分熟', '7分熟', '全熟'];
const SAUCE_CHOICES = ["巴醋", "橙汁", "椒鹽", "芥末", "泡菜", "BBQ醬", "黑胡椒", "蒜味醬"];
const DRINK_CHOICES = ["無糖紅茶", "冰涼可樂"];

// New dessert choices
const DESSERT_CHOICES = ["蜜糖潛艇堡", "美式鬆餅", "格子鬆餅", "法式鬆餅", "蜜糖吐司"];
const ICECREAM_CHOICES = ["法式烤布蕾佐冰淇淋", "阿薩斯蘋果佐冰淇淋", "烤蜜糖香蕉佐冰淇淋", "融岩巧克力佐冰淇淋", "醇巧克力暮司佐冰淇", "烤法焦糖布丁佐冰淇", "宜蘭鮮乳奶凍佐冰淇", "宇治紫米紅豆冰淇淋"];
// END OF constants.ts

// START OF services/apiService.ts
// --- IMPORTANT ---
// It is a professional best practice to store this URL in an environment variable on your hosting platform (like Vercel).
// This makes it easy to switch between different backends (e.g., a test version and a live version) without changing the code.
// Unlike an API key, this URL is visible to users in their browser's network requests, so an environment variable provides
// flexibility and better management rather than absolute security for the URL itself.
const API_URL = 'https://script.google.com/macros/s/AKfycbxiZ4gI7Vd1ikaC1e1ijOW3YWQTtaUSQelFuh20FTOLtvXsPU6o_c07GZ7FaFA07_Y/exec'; 

const apiService = {
  async getMenuAndAddons() {
    try {
      const response = await fetch(`${API_URL}?action=getMenu`);
      if (!response.ok) throw new Error('Network response was not ok');
      const data = await response.json();
      if (!data.menu || !data.addons) throw new Error('Invalid data structure from API');
      return { ...data, from: 'api' };
    } catch (error) {
      console.warn("API fetch failed, using fallback.", error);
      return { menu: MENU_DATA, addons: ADDONS, from: 'fallback' };
    }
  },

  async submitOrder(orderData) {
    try {
      const payload = {
        action: 'createOrder',
        orderData: {
            ...orderData,
            // Ensure items are stringified for Google Apps Script to handle
            items: JSON.stringify(orderData.items)
        },
      };

      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload),
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Server responded with ${response.status}: ${errorText}`);
      }

      const result = await response.json();
      return result;
      
    } catch (error) {
      console.error("Failed to submit order:", error);
      const message = error instanceof Error ? error.message : 'An unknown error occurred during order submission.';
      throw new Error(message);
    }
  },

  async getOrder(orderId) {
    try {
      const response = await fetch(`${API_URL}?action=getOrder&orderId=${orderId}`);
      if (!response.ok) throw new Error('Network response was not ok');
      return await response.json();
    } catch (error) {
      console.error(`Failed to get order ${orderId}:`, error);
      const message = error instanceof Error ? error.message : "An unknown error occurred.";
      return { success: false, message };
    }
  },
  
  async searchOrders(params) {
    try {
        const query = new URLSearchParams({ action: 'searchOrders' });
        if (params.name) query.append('name', params.name);
        if (params.phone) query.append('phone', params.phone);
        if (params.startDate) query.append('startDate', params.startDate);
        if (params.endDate) query.append('endDate', params.endDate);
        
        const response = await fetch(`${API_URL}?${query.toString()}`);
        if (!response.ok) throw new Error('Network response was not ok');
        return await response.json();
    } catch (error) {
        console.error("Failed to search orders:", error);
        const message = error instanceof Error ? error.message : "An unknown error occurred.";
        return { success: false, message };
    }
  },
  
  // --- New functions for Admin Dashboard ---

  async getAllOrders() {
    try {
      const response = await fetch(`${API_URL}?action=getAllOrders`);
      if (!response.ok) throw new Error('Network response was not ok');
      return await response.json();
    } catch (error) {
      console.error("Failed to get all orders:", error);
      const message = error instanceof Error ? error.message : "An unknown error occurred.";
      return { success: false, message };
    }
  },

  async updateOrderStatus(orderId, status) {
    try {
      const payload = { action: 'updateOrderStatus', orderId, status };
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload),
      });
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Server responded with ${response.status}: ${errorText}`);
      }
      return await response.json();
    } catch (error) {
      console.error(`Failed to update status for order ${orderId}:`, error);
      const message = error instanceof Error ? error.message : "An unknown error occurred.";
      return { success: false, message };
    }
  },

  async getSalesStatistics(startDate, endDate) {
    try {
      const query = new URLSearchParams({ action: 'getSalesStatistics', startDate, endDate });
      const response = await fetch(`${API_URL}?${query.toString()}`);
      if (!response.ok) throw new Error('Network response was not ok');
      return await response.json();
    } catch (error) {
      console.error("Failed to get sales statistics:", error);
      const message = error instanceof Error ? error.message : "An unknown error occurred.";
      return { success: false, message };
    }
  }
};
// END OF services/apiService.ts

// START OF components/PrintableOrder.tsx
const renderPrintableOrderItem = (item) => (
    <li key={item.cartId} className="mb-2 text-left">
        <p className="font-semibold">{item.item.name} (${item.item.price}) x{item.quantity}</p>
        <div className="text-xs text-slate-500 pl-2 mt-1 space-y-0.5">
            {item.selectedDonenesses && Object.keys(item.selectedDonenesses).length > 0 && <p>熟度: {Object.entries(item.selectedDonenesses).map(([d, q]) => `${d}x${q}`).join(', ')}</p>}
            {item.selectedMultiChoice && Object.keys(item.selectedMultiChoice).length > 0 && <p>口味: {Object.entries(item.selectedMultiChoice).map(([d, q]) => `${d}x${q}`).join(', ')}</p>}
            {item.selectedDrinks && Object.keys(item.selectedDrinks).length > 0 && <p>飲料: {Object.entries(item.selectedDrinks).map(([d, q]) => `${d}x${q}`).join(', ')}</p>}
            {item.selectedSauces && item.selectedSauces.length > 0 && <p>醬料: {item.selectedSauces.map(s => `${s.name}x${s.quantity}`).join(', ')}</p>}
            {item.selectedDesserts && item.selectedDesserts.length > 0 && <p>甜品: {item.selectedDesserts.map(d => `${d.name}x${d.quantity}`).join(', ')}</p>}
            {item.selectedSingleChoiceAddon && <p>單點加購: {item.selectedSingleChoiceAddon}</p>}
            {item.selectedAddons && item.selectedAddons.length > 0 && <p>其他加購: {item.selectedAddons.map(a => `${a.name} ($${a.price}) x${a.quantity}`).join(', ')}</p>}
            {item.selectedNotes && <p>備註: {item.selectedNotes}</p>}
        </div>
    </li>
);


const PrintableOrder = ({ order, orderId }) => {
    if (!order) {
        return null; // Safety check to prevent crashing if order data is missing.
    }
    
    const finalOrderId = 'id' in order ? order.id : orderId;
    
    return (
        <div className="p-4 bg-white">
            <h3 className="text-lg font-bold text-center mb-2">訂單摘要</h3>
            {finalOrderId && <p><strong>訂單號:</strong> {finalOrderId}</p>}
            <p><strong>顧客:</strong> {order.customerInfo.name} ({order.customerInfo.phone})</p>
            <p><strong>類型:</strong> {order.orderType} {order.customerInfo.tableNumber && `(${order.customerInfo.tableNumber}桌)`}</p>
            <hr className="my-2" />
            <ul className="text-sm">
                {order.items.map(renderPrintableOrderItem)}
            </ul>
            <hr className="my-2" />
            <p className="text-right font-bold text-lg">總計: ${order.totalPrice}</p>
        </div>
    );
};
// END OF components/PrintableOrder.tsx

// START OF components/ConfirmationModal.tsx
const ConfirmationModal = ({ isOpen, onClose, orderId, lastSuccessfulOrder, onPrintRequest }) => {

  if (!isOpen) return null;

  const handleLineShare = () => {
    if (!orderId) return;
    const text = `您好，我已送出訂單，訂單編號為【${orderId}】，請您盡快確認，謝謝！`;
    const url = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
    window.open(url, '_blank');
  };
  
  const handlePrint = () => {
      if (lastSuccessfulOrder) {
          onPrintRequest(<PrintableOrder order={lastSuccessfulOrder} orderId={orderId} />);
      }
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" onClick={onClose}>
      <div className="bg-white rounded-lg shadow-2xl w-full max-w-sm" onClick={e => e.stopPropagation()}>
        <div className="p-6 text-center">
            <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4 mx-auto">
                <CheckIcon className="h-8 w-8 text-green-600" />
            </div>
            <h2 className="text-2xl font-bold text-slate-800">訂單請求已送出</h2>
            <p className="text-slate-600 mt-2">您的訂單編號為：</p>
            <p className="font-mono text-2xl font-bold text-slate-800 my-2 bg-slate-100 py-2 rounded-md">{orderId}</p>
            
            <div className="text-sm bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-lg p-3 mt-4">
                <p><strong>重要提示：</strong></p>
                <p className="mt-1">此訂單需由店家回覆確認後才算正式成立。請點擊下方按鈕，透過 LINE 分享您的訂單編號以完成訂購程序。</p>
            </div>
        </div>
        <footer className="px-6 pb-6 space-y-2">
            <button 
                onClick={handleLineShare} 
                className="w-full bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 font-bold text-lg"
            >
                LINE 分享提醒
            </button>
            <div className="grid grid-cols-2 gap-2">
              <button 
                  onClick={handlePrint} 
                  disabled={!lastSuccessfulOrder}
                  className="w-full bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-lg hover:bg-slate-300 transition-colors disabled:opacity-50"
              >
                  列印訂單摘要
              </button>
              <button 
                  onClick={onClose} 
                  className="w-full bg-slate-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700 transition-colors"
              >
                  關閉
              </button>
            </div>
        </footer>
      </div>
    </div>
  );
};
// END OF components/ConfirmationModal.tsx

// START OF components/AIAssistantModal.tsx
// Simple Markdown-to-HTML renderer
const SimpleMarkdown = React.memo(({ text }) => {
    const formattedText = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
        .replace(/\*(.*?)\*/g, '<em>$1</em>')     // Italic
        .replace(/`([^`]+)`/g, '<code class="bg-slate-200 text-slate-800 rounded px-1 py-0.5 font-mono text-sm">$1</code>') // Inline code
        .replace(/^- (.*$)/gm, '<li class="ml-4 list-disc">$1</li>') // List items
        .replace(/(\<li.*\>.*<\/li\>)/gs, '<ul>$1</ul>') // Wrap lists in ul
        .replace(/\n/g, '<br />'); // Newlines

    return <div className="prose prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: formattedText }} />;
});

const AIAssistantModal = ({ isOpen, onClose, menuData, addons }) => {
    const [messages, setMessages] = useState([
        { role: 'model', content: '您好！我是您的點餐小幫手，請問有什麼可以為您服務的嗎？\n\n您可以問我像是：\n- *今天有什麼推薦的嗎?*\n- *14oz 的海盜牛排多少錢?*\n- *哪些餐點不含牛肉?*' }
    ]);
    const [userInput, setUserInput] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(null);
    const messagesEndRef = useRef(null);
    const aiRef = useRef(null);
    const [isAiDisabled, setIsAiDisabled] = useState(false);

    useEffect(() => {
        // On mount when the modal is first opened, check if AI can be used.
        // This determines the initial UI state without trying to initialize the SDK.
        if (isOpen && !process.env.API_KEY) {
            setIsAiDisabled(true);
        }
    }, [isOpen]);


    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    };

    useEffect(() => {
        scrollToBottom();
    }, [messages, isLoading]);
    
    // Defer AI SDK initialization until it's actually needed.
    // This is the key fix to prevent startup crashes.
    const getAiInstance = () => {
        if (aiRef.current) return aiRef.current;
        if (isAiDisabled) return null;

        const apiKey = process.env.API_KEY;
        if (!apiKey) {
            console.warn("Google GenAI API Key is not configured. AI Assistant will be disabled.");
            setIsAiDisabled(true);
            return null;
        }

        try {
            const instance = new GoogleGenAI({ apiKey });
            aiRef.current = instance;
            return instance;
        } catch (e) {
            console.error("Failed to initialize GoogleGenAI:", e);
            setError("AI 小幫手初始化失敗。");
            setIsAiDisabled(true);
            return null;
        }
    };
    
    const menuContext = React.useMemo(() => {
        const simplifiedMenu = menuData.map(category => ({
            ...category,
            items: category.items.map(({ id, name, weight, price, isAvailable }) => ({ id, name, weight, price, isAvailable }))
        }));
        const simplifiedAddons = addons.map(({ id, name, price, category, isAvailable }) => ({ id, name, price, category, isAvailable }));
        return `這是餐廳的菜單資料 (JSON格式):\n\n菜單: ${JSON.stringify(simplifiedMenu)}\n\n加購項目: ${JSON.stringify(simplifiedAddons)}`;
    }, [menuData, addons]);

    const handleSendMessage = useCallback(async (e) => {
        e.preventDefault();
        const trimmedInput = userInput.trim();
        if (!trimmedInput || isLoading || isAiDisabled) return;

        setError(null);
        const newUserMessage = { role: 'user', content: trimmedInput };
        setMessages(prev => [...prev, newUserMessage]);
        setUserInput('');
        setIsLoading(true);
        
        const ai = getAiInstance();

        if (!ai) {
            const errorMessage = "AI 小幫手目前無法使用，請確認 API 金鑰是否已正確設定。";
            setError(errorMessage);
            setMessages(prev => [...prev, { role: 'model', content: errorMessage }]);
            setIsLoading(false);
            return;
        }

        try {
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: trimmedInput,
                config: {
                    systemInstruction: `你是一位專業且友善的「無名牛排」點餐小幫手。你的任務是根據我提供的菜單JSON資料，回答顧客的問題。請務必只使用提供的菜單資料來回答，不要杜撰任何菜單上沒有的品項、價格或資訊。如果顧客詢問有關售罄 (isAvailable: false) 的商品，請告知他們該商品目前無法提供。回答時請使用繁體中文，語氣親切有禮，並盡量用條列式或重點式的方式清楚呈現，讓顧客一目了然。\n\n${menuContext}`,
                },
            });

            const aiResponse = { role: 'model', content: response.text };
            setMessages(prev => [...prev, aiResponse]);
        } catch (err) {
            console.error("Gemini API call failed:", err);
            const errorMessage = "抱歉，我現在無法回答問題，請稍後再試。";
            setError(errorMessage);
            setMessages(prev => [...prev, { role: 'model', content: errorMessage }]);
        } finally {
            setIsLoading(false);
        }
    }, [userInput, isLoading, menuContext, isAiDisabled]);
    
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" onClick={onClose}>
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl h-full max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                <header className="p-4 flex justify-between items-center border-b bg-slate-50 rounded-t-2xl">
                    <div className="flex items-center gap-3">
                        <SparklesIcon className="h-6 w-6 text-blue-600" />
                        <h2 className="text-xl font-bold text-slate-800">AI 小幫手</h2>
                    </div>
                    <button onClick={onClose} className="text-slate-400 hover:text-slate-800"><CloseIcon /></button>
                </header>
                
                <main className="flex-1 p-4 overflow-y-auto bg-slate-100 space-y-4">
                    {messages.map((msg, index) => (
                        <div key={index} className={`flex items-end gap-2 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                            {msg.role === 'model' && <div className="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white"><SparklesIcon className="w-5 h-5"/></div>}
                            <div className={`max-w-md lg:max-w-lg px-4 py-3 rounded-2xl ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white text-slate-800 rounded-bl-none shadow-sm'}`}>
                                <SimpleMarkdown text={msg.content} />
                            </div>
                        </div>
                    ))}
                    {isLoading && (
                        <div className="flex items-end gap-2 justify-start">
                            <div className="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white"><SparklesIcon className="w-5 h-5"/></div>
                            <div className="max-w-md lg:max-w-lg px-4 py-3 rounded-2xl bg-white text-slate-800 rounded-bl-none shadow-sm flex items-center gap-2">
                                <div className="h-2 w-2 bg-slate-400 rounded-full animate-bounce [animation-delay:-0.3s]"></div>
                                <div className="h-2 w-2 bg-slate-400 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                                <div className="h-2 w-2 bg-slate-400 rounded-full animate-bounce"></div>
                            </div>
                        </div>
                    )}
                    {error && <p className="text-red-500 text-center text-sm">{error}</p>}
                    <div ref={messagesEndRef} />
                </main>

                <footer className="p-4 border-t bg-white rounded-b-2xl">
                    <form onSubmit={handleSendMessage} className="flex items-center gap-2">
                        <input
                            type="text"
                            value={userInput}
                            onChange={(e) => setUserInput(e.target.value)}
                            placeholder={isAiDisabled ? "AI 小幫手目前無法使用" : "問我任何關於菜單的問題..."}
                            className="flex-grow p-3 border border-slate-300 rounded-full focus:ring-2 focus:ring-blue-500 outline-none disabled:bg-slate-100"
                            disabled={isLoading || isAiDisabled}
                        />
                        <button type="submit" disabled={isLoading || !userInput.trim() || isAiDisabled} className="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors">
                            <SendIcon className="h-6 w-6" />
                        </button>
                    </form>
                </footer>
            </div>
        </div>
    );
};
// END OF components/AIAssistantModal.tsx

// START OF components/AdminDashboard.tsx
const getStatusColor = (status) => {
    switch (status) {
        case '待店長確認': return 'bg-orange-100 text-orange-800 border-orange-300';
        case '待處理': return 'bg-yellow-100 text-yellow-800 border-yellow-300';
        case '製作中': return 'bg-blue-100 text-blue-800 border-blue-300';
        case '可以取餐': return 'bg-purple-100 text-purple-800 border-purple-300';
        case '已完成': return 'bg-green-100 text-green-800 border-green-300';
        default: return 'bg-red-100 text-red-800 border-red-300';
    }
};

const ORDER_STATUSES = ['待店長確認', '待處理', '製作中', '可以取餐', '已完成'];

const OrderDetailModal = ({ order, onClose }) => {
  const renderOrderItem = (item, index) => (
    <div key={item.cartId || index} className="py-2 border-b border-slate-200 last:border-b-0">
      <p className="font-semibold text-slate-800">{item.item.name.replace(/半全餐|半套餐/g, '套餐')} (${item.item.price}) <span className="font-normal">x{item.quantity}</span></p>
      <div className="text-xs text-slate-500 pl-2 mt-1 space-y-0.5">
        {item.selectedDonenesses && Object.keys(item.selectedDonenesses).length > 0 && <p>熟度: {Object.entries(item.selectedDonenesses).map(([d, q]) => `${d}x${q}`).join(', ')}</p>}
        {item.selectedMultiChoice && Object.keys(item.selectedMultiChoice).length > 0 && <p>口味: {Object.entries(item.selectedMultiChoice).map(([d, q]) => `${d}x${q}`).join(', ')}</p>}
        {item.selectedDrinks && Object.keys(item.selectedDrinks).length > 0 && <p>飲料: {Object.entries(item.selectedDrinks).map(([d, q]) => `${d}x${q}`).join(', ')}</p>}
        {item.selectedSauces && item.selectedSauces.length > 0 && <p>醬料: {item.selectedSauces.map(s => `${s.name}x${s.quantity}`).join(', ')}</p>}
        {item.selectedDesserts && item.selectedDesserts.length > 0 && <p>甜品: {item.selectedDesserts.map(d => `${d.name}x${d.quantity}`).join(', ')}</p>}
        {item.selectedSingleChoiceAddon && <p>單點加購: {item.selectedSingleChoiceAddon}</p>}
        {item.selectedAddons && item.selectedAddons.length > 0 && <p>其他加購: {item.selectedAddons.map(a => `${a.name} ($${a.price}) x${a.quantity}`).join(', ')}</p>}
        {item.selectedNotes && <p>備註: {item.selectedNotes}</p>}
      </div>
    </div>
  );

  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 z-[60] flex justify-center items-center p-4" onClick={onClose}>
        <div className="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
            <header className="p-5 relative border-b">
                <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-800"><CloseIcon /></button>
                <h2 className="text-2xl font-bold text-slate-800">訂單內容</h2>
            </header>
            <main className="px-6 py-4 space-y-4 overflow-y-auto bg-slate-50">
                <div className="space-y-2 text-sm">
                    <div className="flex justify-between"><span className="text-slate-600">訂單編號:</span><span className="font-mono font-bold text-slate-800">{order.id}</span></div>
                    <div className="flex justify-between"><span className="text-slate-600">顧客:</span><span className="font-semibold">{order.customerInfo.name} ({order.customerInfo.phone})</span></div>
                    <div className="flex justify-between"><span className="text-slate-600">類型:</span><span className="font-semibold">{order.orderType}{order.orderType === '內用' && order.customerInfo.tableNumber ? ` (${order.customerInfo.tableNumber}桌)`: ''}</span></div>
                    <div className="flex justify-between"><span className="text-slate-600">狀態:</span><span className={`px-2 py-0.5 font-semibold leading-tight rounded-full text-xs ${getStatusColor(order.status)}`}>{order.status}</span></div>
                    <div className="flex justify-between"><span className="text-slate-600">時間:</span><span className="font-semibold">{new Date(order.createdAt).toLocaleString()}</span></div>
                </div>
                <div className="border-t border-slate-300 pt-3 mt-3">
                    <h4 className="text-base font-bold text-slate-700 mb-2">餐點內容</h4>
                    <div className="bg-white p-3 rounded-md border">
                        {order.items.map(renderOrderItem)}
                    </div>
                </div>
            </main>
            <footer className="p-5 border-t bg-white flex justify-between items-center">
                <p className="text-lg font-bold">總金額:</p>
                <p className="text-xl font-bold text-green-700">${order.totalPrice}</p>
            </footer>
        </div>
    </div>
  );
};


const OrderManagementView = ({ orders, onUpdateStatus, onPrintRequest, onViewOrder }) => {
    const [filter, setFilter] = useState('all');
    
    const statusCounts = useMemo(() => {
        const counts = orders.reduce((acc, order) => {
            acc[order.status] = (acc[order.status] || 0) + 1;
            return acc;
        }, {});

        const allStatuses = {
            all: orders.length,
            '待店長確認': counts['待店長確認'] || 0,
            '待處理': counts['待處理'] || 0,
            '製作中': counts['製作中'] || 0,
            '可以取餐': counts['可以取餐'] || 0,
            '已完成': counts['已完成'] || 0,
            '錯誤': counts['錯誤'] || 0,
        };
        return allStatuses;

    }, [orders]);

    const filteredOrders = useMemo(() => {
        if (filter === 'all') return orders;
        return orders.filter(o => o.status === filter);
    }, [orders, filter]);

    return (
        <div className="p-4 sm:p-6 space-y-4">
            <div className="flex flex-wrap gap-2 items-center">
                <button 
                    onClick={() => setFilter('all')} 
                    className={`flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-full transition-colors ${filter === 'all' ? 'bg-green-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                >
                    <span>全部</span>
                    <span className={`flex items-center justify-center text-xs font-bold rounded-full w-6 h-6 ${filter === 'all' ? 'bg-white text-green-700' : 'bg-slate-400 text-white'}`}>
                        {statusCounts.all}
                    </span>
                </button>
                {ORDER_STATUSES.map(status => (
                    <button 
                        key={status} 
                        onClick={() => setFilter(status)} 
                        className={`flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-full transition-colors ${filter === status ? 'bg-green-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                    >
                        <span>{status}</span>
                         <span className={`flex items-center justify-center text-xs font-bold rounded-full w-6 h-6 ${filter === status ? 'bg-white text-green-700' : 'bg-slate-400 text-white'}`}>
                            {statusCounts[status] || 0}
                        </span>
                    </button>
                ))}
            </div>
            <div className="bg-white rounded-lg shadow-md overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-slate-500">
                        <thead className="text-xs text-slate-700 uppercase bg-slate-100">
                            <tr>
                                <th scope="col" className="px-4 py-3">訂單號</th>
                                <th scope="col" className="px-4 py-3">顧客</th>
                                <th scope="col" className="px-4 py-3">金額</th>
                                <th scope="col" className="px-4 py-3">狀態</th>
                                <th scope="col" className="px-4 py-3">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredOrders.map(order => (
                                <tr key={order.id} className="bg-white border-b hover:bg-slate-50">
                                    <td className="px-4 py-4 font-mono font-semibold text-slate-900">
                                        <button onClick={() => onViewOrder(order)} className="text-blue-600 hover:underline focus:outline-none">
                                            {order.id}
                                        </button>
                                    </td>
                                    <td className="px-4 py-4">{order.customerInfo.name} ({order.customerInfo.phone})</td>
                                    <td className="px-4 py-4">${order.totalPrice}</td>
                                    <td className="px-4 py-4">
                                        <span className={`px-2 py-1 font-semibold leading-tight rounded-full text-xs ${getStatusColor(order.status)}`}>{order.status}</span>
                                    </td>
                                    <td className="px-4 py-4 flex flex-wrap gap-2">
                                        <select value={order.status} onChange={(e) => onUpdateStatus(order.id, e.target.value)} className="p-1 border rounded-md text-xs bg-white focus:ring-green-500 focus:border-green-500">
                                            {ORDER_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                                        </select>
                                        <button onClick={() => onPrintRequest(<PrintableOrder order={order} />)} className="text-xs bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600">列印</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
};

const SalesStatisticsView = () => {
    const [stats, setStats] = useState(null);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(null);
    const [dateRange, setDateRange] = useState({
        startDate: new Date(new Date().setDate(new Date().getDate() - 29)).toISOString().split('T')[0],
        endDate: new Date().toISOString().split('T')[0]
    });

    const fetchStats = useCallback(async () => {
        setIsLoading(true);
        setError(null);
        const result = await apiService.getSalesStatistics(dateRange.startDate, dateRange.endDate);
        if (result.success && result.stats) {
            setStats(result.stats);
        } else {
            setError(result.message || '無法載入統計資料');
        }
        setIsLoading(false);
    }, [dateRange]);
    
    useEffect(() => {
        fetchStats();
    }, [fetchStats]);

    const maxTrendRevenue = useMemo(() => stats ? Math.max(...stats.salesTrend.map(t => t.revenue), 0) : 0, [stats]);

    return (
        <div className="p-4 sm:p-6 space-y-6">
            <div className="flex flex-wrap items-center gap-4 p-4 bg-white rounded-lg shadow-sm">
                <input type="date" value={dateRange.startDate} onChange={e => setDateRange(p => ({...p, startDate: e.target.value}))} className="p-2 border rounded-md" />
                <span className="text-slate-600">到</span>
                <input type="date" value={dateRange.endDate} onChange={e => setDateRange(p => ({...p, endDate: e.target.value}))} className="p-2 border rounded-md" />
                <button onClick={fetchStats} disabled={isLoading} className="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 disabled:bg-slate-400">
                    {isLoading ? '載入中...' : '查詢'}
                </button>
            </div>

            {error && <p className="text-red-500 font-semibold">{error}</p>}
            
            {stats && (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    {/* KPIs */}
                    <div className="bg-white p-6 rounded-lg shadow-md"><h3 className="text-slate-500 text-sm font-medium">總營業額</h3><p className="text-3xl font-bold text-slate-800">${stats.totalRevenue.toLocaleString()}</p></div>
                    <div className="bg-white p-6 rounded-lg shadow-md"><h3 className="text-slate-500 text-sm font-medium">總訂單數</h3><p className="text-3xl font-bold text-slate-800">{stats.orderCount}</p></div>
                    <div className="bg-white p-6 rounded-lg shadow-md col-span-1 md:col-span-2">
                        <h3 className="font-semibold text-slate-800 mb-3">熱門商品排行</h3>
                        <ul className="space-y-2 text-sm">
                            {stats.popularItems.slice(0, 5).map(item => (
                                <li key={item.name} className="flex justify-between items-center"><span className="font-medium text-slate-700">{item.name}</span><span className="font-semibold text-green-700">{item.quantity} 份 / ${item.revenue.toLocaleString()}</span></li>
                            ))}
                        </ul>
                    </div>

                    {/* Sales Trend Chart */}
                    <div className="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-4">
                        <h3 className="font-semibold text-slate-800 mb-4">銷售趨勢</h3>
                        {maxTrendRevenue > 0 ? (
                        <div className="flex items-end h-64 gap-2 border-b border-l border-slate-200 p-2">
                           {stats.salesTrend.map(day => (
                               <div key={day.date} className="flex-1 flex flex-col items-center justify-end group" title={`${day.date}: $${day.revenue}`}>
                                   <div className="text-xs font-bold text-green-700 opacity-0 group-hover:opacity-100 transition-opacity">${day.revenue}</div>
                                   <div style={{ height: `${(day.revenue / maxTrendRevenue) * 100}%` }} className="w-full bg-green-500 hover:bg-green-600 rounded-t-sm transition-all"></div>
                                   <div className="text-xxs text-slate-500 mt-1 transform -rotate-45">{day.date.substring(5)}</div>
                               </div>
                           ))}
                        </div>
                        ) : <p className="text-slate-500 text-center py-10">此區間無銷售資料</p>}
                    </div>
                </div>
            )}
        </div>
    );
};


const AdminDashboard = ({ isOpen, onClose, onPrintRequest }) => {
    const [view, setView] = useState('orders');
    const [orders, setOrders] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);
    const [viewingOrder, setViewingOrder] = useState(null);

    const fetchData = useCallback(async () => {
        setIsLoading(true);
        setError(null);
        const result = await apiService.getAllOrders();
        if (result.success && result.orders) {
            setOrders(result.orders);
        } else {
            setError(result.message || '無法載入訂單');
        }
        setIsLoading(false);
    }, []);

    useEffect(() => {
        if (isOpen) {
            fetchData();
        }
    }, [isOpen, fetchData]);

    const handleUpdateStatus = async (id, status) => {
        const originalOrders = [...orders];
        setOrders(prev => prev.map(o => o.id === id ? {...o, status} : o));
        const result = await apiService.updateOrderStatus(id, status);
        if (!result.success) {
            alert(result.message || '更新失敗');
            setOrders(originalOrders);
        }
    };
    
    if (!isOpen) return null;

    return (
        <>
            <div className="fixed inset-0 bg-slate-800 bg-opacity-75 z-50">
                <div className="bg-slate-100 w-full h-full flex flex-col">
                    <header className="bg-white shadow-md flex-shrink-0">
                        <div className="container mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
                            <h2 className="text-xl font-bold text-slate-800">管理後台</h2>
                            <div className="flex items-center gap-4">
                                <div className="flex bg-slate-200 rounded-lg p-1">
                                    <button onClick={() => setView('orders')} className={`px-4 py-1.5 text-sm font-semibold rounded-md ${view === 'orders' ? 'bg-white shadow' : ''}`}>訂單管理</button>
                                    <button onClick={() => setView('stats')} className={`px-4 py-1.5 text-sm font-semibold rounded-md ${view === 'stats' ? 'bg-white shadow' : ''}`}>銷售統計</button>
                                </div>
                                <button onClick={onClose} className="text-slate-500 hover:text-slate-800"><CloseIcon /></button>
                            </div>
                        </div>
                    </header>
                    <main className="flex-grow overflow-y-auto">
                        {isLoading && <div className="p-8 text-center">載入中...</div>}
                        {error && <div className="p-8 text-center text-red-500">{error}</div>}
                        {!isLoading && !error && view === 'orders' && <OrderManagementView orders={orders} onUpdateStatus={handleUpdateStatus} onPrintRequest={onPrintRequest} onViewOrder={setViewingOrder} />}
                        {!isLoading && !error && view === 'stats' && <SalesStatisticsView />}
                    </main>
                </div>
            </div>
            {viewingOrder && <OrderDetailModal order={viewingOrder} onClose={() => setViewingOrder(null)} />}
        </>
    );
};
// END OF components/AdminDashboard.tsx

// START OF components/OrderQueryModal.tsx
const OrderQueryModal = ({ isOpen, onClose }) => {
  const [orderIdInput, setOrderIdInput] = useState('');
  const [searchResult, setSearchResult] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);
  const [recentOrders, setRecentOrders] = useState([]);
  
  // State for advanced search
  const [isAdvancedSearchOpen, setIsAdvancedSearchOpen] = useState(false);
  const [advSearchParams, setAdvSearchParams] = useState({ name: '', phone: '', startDate: '', endDate: '' });
  const [advSearchResults, setAdvSearchResults] = useState([]);
  const [isSearching, setIsSearching] = useState(false);

  const resetState = useCallback(() => {
    setOrderIdInput('');
    setSearchResult(null);
    setError(null);
    setIsLoading(false);
    setIsAdvancedSearchOpen(false);
    setAdvSearchParams({ name: '', phone: '', startDate: '', endDate: '' });
    setAdvSearchResults([]);
    setIsSearching(false);
  }, []);
  
  useEffect(() => {
    if (isOpen) {
        const savedOrders = JSON.parse(localStorage.getItem('steakhouse-orders') || '[]');
        setRecentOrders(savedOrders);
    } else {
        setTimeout(resetState, 300); // Delay reset to allow for closing animation
    }
  }, [isOpen, resetState]);

  const handleGetOrderDetails = async (id) => {
    if (!id) return;
    setIsLoading(true);
    setError(null);
    setSearchResult(null);
    // Clear advanced search results when looking up a specific ID
    setAdvSearchResults([]);
    const result = await apiService.getOrder(id.trim());
    if (result.success && result.order) {
      setSearchResult(result.order);
      setOrderIdInput(id); // Sync the input field
    } else {
      setError(result.message || '找不到此訂單，請確認訂單編號。');
    }
    setIsLoading(false);
  };
  
  const handleAdvancedSearch = async (e) => {
      e.preventDefault();
      setIsSearching(true);
      setError(null);
      // Clear other search states
      setSearchResult(null);
      setOrderIdInput('');
      
      const result = await apiService.searchOrders(advSearchParams);
      
      if (result.success && result.orders) {
          setAdvSearchResults(result.orders);
          if (result.orders.length === 0) {
              setError("找不到符合條件的訂單。");
          }
      } else {
          setAdvSearchResults([]); // Clear results on error
          setError(result.message || "搜尋時發生錯誤。");
      }
      setIsSearching(false);
  }

  const renderOrderItem = (item, index) => (
    <div key={item.cartId || index} className="py-2 border-b border-slate-200">
      <p className="font-semibold text-slate-800">{item.item.name.replace(/半全餐|半套餐/g, '套餐')} (${item.item.price}) <span className="font-normal">x{item.quantity}</span></p>
      <div className="text-xs text-slate-500 pl-2">
        {item.selectedDonenesses && Object.keys(item.selectedDonenesses).length > 0 && <p>熟度: {Object.entries(item.selectedDonenesses).map(([d, q]) => `${d}x${q}`).join(', ')}</p>}
        {item.selectedDrinks && Object.keys(item.selectedDrinks).length > 0 && <p>飲料: {Object.entries(item.selectedDrinks).map(([d, q]) => `${d}x${q}`).join(', ')}</p>}
        {item.selectedSauces && item.selectedSauces.length > 0 && <p>醬料: {item.selectedSauces.map(s => `${s.name}x${s.quantity}`).join(', ')}</p>}
        {item.selectedAddons && item.selectedAddons.length > 0 && <p>加購: {item.selectedAddons.map(a => `${a.name} ($${a.price}) x${a.quantity}`).join(', ')}</p>}
        {item.selectedNotes && <p>備註: {item.selectedNotes}</p>}
      </div>
    </div>
  );

  return (
    <div className={`fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4 transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={onClose}>
        <div className="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
            <header className="p-5 relative border-b">
                <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-800"><CloseIcon /></button>
                <h2 className="text-2xl font-bold text-slate-800">查詢訂單</h2>
            </header>
            <main className="px-6 py-4 space-y-4 overflow-y-auto">
                {/* Search by ID */}
                <form onSubmit={(e) => { e.preventDefault(); handleGetOrderDetails(orderIdInput); }} className="flex gap-2">
                    <input type="text" value={orderIdInput} onChange={(e) => setOrderIdInput(e.target.value)} placeholder="依訂單編號查詢" className="flex-grow p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-green-500 outline-none" />
                    <button type="submit" disabled={isLoading} className="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 flex items-center justify-center disabled:bg-slate-400">{isLoading && !isSearching ? <div className="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div> : <SearchIcon />}</button>
                </form>
                
                {/* Recent Orders */}
                {recentOrders.length > 0 && (
                    <div className="text-sm"><h3 className="font-semibold text-slate-500 mb-2">最近的訂單:</h3><div className="flex flex-wrap gap-2">{recentOrders.map(id => (<button key={id} onClick={() => handleGetOrderDetails(id)} className="bg-slate-100 text-slate-700 font-mono px-3 py-1 rounded-full hover:bg-slate-200">{id}</button>))}</div></div>
                )}

                {/* Advanced Search Toggle */}
                <div className="text-center"><button onClick={() => setIsAdvancedSearchOpen(!isAdvancedSearchOpen)} className="text-sm text-blue-600 hover:underline">{isAdvancedSearchOpen ? '隱藏進階搜尋' : '進階搜尋'}</button></div>

                {/* Advanced Search Form */}
                {isAdvancedSearchOpen && (
                    <form onSubmit={handleAdvancedSearch} className="p-4 bg-slate-50 rounded-lg border space-y-3">
                        <h3 className="font-semibold text-slate-700">進階搜尋</h3>
                        <input type="text" value={advSearchParams.name} onChange={e => setAdvSearchParams(p => ({...p, name: e.target.value}))} placeholder="顧客姓名 (完全符合)" className="w-full p-2 border rounded" />
                        <input
                            type="tel"
                            value={advSearchParams.phone}
                            onChange={e => {
                                const numericValue = e.target.value.replace(/[^0-9]/g, '');
                                if (numericValue.length <= 10) {
                                    setAdvSearchParams(p => ({...p, phone: numericValue}));
                                }
                            }}
                            placeholder="顧客電話 (10位數字)"
                            className="w-full p-2 border rounded"
                            maxLength={10}
                        />
                        <div className="flex gap-2 items-center"><label className="text-sm">日期:</label><input type="date" value={advSearchParams.startDate} onChange={e => setAdvSearchParams(p => ({...p, startDate: e.target.value}))} className="w-full p-2 border rounded" /><span className="text-sm">到</span><input type="date" value={advSearchParams.endDate} onChange={e => setAdvSearchParams(p => ({...p, endDate: e.target.value}))} className="w-full p-2 border rounded" /></div>
                        <button type="submit" disabled={isSearching} className="w-full mt-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 flex items-center justify-center disabled:bg-slate-400">{isSearching ? <div className="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div> : '執行搜尋'}</button>
                    </form>
                )}

                {/* Search Results Area */}
                {advSearchResults.length > 0 && (
                    <div className="border-t pt-4 mt-4">
                        <h3 className="font-semibold text-slate-800 mb-2">搜尋結果:</h3>
                        <ul className="max-h-48 overflow-y-auto bg-white border rounded-lg divide-y">
                            {advSearchResults.map(order => (
                                <li key={order.id}><button onClick={() => handleGetOrderDetails(order.id)} className="w-full text-left p-3 hover:bg-slate-100"><div className="flex justify-between font-mono text-sm"><span>{order.id}</span><span>${order.totalAmount}</span></div><div className="text-xs text-slate-500">{order.customerName} - {new Date(order.timestamp).toLocaleDateString()}</div></button></li>
                            ))}
                        </ul>
                    </div>
                )}
                
                {error && <p className="text-red-500 text-center font-semibold py-2">{error}</p>}
                
                {searchResult && (
                    <div className="bg-slate-50 p-4 rounded-lg border space-y-2 mt-4 animate-fade-in">
                        <h3 className="text-lg font-bold text-slate-800 text-center mb-3">訂單詳情</h3>
                        <div className="flex justify-between items-baseline"><p className="text-sm text-slate-600">訂單編號:</p><p className="font-mono font-bold text-slate-800">{searchResult.id}</p></div>
                        <div className="flex justify-between items-baseline"><p className="text-sm text-slate-600">顧客:</p><p className="font-semibold">{searchResult.customerInfo.name} ({searchResult.customerInfo.phone})</p></div>
                        <div className="flex justify-between items-baseline"><p className="text-sm text-slate-600">類型:</p><p className="font-semibold">{searchResult.orderType}{searchResult.orderType === '內用' && searchResult.customerInfo.tableNumber ? ` (${searchResult.customerInfo.tableNumber}桌)`: ''}</p></div>
                        <div className="flex justify-between items-baseline"><p className="text-sm text-slate-600">狀態:</p><p className="font-semibold text-green-700">{searchResult.status}</p></div>
                        <div className="flex justify-between items-baseline"><p className="text-sm text-slate-600">時間:</p><p className="font-semibold text-sm">{new Date(searchResult.createdAt).toLocaleString()}</p></div>
                        <div className="border-t border-slate-300 pt-2 mt-2"><h4 className="text-base font-bold text-slate-700 mb-2">餐點內容</h4>{searchResult.items.map(renderOrderItem)}</div>
                        <div className="flex justify-between items-center border-t border-slate-300 pt-2 mt-3"><p className="text-lg font-bold">總金額:</p><p className="text-xl font-bold text-green-700">${searchResult.totalPrice}</p></div>
                    </div>
                )}
            </main>
        </div>
    </div>
  );
};
// END OF components/OrderQueryModal.tsx

// START OF components/ItemModal.tsx
const ItemModal = ({ selectedItem, editingItem, addons, onClose, onConfirmSelection }) => {
  const { item, category } = selectedItem;
  const [quantity, setQuantity] = useState(1);
  const isSteak = !!item.customizations?.doneness;

  const [donenessQuantities, setDonenessQuantities] = useState({});
  const [drinkQuantities, setDrinkQuantities] = useState({});
  const [notes, setNotes] = useState('');
  const [selectedAddons, setSelectedAddons] = useState([]);
  const [selectedSauces, setSelectedSauces] = useState([]);
  const [selectedDesserts, setSelectedDesserts] = useState([]);
  const [selectedSingleChoiceAddon, setSelectedSingleChoiceAddon] = useState(null);
  const [multiChoiceQuantities, setMultiChoiceQuantities] = useState({});
  const [validationErrors, setValidationErrors] = useState([]);

  useEffect(() => {
    if (editingItem) {
      setQuantity(editingItem.quantity);
      setDonenessQuantities(editingItem.selectedDonenesses || {});
      setDrinkQuantities(editingItem.selectedDrinks || {});
      setSelectedSauces(editingItem.selectedSauces || []);
      setSelectedAddons(editingItem.selectedAddons || []);
      setSelectedDesserts(editingItem.selectedDesserts || []);
      setNotes(editingItem.selectedNotes || '');
      setSelectedSingleChoiceAddon(editingItem.selectedSingleChoiceAddon || null);
      setMultiChoiceQuantities(editingItem.selectedMultiChoice || {});
    } else {
      setQuantity(1);
      setDonenessQuantities({});
      setDrinkQuantities({});
      setSelectedSauces([]);
      setSelectedAddons([]);
      setSelectedDesserts([]);
      setNotes('');
      setSelectedSingleChoiceAddon(null);
      setMultiChoiceQuantities({});
    }
    setValidationErrors([]); // Reset errors when modal opens or item changes
  }, [editingItem, selectedItem]);

  const allocatedDonenessCount = useMemo(() => Object.values(donenessQuantities).reduce((sum, count) => sum + (count || 0), 0), [donenessQuantities]);
  const allocatedDrinkCount = useMemo(() => Object.values(drinkQuantities).reduce((sum, count) => sum + (count || 0), 0), [drinkQuantities]);
  const allocatedMultiChoiceCount = useMemo(() => Object.values(multiChoiceQuantities).reduce((sum, count) => sum + (count || 0), 0), [multiChoiceQuantities]);
  
  const saucesPerItem = item.customizations?.saucesPerItem ?? 2;
  const totalSauceLimit = quantity * saucesPerItem;
  const totalSauceCount = useMemo(() => selectedSauces.reduce((sum, sauce) => sum + sauce.quantity, 0), [selectedSauces]);

  const isDessertSelectionItem = useMemo(() => !!item.customizations?.dessertChoice, [item.customizations]);
  const totalDessertGroupA = useMemo(() => selectedDesserts.filter(d => DESSERT_CHOICES.includes(d.name)).reduce((sum, d) => sum + d.quantity, 0), [selectedDesserts]);
  const totalDessertGroupB = useMemo(() => selectedDesserts.filter(d => ICECREAM_CHOICES.includes(d.name)).reduce((sum, d) => sum + d.quantity, 0), [selectedDesserts]);

  const addonGroups = useMemo(() => {
    return addons.reduce((acc, addon) => {
      (acc[addon.category] = acc[addon.category] || []).push(addon);
      return acc;
    }, {});
  }, [addons]);
  
  const mainCourseAddonCategory = '主餐加購';
  const otherAddonGroups = useMemo(() => 
      Object.entries(addonGroups).filter(([categoryName]) => categoryName !== mainCourseAddonCategory)
  , [addonGroups]);
  const mainCourseAddonGroup = useMemo(() => 
      Object.entries(addonGroups).find(([categoryName]) => categoryName === mainCourseAddonCategory)
  , [addonGroups]);


  const handleDonenessChange = useCallback((doneness, change) => {
    setDonenessQuantities(prev => {
        const newQuantities = { ...prev };
        const currentCount = newQuantities[doneness] || 0;
        const newCount = currentCount + change;
        
        if (newCount < 0) return prev;
        if (change > 0 && allocatedDonenessCount >= quantity) return prev;

        if (newCount === 0) {
            delete newQuantities[doneness];
        } else {
            newQuantities[doneness] = newCount;
        }
        return newQuantities;
    });
  }, [allocatedDonenessCount, quantity]);

  const handleDrinkChange = useCallback((drink, change) => {
    setDrinkQuantities(prev => {
        const newQuantities = { ...prev };
        const currentCount = newQuantities[drink] || 0;
        const newCount = currentCount + change;
        
        if (newCount < 0) return prev;
        if (change > 0 && allocatedDrinkCount >= quantity) return prev;
        
        if (newCount === 0) {
            delete newQuantities[drink];
        } else {
            newQuantities[drink] = newCount;
        }
        return newQuantities;
    });
  }, [allocatedDrinkCount, quantity]);

  const handleMultiChoiceChange = useCallback((option, change) => {
    setMultiChoiceQuantities(prev => {
        const newQuantities = { ...prev };
        const currentCount = newQuantities[option] || 0;
        const newCount = currentCount + change;
        
        if (newCount < 0) return prev;
        if (change > 0 && allocatedMultiChoiceCount >= quantity) return prev;
        
        if (newCount === 0) {
            delete newQuantities[option];
        } else {
            newQuantities[option] = newCount;
        }
        return newQuantities;
    });
  }, [allocatedMultiChoiceCount, quantity]);


  const handleAddonQuantityChange = useCallback((addon, change) => {
    if (!addon.isAvailable && change > 0) return;
    setSelectedAddons(prev => {
      const existingAddon = prev.find(a => a.id === addon.id);
      if (existingAddon) {
        const newQuantity = existingAddon.quantity + change;
        return newQuantity <= 0 ? prev.filter(a => a.id !== addon.id) : prev.map(a => a.id === addon.id ? { ...a, quantity: newQuantity } : a);
      } else if (change > 0) {
        return [...prev, { ...addon, quantity: change }];
      }
      return prev;
    });
  }, []);

  const handleSauceChange = useCallback((sauceName, change) => {
    setSelectedSauces(prev => {
      const existingSauce = prev.find(s => s.name === sauceName);
      if (existingSauce) {
        const newQuantity = existingSauce.quantity + change;
        if (newQuantity < 0) return prev;
        if (totalSauceCount >= totalSauceLimit && change > 0) return prev;
        if (newQuantity === 0) return prev.filter(s => s.name !== sauceName);
        return prev.map(s => s.name === sauceName ? { ...s, quantity: newQuantity } : s);
      } else if (change > 0 && totalSauceCount < totalSauceLimit) {
        return [...prev, { name: sauceName, quantity: 1 }];
      }
      return prev;
    });
  }, [totalSauceCount, totalSauceLimit]);
  
  const handleDessertChange = useCallback((dessertName, change) => {
    setSelectedDesserts(prev => {
        if (isDessertSelectionItem && change > 0) {
            const isGroupA = DESSERT_CHOICES.includes(dessertName);
            if (isGroupA && totalDessertGroupA >= quantity) return prev;
            if (!isGroupA && totalDessertGroupB >= quantity) return prev;
        }

        const existingDessert = prev.find(s => s.name === dessertName);
        if (existingDessert) {
            const newQuantity = existingDessert.quantity + change;
            if (newQuantity <= 0) {
                return prev.filter(s => s.name !== dessertName);
            }
            return prev.map(s => s.name === dessertName ? { ...s, quantity: newQuantity } : s);
        } else if (change > 0) {
            return [...prev, { name: dessertName, quantity: 1 }];
        }
        return prev;
    });
  }, [isDessertSelectionItem, quantity, totalDessertGroupA, totalDessertGroupB]);

  const handleSubmit = () => {
    const errors = [];

    if (isSteak && allocatedDonenessCount !== quantity) {
      errors.push(`牛排熟度：請分配所有 ${quantity} 份餐點的熟度。`);
    }
    if (item.customizations?.drinkChoice && allocatedDrinkCount !== quantity) {
      errors.push(`飲料：請選擇所有 ${quantity} 份餐點的飲料。`);
    }
    if (item.customizations?.sauceChoice && totalSauceCount !== totalSauceLimit) {
      errors.push(`主菜沾醬：請為 ${quantity} 份餐點選擇共 ${totalSauceLimit} 份沾醬。`);
    }
    if (item.customizations?.multiChoice && allocatedMultiChoiceCount !== quantity) {
      errors.push(`${item.customizations.multiChoice.title}：請為 ${quantity} 份餐點分配選項。`);
    }
    if (isDessertSelectionItem && (totalDessertGroupA !== quantity || totalDessertGroupB !== quantity)) {
      errors.push(`甜品選擇：請為 ${quantity} 份餐點，在A區和B區各選擇 ${quantity} 樣甜品。`);
    }

    setValidationErrors(errors);

    if (errors.length > 0) {
      return;
    }

    const options = { 
        donenesses: donenessQuantities,
        drinks: drinkQuantities,
        addons: selectedAddons, 
        sauces: selectedSauces, 
        desserts: selectedDesserts,
        notes: notes.trim(),
        singleChoiceAddon: selectedSingleChoiceAddon,
        multiChoice: multiChoiceQuantities,
    };
    onConfirmSelection(item, quantity, options, category);
    onClose();
  };
  
  const singleChoiceAddonPrice = useMemo(() => {
    if (selectedSingleChoiceAddon && item.customizations.singleChoiceAddon) {
      return item.customizations.singleChoiceAddon.price;
    }
    return 0;
  }, [selectedSingleChoiceAddon, item.customizations.singleChoiceAddon]);

  const totalAddonPrice = selectedAddons.reduce((sum, addon) => sum + (addon.price * addon.quantity), 0);
  const totalPrice = (item.price + singleChoiceAddonPrice) * quantity + totalAddonPrice;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" onClick={onClose}>
      <div className="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
        <header className="p-6 relative border-b">
          <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-800"><CloseIcon /></button>
          <h2 className="text-2xl font-bold text-slate-800">{item.name.replace(/半全餐|半套餐/g, '套餐')}{item.weight && ` (${item.weight})`}</h2>
          <p className="text-xl font-semibold text-green-700 mt-2">${item.price}</p>
        </header>
        <main className="px-6 py-4 space-y-6 overflow-y-auto">
          <div className="flex items-center justify-between">
            <h3 className="text-lg font-semibold text-slate-700">数量</h3>
            <div className="flex items-center gap-2">
              <button onClick={() => setQuantity(q => Math.max(1, q - 1))} className="p-2 rounded-full bg-slate-200 hover:bg-slate-300"><MinusIcon /></button>
              <span className="text-xl font-bold w-12 text-center">{quantity}</span>
              <button onClick={() => setQuantity(q => q + 1)} className="p-2 rounded-full bg-slate-200 hover:bg-slate-300"><PlusIcon /></button>
            </div>
          </div>
          
          {item.customizations.multiChoice && (
             <div>
                <div className="flex justify-between items-baseline mb-3">
                  <h3 className="text-lg font-semibold text-slate-700">{item.customizations.multiChoice.title}*</h3>
                  <span className={`font-semibold ${allocatedMultiChoiceCount === quantity ? 'text-green-600' : 'text-red-500'}`}>已分配 {allocatedMultiChoiceCount} / {quantity}</span>
                </div>
                <div className="space-y-3">
                  {item.customizations.multiChoice.options.map(option => (
                    <div key={option} className="flex items-center justify-between bg-slate-50 p-3 rounded-lg">
                      <span className="font-medium text-slate-800">{option}</span>
                      <div className="flex items-center gap-3">
                        <button onClick={() => handleMultiChoiceChange(option, -1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300"><MinusIcon className="h-4 w-4" /></button>
                        <span className="text-lg font-semibold w-8 text-center">{multiChoiceQuantities[option] || 0}</span>
                        <button onClick={() => handleMultiChoiceChange(option, 1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300" disabled={allocatedMultiChoiceCount >= quantity}><PlusIcon className="h-4 w-4" /></button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
          )}

          {item.customizations.singleChoiceAddon && (
            <div>
              <h3 className="text-lg font-semibold text-slate-700 mb-3">
                單點加購 <span className="font-normal text-base">(+${item.customizations.singleChoiceAddon.price})</span>
              </h3>
              <div className="space-y-2">
                <label htmlFor="single-choice-none" className="flex items-center bg-slate-50 p-3 rounded-lg cursor-pointer">
                  <input
                    id="single-choice-none"
                    type="radio"
                    name="single-choice-addon"
                    checked={!selectedSingleChoiceAddon}
                    onChange={() => setSelectedSingleChoiceAddon(null)}
                    className="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500"
                  />
                  <span className="ml-3 block font-medium text-slate-900">不需要</span>
                </label>
                {item.customizations.singleChoiceAddon.options.map(option => (
                  <label key={option} htmlFor={`single-choice-${option}`} className="flex items-center bg-slate-50 p-3 rounded-lg cursor-pointer">
                    <input
                      id={`single-choice-${option}`}
                      type="radio"
                      name="single-choice-addon"
                      value={option}
                      checked={selectedSingleChoiceAddon === option}
                      onChange={() => setSelectedSingleChoiceAddon(option)}
                      className="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500"
                    />
                    <span className="ml-3 block font-medium text-slate-900">{option}</span>
                  </label>
                ))}
              </div>
            </div>
          )}

          {isSteak && (
            <div>
              <div className="flex justify-between items-baseline mb-3">
                <h3 className="text-lg font-semibold text-slate-700">牛排熟度*</h3>
                <span className={`font-semibold ${allocatedDonenessCount === quantity ? 'text-green-600' : 'text-red-500'}`}>已分配 {allocatedDonenessCount} / {quantity}</span>
              </div>
              <div className="space-y-3">
                {DONENESS_LEVELS.map(d => (
                  <div key={d} className="flex items-center justify-between bg-slate-50 p-3 rounded-lg">
                    <span className="font-medium text-slate-800">{d}</span>
                    <div className="flex items-center gap-3">
                      <button onClick={() => handleDonenessChange(d, -1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300"><MinusIcon className="h-4 w-4" /></button>
                      <span className="text-lg font-semibold w-8 text-center">{donenessQuantities[d] || 0}</span>
                      <button onClick={() => handleDonenessChange(d, 1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300" disabled={allocatedDonenessCount >= quantity}><PlusIcon className="h-4 w-4" /></button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
          {item.customizations?.drinkChoice && (
            <div>
                <div className="flex justify-between items-baseline mb-3">
                    <h3 className="text-lg font-semibold text-slate-700">飲料*</h3>
                    <span className={`font-semibold ${allocatedDrinkCount === quantity ? 'text-green-600' : 'text-red-500'}`}>已選擇 {allocatedDrinkCount} / {quantity}</span>
                </div>
                <div className="space-y-3">
                    {DRINK_CHOICES.map(drink => (
                        <div key={drink} className="flex items-center justify-between bg-slate-50 p-3 rounded-lg">
                            <span className="font-medium text-slate-800">{drink}</span>
                            <div className="flex items-center gap-3">
                                <button onClick={() => handleDrinkChange(drink, -1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300"><MinusIcon className="h-4 w-4" /></button>
                                <span className="text-lg font-semibold w-8 text-center">{drinkQuantities[drink] || 0}</span>
                                <button onClick={() => handleDrinkChange(drink, 1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300" disabled={allocatedDrinkCount >= quantity}><PlusIcon className="h-4 w-4" /></button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
          )}
          {item.customizations?.sauceChoice && (
            <div>
              <div className="flex justify-between items-baseline mb-3">
                <h3 className="text-lg font-semibold text-slate-700">主菜沾醬 (每份選{saucesPerItem})*</h3>
                <span className={`font-semibold ${totalSauceCount === totalSauceLimit ? 'text-green-600' : 'text-red-500'}`}>已選 {totalSauceCount} / {totalSauceLimit}</span>
              </div>
              <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                {SAUCE_CHOICES.map(sauce => (
                  <div key={sauce} className="flex items-center justify-between bg-slate-50 p-2 rounded-lg">
                    <span className="font-medium text-slate-800 text-sm">{sauce}</span>
                    <div className="flex items-center gap-2">
                      <button onClick={() => handleSauceChange(sauce, -1)} className="p-1 rounded-full bg-slate-200 hover:bg-slate-300"><MinusIcon className="h-4 w-4" /></button>
                      <span className="text-md font-semibold w-5 text-center">{selectedSauces.find(s => s.name === sauce)?.quantity || 0}</span>
                      <button onClick={() => handleSauceChange(sauce, 1)} className="p-1 rounded-full bg-slate-200 hover:bg-slate-300" disabled={totalSauceCount >= totalSauceLimit}><PlusIcon className="h-4 w-4" /></button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
          {item.customizations?.dessertChoice && (
            <div>
                <h3 className="text-lg font-semibold text-slate-700 mb-3">甜品選擇</h3>
                <div className="space-y-4">
                    <div>
                        <div className="flex justify-between items-baseline mb-2 pl-2">
                            <h4 className="text-md font-semibold text-slate-600">A區 - 任選一種↓*</h4>
                            {isDessertSelectionItem && <span className={`font-semibold ${totalDessertGroupA === quantity ? 'text-green-600' : 'text-red-500'}`}>已選 {totalDessertGroupA} / {quantity}</span>}
                        </div>
                        <div className="grid grid-cols-1 gap-3">
                            {DESSERT_CHOICES.map(dessert => (
                                <div key={dessert} className="flex items-center justify-between bg-slate-50 p-2 rounded-lg">
                                    <span className="font-medium text-slate-800 text-sm">{dessert}</span>
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => handleDessertChange(dessert, -1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300"><MinusIcon className="h-4 w-4" /></button>
                                        <span className="text-lg font-semibold w-6 text-center">{selectedDesserts.find(d => d.name === dessert)?.quantity || 0}</span>
                                        <button onClick={() => handleDessertChange(dessert, 1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300" disabled={isDessertSelectionItem && totalDessertGroupA >= quantity}><PlusIcon className="h-4 w-4" /></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div>
                        <div className="flex justify-between items-baseline mb-2 pl-2">
                            <h4 className="text-md font-semibold text-slate-600">B區 - 任選一種↓*</h4>
                            {isDessertSelectionItem && <span className={`font-semibold ${totalDessertGroupB === quantity ? 'text-green-600' : 'text-red-500'}`}>已選 {totalDessertGroupB} / {quantity}</span>}
                        </div>
                         <div className="grid grid-cols-1 gap-3">
                            {ICECREAM_CHOICES.map(dessert => (
                                <div key={dessert} className="flex items-center justify-between bg-slate-50 p-2 rounded-lg">
                                    <span className="font-medium text-slate-800 text-sm">{dessert}</span>
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => handleDessertChange(dessert, -1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300"><MinusIcon className="h-4 w-4" /></button>
                                        <span className="text-lg font-semibold w-6 text-center">{selectedDesserts.find(d => d.name === dessert)?.quantity || 0}</span>
                                        <button onClick={() => handleDessertChange(dessert, 1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300" disabled={isDessertSelectionItem && totalDessertGroupB >= quantity}><PlusIcon className="h-4 w-4" /></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
          )}
          {otherAddonGroups.map(([categoryName, addonList]) => (
            <div key={categoryName}>
              <h3 className="text-lg font-semibold text-slate-700 mb-3">{categoryName}</h3>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                {addonList.map(addon => (
                  <div key={addon.id} className={`flex items-center justify-between p-3 rounded-md ${addon.isAvailable ? 'bg-slate-100' : 'bg-slate-200 opacity-60'}`}>
                    <div>
                      <span className={`text-slate-800 text-sm ${!addon.isAvailable ? 'line-through' : ''}`}>{addon.name}</span>
                      <span className="ml-2 font-semibold text-slate-500 text-sm">+${addon.price}</span>
                      {!addon.isAvailable && <span className="ml-2 text-red-500 text-xs font-bold">售完</span>}
                    </div>
                    <div className="flex items-center gap-2">
                      <button onClick={() => handleAddonQuantityChange(addon, -1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300 disabled:bg-slate-300" disabled={!addon.isAvailable}><MinusIcon className="h-4 w-4" /></button>
                      <span className="text-lg font-semibold w-6 text-center">{selectedAddons.find(a => a.id === addon.id)?.quantity || 0}</span>
                      <button onClick={() => handleAddonQuantityChange(addon, 1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300 disabled:bg-slate-300" disabled={!addon.isAvailable}><PlusIcon className="h-4 w-4" /></button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          ))}
           {item.customizations?.notes && (
            <div>
              <h3 className="text-lg font-semibold text-slate-700 mb-3">備註</h3>
              <textarea value={notes} onChange={e => setNotes(e.target.value)} rows={2} placeholder="有任何特殊需求嗎？" className="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-green-500 outline-none"></textarea>
            </div>
          )}
          {mainCourseAddonGroup && (
            <div key={mainCourseAddonGroup[0]}>
              <h3 className="text-lg font-semibold text-slate-700 mb-3">{mainCourseAddonGroup[0]}</h3>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                {mainCourseAddonGroup[1].map(addon => (
                  <div key={addon.id} className={`flex items-center justify-between p-3 rounded-md ${addon.isAvailable ? 'bg-slate-100' : 'bg-slate-200 opacity-60'}`}>
                    <div>
                      <span className={`text-slate-800 text-sm ${!addon.isAvailable ? 'line-through' : ''}`}>{addon.name}</span>
                      <span className="ml-2 font-semibold text-slate-500 text-sm">+${addon.price}</span>
                      {!addon.isAvailable && <span className="ml-2 text-red-500 text-xs font-bold">售完</span>}
                    </div>
                    <div className="flex items-center gap-2">
                      <button onClick={() => handleAddonQuantityChange(addon, -1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300 disabled:bg-slate-300" disabled={!addon.isAvailable}><MinusIcon className="h-4 w-4" /></button>
                      <span className="text-lg font-semibold w-6 text-center">{selectedAddons.find(a => a.id === addon.id)?.quantity || 0}</span>
                      <button onClick={() => handleAddonQuantityChange(addon, 1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300 disabled:bg-slate-300" disabled={!addon.isAvailable}><PlusIcon className="h-4 w-4" /></button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </main>
        <footer className="p-6 border-t bg-slate-50">
          {validationErrors.length > 0 && (
            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
              <strong className="font-bold">請完成以下必填選項：</strong>
              <ul className="mt-2 list-disc list-inside text-sm">
                {validationErrors.map((error, index) => (
                  <li key={index}>{error}</li>
                ))}
              </ul>
              <button
                onClick={() => setValidationErrors([])}
                className="absolute top-2 right-2 p-1.5 text-red-500 hover:bg-red-200 rounded-lg transition-colors"
                aria-label="關閉提示"
              >
                <CloseIcon className="h-5 w-5" />
              </button>
            </div>
          )}
          <button onClick={handleSubmit} className="w-full bg-green-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-green-700 transition-colors text-lg">
            {editingItem ? `更新 ${totalPrice} 到購物車` : `加入 ${totalPrice} 到購物車`}
          </button>
        </footer>
      </div>
    </div>
  );
};
// END OF components/ItemModal.tsx

// START OF components/Menu.tsx
const Menu = ({ menuData, onSelectItem }) => {
  return (
    <div className="space-y-12">
      {menuData.map((category) => (
        <div key={category.title} id={category.title}>
          <div className="mb-6 pb-2 border-b-2 border-green-700">
            <h2 className="text-3xl font-bold text-slate-800">{category.title}</h2>
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {category.items.map((item) => {
              const hasOtherOptions = item.customizations.dessertChoice || item.customizations.multiChoice || item.customizations.singleChoiceAddon;
              
              return (
                <div key={item.id} className={`bg-white rounded-lg shadow-lg overflow-hidden flex flex-col transition-transform transform hover:scale-105 relative ${!item.isAvailable ? 'opacity-60 bg-slate-50 cursor-not-allowed' : ''}`}>
                  {!item.isAvailable && <div className="absolute top-4 right-4 bg-red-600 text-white text-sm font-bold px-3 py-1 rounded-full z-10 transform -rotate-12">售罄</div>}
                  <div className="p-6 flex-grow flex flex-col justify-between">
                    <div>
                      <h3 className="text-xl font-semibold text-slate-900">{item.name.replace(/半全餐|半套餐/g, '套餐')}</h3>
                      {item.weight && <p className="text-sm text-slate-500">{item.weight}</p>}
                      {item.description && (
                          <p className="text-xs text-slate-500 mt-1">{item.description}</p>
                      )}
                      <p className="text-2xl font-bold text-green-700 mt-2">${item.price}</p>
                      {item.customizations && (
                        <div className="mt-2 flex flex-wrap gap-1">
                          {item.customizations.doneness && <span className="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">可選熟度</span>}
                          {item.customizations.sauceChoice && <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">可選醬料</span>}
                          {item.customizations.drinkChoice && <span className="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full">可選附餐</span>}
                          {hasOtherOptions && <span className="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full">更多選項</span>}
                        </div>
                      )}
                    </div>
                    <button
                      onClick={() => onSelectItem(item, category)}
                      disabled={!item.isAvailable}
                      className="mt-4 w-full flex items-center justify-center bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed"
                    >
                      <PlusIcon className="h-5 w-5 mr-2" />
                      <span>{item.isAvailable ? '加入餐點' : '已售完'}</span>
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      ))}
    </div>
  );
};
// END OF components/Menu.tsx

// START OF components/Cart.tsx
const CartMainView = ({ onClose, cartItems, onUpdateQuantity, onRemoveItem, onEditItem, customerInfo, onInfoChange, totalPrice, handleCheckout, isSubmitting, orderType, setOrderType, validationError, setValidationError }) => {
    const aggregatedOptions = useMemo(() => {
        const drinks = {};
        const sauces = {};
        const desserts = {};
        const addons = {};
        cartItems.forEach(cartItem => {
            if (cartItem.selectedDrinks) Object.entries(cartItem.selectedDrinks).forEach(([name, quantity]) => drinks[name] = (drinks[name] || 0) + quantity);
            if (cartItem.selectedSauces) (cartItem.selectedSauces).forEach(sauce => sauces[sauce.name] = (sauces[sauce.name] || 0) + sauce.quantity);
            if (cartItem.selectedDesserts) cartItem.selectedDesserts.forEach(dessert => desserts[dessert.name] = (desserts[dessert.name] || 0) + dessert.quantity);
            if (cartItem.selectedAddons) cartItem.selectedAddons.forEach(addon => addons[addon.name] = { quantity: (addons[addon.name]?.quantity || 0) + addon.quantity, price: addon.price });
        });
        return { drinks, sauces, addons, desserts };
    }, [cartItems]);

    return (
        <div className="flex flex-col h-full">
            <div className="flex justify-between items-center p-5 border-b"><h2 className="text-2xl font-bold text-slate-800">我的購物車</h2><button onClick={onClose} className="text-slate-500 hover:text-slate-800"><CloseIcon /></button></div>
            {cartItems.length === 0 ? (<div className="flex-grow flex flex-col justify-center items-center text-slate-500 p-4"><CartIcon className="w-24 h-24 mb-4 text-slate-300"/><p className="text-lg">您的購物車是空的</p></div>) : (<>
                <div className="flex-grow overflow-y-auto">
                    <div className="p-5 space-y-6">
                        <div className="bg-slate-50 rounded-lg p-4"><h3 className="text-lg font-bold text-slate-700 mb-3 pb-2 border-b">餐點列表</h3><div className="space-y-4">{cartItems.map((item, index) => (<div key={item.cartId} className="flex items-start gap-3"><div className="pt-1 font-semibold text-slate-500">{index + 1}.</div><div className="flex-grow"><button onClick={() => onEditItem(item.cartId)} className="font-semibold text-left hover:text-blue-600 hover:underline transition-colors focus:outline-none">{item.item.name.replace(/半全餐|半套餐/g, '套餐')} <span className="font-normal text-slate-500">(${item.item.price}) x{item.quantity}</span></button><div className="text-sm text-slate-600 mt-1 space-y-0.5">{item.selectedDonenesses && Object.keys(item.selectedDonenesses).length > 0 && <p>熟度: {Object.entries(item.selectedDonenesses).map(([d, q]) => `${d}x${q}`).join(', ')}</p>}{item.selectedMultiChoice && Object.keys(item.selectedMultiChoice).length > 0 && <p>口味: {Object.entries(item.selectedMultiChoice).map(([d, q]) => `${d}x${q}`).join(', ')}</p>}{item.selectedSingleChoiceAddon && <p>單點加購: {item.selectedSingleChoiceAddon}</p>}{item.selectedAddons && item.selectedAddons.length > 0 && <p>加購: {item.selectedAddons.map(a => `${a.name} ($${a.price}) x${a.quantity}`).join(', ')}</p>}{item.selectedDesserts && item.selectedDesserts.length > 0 && <p>甜品: {item.selectedDesserts.map(d => `${d.name}x${d.quantity}`).join(', ')}</p>}{item.selectedNotes && <p className="text-blue-600">備註: {item.selectedNotes}</p>}</div></div><div className="text-right flex flex-col items-end"><p className="font-bold text-lg">${item.totalPrice}</p><div className="flex items-center gap-2 mt-3"><button onClick={() => onUpdateQuantity(item.cartId, item.quantity - 1)} className="p-1 rounded-full bg-slate-200 hover:bg-slate-300"><MinusIcon className="h-4 w-4" /></button><span className="font-semibold w-8 text-center">{item.quantity}</span><button onClick={() => onUpdateQuantity(item.cartId, item.quantity + 1)} className="p-1 rounded-full bg-slate-200 hover:bg-slate-300"><PlusIcon className="h-4 w-4" /></button><button onClick={() => onRemoveItem(item.cartId)} className="text-red-500 hover:text-red-700 ml-1"><TrashIcon className="h-5 w-5"/></button></div></div></div>))}</div></div>
                        <div className="bg-slate-100 rounded-lg p-4 space-y-3"><h3 className="text-md font-bold text-slate-600 border-b pb-2">訂單選項總覽</h3><div className="text-sm text-slate-700 space-y-1">{Object.keys(aggregatedOptions.drinks).length > 0 && <p><span className="font-semibold">飲料:</span> {Object.entries(aggregatedOptions.drinks).map(([name, q]) => `${name} x${q}`).join(', ')}</p>}{Object.keys(aggregatedOptions.sauces).length > 0 && <p><span className="font-semibold">沾醬:</span> {Object.entries(aggregatedOptions.sauces).map(([name, q]) => `${name} x${q}`).join(', ')}</p>}{Object.keys(aggregatedOptions.desserts).length > 0 && <p><span className="font-semibold">甜品:</span> {Object.entries(aggregatedOptions.desserts).map(([name, q]) => `${name} x${q}`).join(', ')}</p>}{Object.keys(aggregatedOptions.addons).length > 0 && (<div><p className="font-semibold">加購:</p><ul className="list-disc list-inside pl-2">{Object.entries(aggregatedOptions.addons).map(([name, addonData]) => (<li key={name}>{name} ($${addonData.price}) x{addonData.quantity} (+${addonData.price * addonData.quantity})</li>))}</ul></div>)}</div></div>
                    </div>
                    <div className="p-5 border-t bg-slate-100">
                        <div className="mb-4"><h3 className="text-lg font-semibold mb-2 text-slate-700">用餐方式</h3><div className="flex w-full bg-slate-200 rounded-lg p-1"><button onClick={() => setOrderType('內用')} className={`flex-1 py-2 rounded-md font-semibold transition-colors ${orderType === '內用' ? 'bg-green-600 text-white shadow' : 'text-slate-600'}`}>內用</button><button onClick={() => setOrderType('外帶')} className={`flex-1 py-2 rounded-md font-semibold transition-colors ${orderType === '外帶' ? 'bg-green-600 text-white shadow' : 'text-slate-600'}`}>外帶</button></div></div>
                        <h3 className="text-lg font-semibold mb-3 text-slate-700">顧客資訊</h3>
                        <div className="space-y-3">
                            <input type="text" placeholder="姓名 *" value={customerInfo.name} onChange={(e) => onInfoChange('name', e.target.value)} className="w-full p-2 border border-slate-300 rounded-md" required />
                            <input type="tel" placeholder="電話 * (10位數字)" value={customerInfo.phone} onChange={(e) => onInfoChange('phone', e.target.value)} className="w-full p-2 border border-slate-300 rounded-md" pattern="[0-9]{10}" maxLength={10} required />
                            {orderType === '內用' && (<input type="text" placeholder="桌號 (可選)" value={customerInfo.tableNumber} onChange={(e) => onInfoChange('tableNumber', e.target.value)} className="w-full p-2 border border-slate-300 rounded-md" />)}
                        </div>
                    </div>
                </div>
                <div className="p-5 border-t bg-slate-50">
                    <div className="flex justify-between items-center mb-4"><span className="text-xl font-medium">總計</span><span className="text-3xl font-bold text-green-700">${totalPrice}</span></div>
                    {validationError && (
                        <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-3 mb-3 rounded-md text-left relative" role="alert">
                            <p className="font-bold pr-8">{validationError}</p>
                            <button
                                onClick={() => setValidationError(null)}
                                className="absolute top-1/2 right-2 -translate-y-1/2 p-1.5 text-red-500 hover:bg-red-200 rounded-lg transition-colors"
                                aria-label="關閉提示"
                            >
                                <CloseIcon className="h-5 w-5" />
                            </button>
                        </div>
                    )}
                    <button onClick={handleCheckout} disabled={isSubmitting} className="w-full bg-green-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-green-700 transition-colors text-lg flex justify-center items-center disabled:bg-slate-400">
                        {isSubmitting ? <div className="animate-spin rounded-full h-6 w-6 border-t-2 border-b-2 border-white"></div> : '送出訂單'}
                    </button>
                </div>
            </>)}
        </div>
    );
};

const Cart = ({ isOpen, onClose, cartItems, onUpdateQuantity, onRemoveItem, onEditItem, onSubmitOrder }) => {
    const [customerInfo, setCustomerInfo] = useState({ name: '', phone: '', tableNumber: '' });
    const [orderType, setOrderType] = useState('內用');
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [validationError, setValidationError] = useState(null);

    useEffect(() => {
        if (!isOpen) {
            setTimeout(() => {
                setOrderType('內用');
                setValidationError(null);
            }, 300);
        }
    }, [isOpen]);

    useEffect(() => {
        if (orderType === '外帶') setCustomerInfo(prev => ({ ...prev, tableNumber: '' }));
    }, [orderType]);

    const handleCustomerInfoChange = (field, value) => {
        if (validationError) setValidationError(null);

        if (field === 'phone') {
            const numericValue = value.replace(/[^0-9]/g, '');
            if (numericValue.length <= 10) {
                setCustomerInfo(prev => ({ ...prev, phone: numericValue }));
            }
        } else {
            setCustomerInfo(prev => ({ ...prev, [field]: value }));
        }
    };

    const totalPrice = useMemo(() => cartItems.reduce((total, item) => total + item.totalPrice, 0), [cartItems]);

    const handleCheckout = async () => {
        setValidationError(null);
        if (!customerInfo.name.trim()) { setValidationError('請填寫您的姓名'); return; }
        if (!customerInfo.phone.trim()) { setValidationError('請填寫您的電話'); return; }
        if (!/^[0-9]{10}$/.test(customerInfo.phone)) { setValidationError('請輸入有效的手機號碼（10位數字）'); return; }

        setIsSubmitting(true);
        const orderData = { items: cartItems, totalPrice, customerInfo, orderType };
        const result = await onSubmitOrder(orderData);
        
        if (!result.success) {
            setValidationError(result.message || '訂單提交失敗，請稍後再試。');
        }
        setIsSubmitting(false);
    };

    return (
        <>
            <div className={`fixed inset-0 bg-black bg-opacity-50 z-30 transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={onClose} />
            <div className={`fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-lg z-40 transform transition-transform duration-300 ease-in-out ${isOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                <CartMainView 
                    onClose={onClose} 
                    cartItems={cartItems} 
                    onUpdateQuantity={onUpdateQuantity} 
                    onRemoveItem={onRemoveItem} 
                    onEditItem={onEditItem} 
                    customerInfo={customerInfo} 
                    onInfoChange={handleCustomerInfoChange} 
                    orderType={orderType} 
                    setOrderType={setOrderType} 
                    totalPrice={totalPrice} 
                    handleCheckout={handleCheckout} 
                    isSubmitting={isSubmitting} 
                    validationError={validationError} 
                    setValidationError={setValidationError} 
                />
            </div>
        </>
    );
};
// END OF components/Cart.tsx

// START OF App.tsx
const App = () => {
    const [cart, setCart] = useState([]);
    const [isCartOpen, setIsCartOpen] = useState(false);
    const [selectedItem, setSelectedItem] = useState(null);
    const [editingCartItem, setEditingCartItem] = useState(null);
    const [isQueryModalOpen, setIsQueryModalOpen] = useState(false);
    const [isAdminDashboardOpen, setIsAdminDashboardOpen] = useState(false);
    const [isEditingFromCart, setIsEditingFromCart] = useState(false);
    const [confirmationData, setConfirmationData] = useState(null);
    const [printContent, setPrintContent] = useState(null);

    const [menuData, setMenuData] = useState([]);
    const [addons, setAddons] = useState([]);
    const [loading, setLoading] = useState(true);
    const [isRefreshing, setIsRefreshing] = useState(false);
    const [notification, setNotification] = useState(null);

    const fetchData = useCallback(async () => {
        setNotification(null);
        const { menu, addons, from } = await apiService.getMenuAndAddons();

        if (from === 'api' && (!menu || menu.length === 0 || menu.every(cat => cat.items.length === 0))) {
            setMenuData(MENU_DATA);
            setAddons(ADDONS);
            setNotification('成功連接伺服器，但菜單是空的。請檢查後台 Google Sheet 是否已填入資料，或執行「一鍵設定工作表」。');
        } else {
            setMenuData(menu);
            setAddons(addons);
            if (from === 'fallback') {
                setNotification('無法連接伺服器，目前顯示的是離線菜單。');
            }
        }
    }, []);
    
    // Centralized Printing Logic
    useEffect(() => {
        if (printContent) {
            const handleAfterPrint = () => {
                setPrintContent(null);
            };

            window.addEventListener('afterprint', handleAfterPrint, { once: true });
            
            const timer = setTimeout(() => {
                window.print();
            }, 100); 

            return () => {
                clearTimeout(timer);
                window.removeEventListener('afterprint', handleAfterPrint);
            };
        }
    }, [printContent]);

    const handlePrintRequest = (content) => {
        setPrintContent(content);
    };


    useEffect(() => {
        const initialLoad = async () => {
            setLoading(true);
            await fetchData();
            setLoading(false);
        };
        initialLoad();
    }, [fetchData]);

    const handleRefresh = async () => {
        setIsRefreshing(true);
        await fetchData();
        setIsRefreshing(false);
    };

    const handleSelectItem = (item, category) => {
        if (!item.isAvailable) return;
        setSelectedItem({ item, category });
    };

    const handleCloseModal = () => {
        setSelectedItem(null);
        setEditingCartItem(null);
        setIsEditingFromCart(false); 
    };
    
    const handleEditItem = (cartId) => {
        const itemToEdit = cart.find(i => i.cartId === cartId);
        if(itemToEdit) {
            const category = menuData.find(c => c.title === itemToEdit.categoryTitle) || { title: itemToEdit.categoryTitle, items: [] };
            setIsEditingFromCart(true);
            setEditingCartItem(itemToEdit);
            setSelectedItem({ item: itemToEdit.item, category });
        }
    };

    const createCartItemObject = (item, quantity, options, category) => {
        const { donenesses, drinks, addons, notes, sauces, desserts, singleChoiceAddon, multiChoice } = options;
        
        const generateStableObjectString = (obj) => {
            if (!obj || Object.keys(obj).length === 0) return '';
            return JSON.stringify(Object.fromEntries(Object.entries(obj).filter(([, val]) => val && Number(val) > 0).sort(([keyA], [keyB]) => keyA.localeCompare(keyB))));
        };
        
        const singleChoicePrice = singleChoiceAddon && item.customizations.singleChoiceAddon ? item.customizations.singleChoiceAddon.price : 0;
        const totalAddonPrice = (addons || []).reduce((sum, addon) => sum + (addon.price * addon.quantity), 0);
        const totalPrice = (item.price + singleChoicePrice) * quantity + totalAddonPrice;

        const cartKeyFields = {
            id: item.id,
            donenesses: generateStableObjectString(donenesses),
            drinks: generateStableObjectString(drinks),
            multiChoice: generateStableObjectString(multiChoice),
            notes: notes,
            addons: (addons || []).map((a) => `${a.id}:${a.quantity}`).sort().join(','),
            sauces: (sauces || []).map((s) => `${s.name}:${s.quantity}`).sort().join(','),
            desserts: (desserts || []).map((d) => `${d.name}:${d.quantity}`).sort().join(','),
            singleChoiceAddon: singleChoiceAddon || 'none',
        };
        const cartKey = JSON.stringify(cartKeyFields);

        return {
            cartKey,
            item,
            quantity,
            categoryTitle: category.title,
            selectedDonenesses: donenesses,
            selectedDrinks: drinks,
            selectedAddons: addons || [],
            selectedSauces: sauces || [],
            selectedDesserts: desserts || [],
            selectedNotes: notes,
            selectedSingleChoiceAddon: singleChoiceAddon,
            selectedMultiChoice: multiChoice,
            totalPrice,
        };
    };
    
    const handleConfirmSelection = (item, quantity, options, category) => {
        const newOrUpdatedCartItem = createCartItemObject(item, quantity, options, category);

        if (editingCartItem && cart.some(i => i.cartId === editingCartItem.cartId)) {
            setCart(prevCart => prevCart.map(cartItem =>
                cartItem.cartId === editingCartItem.cartId
                    ? { ...newOrUpdatedCartItem, cartId: editingCartItem.cartId }
                    : cartItem
            ));
        } else {
            setCart(prevCart => {
                const existingItemIndex = prevCart.findIndex(cartItem => cartItem.cartKey === newOrUpdatedCartItem.cartKey);
                if (existingItemIndex > -1) {
                    const updatedCart = [...prevCart];
                    const existingItem = updatedCart[existingItemIndex];
                    const newQuantity = existingItem.quantity + quantity;

                    const singleChoicePrice = existingItem.selectedSingleChoiceAddon && item.customizations.singleChoiceAddon ? item.customizations.singleChoiceAddon.price : 0;
                    const totalAddonPrice = (existingItem.selectedAddons || []).reduce((sum, addon) => sum + (addon.price * addon.quantity), 0);
                    const newTotalPrice = (item.price + singleChoicePrice) * newQuantity + totalAddonPrice;

                    updatedCart[existingItemIndex] = { ...existingItem, quantity: newQuantity, totalPrice: newTotalPrice };
                    return updatedCart;
                } else {
                    const finalCartItem = { ...newOrUpdatedCartItem, cartId: `${newOrUpdatedCartItem.cartKey}-${Date.now()}` };
                    return [...prevCart, finalCartItem];
                }
            });
        }

        if (isEditingFromCart) {
            setIsCartOpen(true);
        }
    };
    
    const handleUpdateQuantity = (cartId, newQuantity) => {
        setCart(prevCart => {
            if (newQuantity <= 0) {
                return prevCart.filter(item => item.cartId !== cartId);
            }
            return prevCart.map(item => {
                if (item.cartId === cartId) {
                    const singleChoicePrice = item.selectedSingleChoiceAddon && item.item.customizations.singleChoiceAddon ? item.item.customizations.singleChoiceAddon.price : 0;
                    const totalAddonPrice = (item.selectedAddons || []).reduce((sum, addon) => sum + (addon.price * addon.quantity), 0);
                    const newTotalPrice = (item.item.price + singleChoicePrice) * newQuantity + totalAddonPrice;
                    return { ...item, quantity: newQuantity, totalPrice: newTotalPrice };
                }
                return item;
            });
        });
    };

    const handleRemoveFromCart = (cartId) => {
        setCart(prevCart => prevCart.filter(item => item.cartId !== cartId));
    };

    const handleSubmitOrder = async (orderData) => {
        const result = await apiService.submitOrder(orderData);
        if (result.success && result.orderId) {
            setCart([]);
            setIsCartOpen(false);
            setConfirmationData({ orderId: result.orderId, orderData });

            const savedOrders = JSON.parse(localStorage.getItem('steakhouse-orders') || '[]');
            if (!savedOrders.includes(result.orderId)) {
                savedOrders.unshift(result.orderId);
                localStorage.setItem('steakhouse-orders', JSON.stringify(savedOrders.slice(0, 10)));
            }
        }
        return result;
    };
    
    const cartItemCount = useMemo(() => cart.reduce((total, item) => total + item.quantity, 0), [cart]);

    const handleCloseConfirmation = () => {
        setConfirmationData(null);
    }

    if (loading) {
        return (
            <div className="min-h-screen flex flex-col justify-center items-center bg-slate-100">
                <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-green-700"></div>
                <p className="mt-4 text-slate-600 text-lg">正在載入菜單...</p>
            </div>
        );
    }

    return (
        <>
            <div className="print-area">
              {printContent}
            </div>
            <div className="min-h-screen bg-slate-100 text-slate-800">
                 {notification && (
                    <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 text-center" role="alert">
                        <p className="font-bold">{notification}</p>
                    </div>
                )}
                <header className="bg-white shadow-md sticky top-0 z-20">
                    <div className="container mx-auto px-4 py-4 sm:px-6 lg:px-8 flex justify-between items-center">
                        <h1 className="text-2xl sm:text-3xl font-bold text-green-800 tracking-wider">無名牛排點餐系統</h1>
                        <div className="flex items-center gap-2">
                            <button onClick={() => setIsAdminDashboardOpen(true)} className="flex items-center gap-2 px-3 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors text-sm font-medium">
                                <span>管理後台</span>
                            </button>
                            <button onClick={() => setIsQueryModalOpen(true)} className="flex items-center gap-2 px-3 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors text-sm font-medium">
                                <SearchIcon className="h-4 w-4"/>
                                <span>查詢訂單</span>
                            </button>
                            <button onClick={handleRefresh} disabled={isRefreshing} className="flex items-center gap-2 px-3 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors text-sm font-medium disabled:opacity-50">
                                <RefreshIcon className={`h-4 w-4 ${isRefreshing ? 'animate-spin' : ''}`}/>
                                <span>{isRefreshing ? '刷新中' : '刷新'}</span>
                            </button>
                        </div>
                    </div>
                </header>

                <main className="container mx-auto p-4 md:p-6 lg:p-8">
                    <Menu menuData={menuData} onSelectItem={handleSelectItem} />
                </main>

                <footer className="container mx-auto px-4 py-8 sm:px-6 lg:px-8 text-center text-slate-500 text-sm">
                    <div className="border-t border-slate-200 pt-8 space-y-2">
                        <p>＊店內最低消費為一份餐點</p>
                        <p>＊不收服務費，用完餐請回收餐具</p>
                        <p>＊用餐限九十分鐘請勿飲酒</p>
                        <p>＊餐點內容以現場出餐為準，餐點現點現做請耐心等候</p>
                    </div>
                </footer>

                {cartItemCount > 0 && (
                    <button
                        onClick={() => setIsCartOpen(true)}
                        className="fixed bottom-6 right-6 lg:bottom-10 lg:right-10 flex items-center justify-center bg-green-700 text-white rounded-full shadow-lg hover:bg-green-800 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-700 focus:ring-opacity-50 h-16 w-16"
                        aria-label={`查看購物車，共有 ${cartItemCount} 項商品`}
                    >
                        <CartIcon className="h-8 w-8" />
                        <span className="absolute -top-1 -right-1 flex h-6 w-6 items-center justify-center rounded-full bg-red-500 text-xs font-bold">{cartItemCount}</span>
                    </button>
                )}

                <Cart
                    isOpen={isCartOpen}
                    onClose={() => setIsCartOpen(false)}
                    cartItems={cart}
                    onUpdateQuantity={handleUpdateQuantity}
                    onRemoveItem={handleRemoveFromCart}
                    onEditItem={handleEditItem}
                    onSubmitOrder={handleSubmitOrder}
                />

                {selectedItem && (
                    <ItemModal
                        selectedItem={selectedItem}
                        editingItem={editingCartItem}
                        addons={addons}
                        onClose={handleCloseModal}
                        onConfirmSelection={handleConfirmSelection}
                    />
                )}
                
                <OrderQueryModal
                    isOpen={isQueryModalOpen}
                    onClose={() => setIsQueryModalOpen(false)}
                />
                
                <AdminDashboard 
                    isOpen={isAdminDashboardOpen}
                    onClose={() => setIsAdminDashboardOpen(false)}
                    onPrintRequest={handlePrintRequest}
                />

                <ConfirmationModal
                    isOpen={!!confirmationData}
                    orderId={confirmationData?.orderId ?? null}
                    lastSuccessfulOrder={confirmationData?.orderData ?? null}
                    onClose={handleCloseConfirmation}
                    onPrintRequest={handlePrintRequest}
                />
            </div>
        </>
    );
};
// END OF App.tsx

// START OF index.tsx
const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
// END OF index.tsx
    </script>
</body>
</html>
