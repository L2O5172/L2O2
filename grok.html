<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>美味廚房點餐系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background: #f8f9fa; }
    .loading { width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #d35400; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-box { background: #ffebee; border: 1px solid #f44336; color: #c62828; padding: 15px; border-radius: 8px; margin: 10px 0; }
    .success-box { background: #e8f5e8; border: 1px solid #4caf50; color: #2e7d32; padding: 15px; border-radius: 8px; margin: 10px 0; }
    .spinner-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center;
      flex-direction: column;
    }
  </style>
</head>
<body>

<!-- 強制 Loading 遮罩 -->
<div id="loadingOverlay" class="spinner-overlay">
  <div class="loading" style="width: 50px; height: 50px;"></div>
  <h4 class="mt-3">連線中...</h4>
  <p class="text-muted">若超過 10 秒，請檢查部署設定</p>
  <button class="btn btn-danger btn-sm" onclick="forceUseFallback()">強制使用內建菜單</button>
</div>

<div class="container mt-4" id="mainApp" style="display: none;">
  <div class="row">
    <div class="col-lg-8">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>菜單</h3>
        <button class="btn btn-outline-primary btn-sm" onclick="loadMenu()">重新載入</button>
      </div>
      <div id="status"></div>
      <div id="categories" class="row g-3"></div>
      <div id="items" class="row g-3 mt-3"></div>
    </div>
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header bg-primary text-white">
          訂單 <span id="cartCount">0</span> 項
          <button class="btn btn-sm btn-outline-light float-end" onclick="clearCart()">清空</button>
        </div>
        <div class="card-body" id="cart"></div>
        <div class="card-footer">
          <h5>總計: <span id="total">$0</span></h5>
          <input type="text" class="form-control mb-2" placeholder="姓名" id="name">
          <button class="btn btn-success w-100" onclick="submitOrder()" id="submitBtn" disabled>送出訂單</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ==================== 請貼上你的新 URL ====================
const SCRIPT_URL = "PASTE_YOUR_NEW_DEPLOY_URL_HERE";  // ← 這裡要換！

// 內建菜單（Fallback）
const FALLBACK_MENU = {
  menu: [
    { title: "牛排", items: [
      { id: "1", name: "海盜牛排 7oz", price: 299, available: true }
    ]}
  ],
  addons: []
};

let menuData = {};
let cart = [];

// 強制使用內建菜單
function forceUseFallback() {
  document.getElementById('loadingOverlay').remove();
  document.getElementById('mainApp').style.display = 'block';
  menuData = FALLBACK_MENU;
  showStatus('使用內建菜單（伺服器未連線）', 'warning');
  renderMenu();
}

// 載入菜單（超時 8 秒）
async function loadMenu() {
  document.getElementById('loadingOverlay').style.display = 'flex';
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 8000);

  try {
    const res = await fetch(`${SCRIPT_URL}?action=getMenu`, { signal: controller.signal });
    const text = await res.text();

    if (text.includes('Sign in') || text.includes('accounts.google.com')) {
      throw new Error('部署未設為「任何人」！請重新部署');
    }

    const data = JSON.parse(text);
    if (!data.menu) throw new Error('資料格式錯誤');

    menuData = data;
    showStatus('菜單載入成功！', 'success');
    renderMenu();
  } catch (err) {
    console.error(err);
    forceUseFallback();
  } finally {
    clearTimeout(timeout);
    document.getElementById('loadingOverlay').style.display = 'none';
  }
}

function showStatus(msg, type) {
  const el = document.getElementById('status');
  el.innerHTML = `<div class="alert alert-${type === 'success' ? 'success' : 'warning'}">${msg}</div>`;
}

function renderMenu() {
  const catDiv = document.getElementById('categories');
  catDiv.innerHTML = menuData.menu.map(cat => `
    <div class="col-md-6">
      <div class="card border-primary" onclick="selectCat('${cat.title}')">
        <div class="card-body text-center">
          <h5>${cat.title}</h5>
        </div>
      </div>
    </div>
  `).join('');
}

function selectCat(title) {
  const cat = menuData.menu.find(c => c.title === title);
  const itemsDiv = document.getElementById('items');
  itemsDiv.innerHTML = cat.items.map(item => `
    <div class="col-md-6">
      <div class="card ${!item.available ? 'opacity-50' : ''}">
        <div class="card-body">
          <h6>${item.name}</h6>
          <p class="text-danger">$${item.price}</p>
          ${item.available ? `<button class="btn btn-sm btn-primary" onclick="addToCart('${item.id}')">加入</button>` : '<span class="text-muted">暫停</span>'}
        </div>
      </div>
    </div>
  `).join('');
}

function addToCart(id) {
  const item = menuData.menu.flatMap(c => c.items).find(i => i.id === id);
  cart.push({ ...item, qty: 1 });
  renderCart();
}

function renderCart() {
  const el = document.getElementById('cart');
  const total = cart.reduce((s, i) => s + i.price * i.qty, 0);
  el.innerHTML = cart.map((c, i) => `
    <div class="d-flex justify-content-between mb-2">
      <span>${c.name} ×${c.qty}</span>
      <span>$${c.price * c.qty} <button class="btn btn-sm btn-danger" onclick="cart.splice(${i},1); renderCart()">×</button></span>
    </div>
  `).join('') || '<p class="text-muted text-center">尚未點餐</p>';
  document.getElementById('total').textContent = `$${total}`;
  document.getElementById('cartCount').textContent = cart.length;
  document.getElementById('submitBtn').disabled = cart.length === 0;
}

function clearCart() { cart = []; renderCart(); }

async function submitOrder() {
  const name = document.getElementById('name').value.trim();
  if (!name || cart.length === 0) return alert('請填姓名並點餐');

  try {
    await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'createOrder', orderData: { name, items: cart } })
    });
    alert('訂單送出成功！');
    cart = []; renderCart(); document.getElementById('name').value = '';
  } catch { alert('送出失敗（離線模式）'); }
}

// 啟動
setTimeout(loadMenu, 100);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
