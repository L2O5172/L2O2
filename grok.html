<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç¾å‘³å»šæˆ¿é»é¤ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #d35400;
      --success: #27ae60;
      --warning: #f39c12;
      --info: #3498db;
      --dark: #2c3e50;
    }
    body { 
      font-family: 'Noto Sans TC', sans-serif; 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    .category-card { 
      cursor: pointer; 
      transition: all 0.3s; 
      border: 2px solid transparent; 
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .category-card:hover { 
      transform: translateY(-5px); 
      box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
      border-color: var(--primary);
    }
    .category-card.selected { 
      border-color: var(--primary); 
      background: #fff5f0; 
      box-shadow: 0 8px 25px rgba(211, 84, 0, 0.2);
    }
    .item-card { 
      border: 1px solid #eee; 
      border-radius: 12px; 
      transition: all 0.2s; 
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .item-card:hover { 
      border-color: var(--primary); 
      box-shadow: 0 4px 12px rgba(211, 84, 0, 0.15);
    }
    .badge-available { 
      background: var(--success); 
      color: white;
    }
    .badge-unavailable { 
      background: #95a5a6; 
      color: white;
    }
    .order-item { 
      background: #f8f9fa; 
      border-left: 4px solid var(--primary); 
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .status-ç¢ºèªä¸­ { 
      background: #e3f2fd !important; 
      color: #1976d2 !important; 
    }
    .status-è£½ä½œä¸­ { 
      background: #fff3cd !important; 
      color: #856404 !important; 
    }
    .status-å¯ä»¥å–é¤ { 
      background: #d4edda !important; 
      color: #155724 !important; 
    }
    .status-å·²å®Œæˆ { 
      background: #f8d7da !important; 
      color: #721c24 !important; 
      text-decoration: line-through; 
    }
    .nav-tabs .nav-link.active { 
      background: var(--primary) !important; 
      color: white !important; 
      border-color: var(--primary);
    }
    .nav-tabs .nav-link { 
      color: var(--dark);
    }
    .kitchen-card { 
      border-left: 5px solid var(--primary); 
      border-radius: 8px;
      margin-bottom: 15px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .print-btn { 
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      z-index: 999; 
      width: 60px; 
      height: 60px; 
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .loading { 
      display: inline-block; 
      width: 20px; 
      height: 20px; 
      border: 3px solid #f3f3f3; 
      border-top: 3px solid var(--primary); 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-alert {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
    }
    .success-alert {
      background: #efe;
      border: 1px solid #cfc;
      color: #060;
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
    }
    @media print {
      .no-print, .print-btn, .nav-tabs { display: none !important; }
      body { background: white !important; }
      .kitchen-card { box-shadow: none; }
    }
    .modal-header {
      background: var(--primary);
      color: white;
      border-radius: 8px 8px 0 0;
    }
    .modal-content {
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

<!-- å°è¦½åˆ— -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top no-print">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold text-primary" href="#">
      <i class="bi bi-utensils"></i> ç¾å‘³å»šæˆ¿
    </a>
    <ul class="navbar-nav me-auto">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#order-tab">é»é¤ç³»çµ±</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#kitchen-tab">å»šæˆ¿ç®¡ç†</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#stats-tab">éŠ·å”®çµ±è¨ˆ</a>
      </li>
    </ul>
    <button class="btn btn-outline-primary btn-sm" onclick="refreshAll()">
      <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
    </button>
  </div>
</nav>

<div class="container-fluid mt-4">
  <div class="tab-content">

    <!-- ==================== é»é¤é  ==================== -->
    <div class="tab-pane fade show active" id="order-tab">
      <div class="row">
        <div class="col-lg-8">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0"><i class="bi bi-list-ul"></i> èœå–®é¡åˆ¥</h4>
            <button class="btn btn-outline-secondary btn-sm" onclick="loadMenuFromAPI()">
              <i class="bi bi-cloud-download"></i> å¾ä¼ºæœå™¨è¼‰å…¥
            </button>
          </div>
          
          <!-- API éŒ¯èª¤æç¤º -->
          <div id="apiError" class="alert alert-warning d-none" role="alert">
            <i class="bi bi-exclamation-triangle"></i> 
            <strong>ä¼ºæœå™¨é€£æ¥å¤±æ•—</strong>ï¼šä½¿ç”¨å…§å»ºèœå–®è³‡æ–™ç¹¼çºŒé‹è¡Œã€‚
            <button type="button" class="btn-close" onclick="this.parentElement.classList.add('d-none')"></button>
          </div>

          <div id="categories" class="row g-3 mb-4"></div>

          <div id="menuItems" class="row g-3">
            <div class="col-12">
              <div class="text-center py-5">
                <div class="loading mx-auto mb-2"></div>
                <p class="text-muted">è«‹é¸æ“‡é¡åˆ¥æˆ–é»æ“Šä¸Šæ–¹æŒ‰éˆ•è¼‰å…¥èœå–®</p>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card sticky-top" style="top: 100px; z-index: 10;">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
              <span><i class="bi bi-cart"></i> è¨‚å–®æ˜ç´° (<span id="cartCount">0</span>)</span>
              <button class="btn btn-outline-light btn-sm" onclick="clearCart()">
                <i class="bi bi-trash"></i> æ¸…ç©º
              </button>
            </div>
            <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;" id="cartItems"></div>
            <div class="card-footer bg-light">
              <div class="d-flex justify-content-between mb-3 fs-5 fw-bold">
                <span>ç¸½è¨ˆ</span>
                <span class="text-danger" id="totalAmount">$0</span>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">ç”¨é¤æ–¹å¼</label>
                <select class="form-select" id="orderType">
                  <option value="å…§ç”¨">ğŸ½ï¸ å…§ç”¨</option>
                  <option value="å¤–å¸¶">ğŸ“¦ å¤–å¸¶</option>
                </select>
              </div>
              <div id="dineInFields" class="mb-3">
                <label class="form-label">æ¡Œè™Ÿ (é¸å¡«)</label>
                <input type="text" class="form-control" id="tableNumber" placeholder="ä¾‹å¦‚: A1"/>
              </div>
              <div class="mb-3">
                <label class="form-label">ğŸ‘¤ å§“å <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="customerName" placeholder="å¿…å¡«"/>
              </div>
              <div class="mb-3">
                <label class="form-label">ğŸ“± é›»è©± (é¸å¡«)</label>
                <input type="tel" class="form-control" id="customerPhone" placeholder="09xxxxxxxx"/>
              </div>
              <button class="btn btn-success w-100 fw-bold py-3" onclick="submitOrder()" id="submitBtn" disabled>
                <i class="bi bi-check-circle"></i> é€å‡ºè¨‚å–®
              </button>
              <div id="orderSuccess" class="alert success-alert d-none mt-3" role="alert"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== å»šæˆ¿ç®¡ç†é  ==================== -->
    <div class="tab-pane fade" id="kitchen-tab">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4><i class="bi bi-fire"></i> å»šæˆ¿å·¥å–®</h4>
        <div class="btn-group" role="group">
          <button class="btn btn-outline-primary btn-sm" onclick="refreshKitchen()">
            <i class="bi bi-arrow-clockwise"></i> å³æ™‚åˆ·æ–°
          </button>
          <button class="btn btn-outline-danger btn-sm" onclick="printKitchen()">
            <i class="bi bi-printer"></i> åˆ—å°å·¥å–®
          </button>
        </div>
      </div>
      <div id="kitchenOrders" class="row g-4">
        <div class="col-12">
          <div class="text-center py-5">
            <div class="loading mx-auto mb-2" style="width: 40px; height: 40px;"></div>
            <p class="text-muted">è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== éŠ·å”®çµ±è¨ˆé  ==================== -->
    <div class="tab-pane fade" id="stats-tab">
      <div class="row mb-4">
        <div class="col-md-3 mb-3">
          <div class="card text-center border-0 shadow-sm h-100">
            <div class="card-body">
              <h5 class="card-title text-muted">ä»Šæ—¥ç‡Ÿæ”¶</h5>
              <h3 class="text-success fw-bold" id="todayRevenue">$0</h3>
              <small class="text-success"><i class="bi bi-arrow-up"></i> å³æ™‚</small>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card text-center border-0 shadow-sm h-100">
            <div class="card-body">
              <h5 class="card-title text-muted">æœ¬æœˆç‡Ÿæ”¶</h5>
              <h3 class="text-info fw-bold" id="monthRevenue">$0</h3>
              <small class="text-info"><i class="bi bi-calendar"></i> æœ¬æœˆ</small>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card text-center border-0 shadow-sm h-100">
            <div class="card-body">
              <h5 class="card-title text-muted">ç¸½è¨‚å–®æ•¸</h5>
              <h3 class="text-primary fw-bold" id="totalOrders">0</h3>
              <small class="text-primary"><i class="bi bi-receipt"></i> æ­·å²</small>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card text-center border-0 shadow-sm h-100">
            <div class="card-body">
              <h5 class="card-title text-muted">ç†±éŠ·å–®å“</h5>
              <h3 class="text-warning fw-bold" id="topItem">è¼‰å…¥ä¸­...</h3>
              <small class="text-warning"><i class="bi bi-trophy"></i> TOP1</small>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-md-6">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="bi bi-graph-up"></i> æ¯æ—¥ç‡Ÿæ”¶è¶¨å‹¢</h6>
            </div>
            <div class="card-body p-0">
              <canvas id="dailyChart" height="200"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="bi bi-pie-chart"></i> ç†±éŠ·å“é … TOP 8</h6>
            </div>
            <div class="card-body p-0">
              <canvas id="topItemsChart" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- åˆ—å°æŒ‰éˆ• (å›ºå®š) -->
<button class="btn btn-primary print-btn no-print shadow-lg" onclick="window.print()" title="å¿«é€Ÿåˆ—å°">
  <i class="bi bi-printer fs-4"></i>
</button>

<script>
// ==================== å…¨åŸŸè®Šæ•¸ ====================
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzMAk3nYwDvX-oEUA2Juz8HfLlN6ykcp-1Jow9gyr5ffw5xBmEDO9Lv5_Mi6xXq16Z2Ig/exec";
let menuData = { menu: [], addons: [] };
let cart = [];
let dailyChart = null;
let topItemsChart = null;
let isUsingFallback = false;

// ==================== å…§å»ºèœå–®è³‡æ–™ (Fallback) ====================
const FALLBACK_MENU = {
  menu: [
    {
      title: "å¥—é¤",
      description: "é™„: â‘ æ—¥æ¹¯ â‘¡éºµåŒ… â‘¢ä¸»é¤ â‘£è„†è–¯ â‘¤é£²æ–™",
      items: [
        { id: 'set-1', name: 'é¦™ç…æµ·ç›œç‰›æ’å¥—é¤', weight: '7oz', price: 299, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
        { id: 'set-2', name: 'é¦™ç…æµ·ç›œç‰›æ’å¥—é¤', weight: '14oz', price: 399, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
        { id: 'set-3', name: 'é¦™ç…æµ·ç›œç‰›æ’å¥—é¤', weight: '21oz', price: 499, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
        { id: 'set-4', name: 'é¦™ç…ç‰¹é¸æ¿è…±å¥—é¤', weight: '10oz', price: 399, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
        { id: 'set-5', name: 'é¦™ç…è€é¥•ä¸Šè“‹å¥—é¤', weight: '7oz', price: 399, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
        { id: 'set-6', name: 'é¦™ç…ç´è²åŠ›å¥—é¤', weight: '7oz', price: 499, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
        { id: 'set-7', name: 'é¦™ç…æ«»æ¡ƒé´¨èƒ¸å¥—é¤', weight: '10oz', price: 320, customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
        { id: 'set-8', name: 'é¦™ç…é®®å«©é±¸é­šå¥—é¤', weight: '10oz', price: 320, customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
        { id: 'set-9', name: 'é¦™ç…é®®å«©é›è…¿å¥—é¤', weight: '10oz', price: 250, customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
        { id: 'set-10', name: 'é¦™ç…ç¾å‘³è±¬æ’å¥—é¤', weight: '10oz', price: 299, customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
        { id: 'set-11', name: 'è‹±å¼ç‚¸é­šå¥—é¤', weight: '10oz', price: 250, customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
        { id: 'set-12', name: 'æ—¥å¼è±¬æ’å¥—é¤', weight: '10oz', price: 250, customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: false },
      ]
    },
    {
      title: "çµ„åˆé¤",
      description: "é™„: â‘ æ—¥æ¹¯ â‘¡éºµåŒ… â‘¢ä¸»é¤ â‘£è„†è–¯ â‘¤æ²™æ‹‰ â‘¥é£²æ–™",
      items: [
        { id: 'combo-1', name: 'æ—¥è±¬ã€é›è…¿ã€ä¸Šè“‹çµ„åˆé¤', weight: '15oz', price: 529, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
        { id: 'combo-2', name: 'ç‚¸é­šã€é›è…¿ã€æ¿è…±çµ„åˆé¤', weight: '15oz', price: 529, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
        { id: 'combo-3', name: 'é±¸é­šã€é´¨èƒ¸ã€è±¬æ’çµ„åˆé¤', weight: '15oz', price: 529, customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
        { id: 'combo-4', name: 'é´¨èƒ¸ã€é±¸é­šã€ä¸Šè“‹çµ„åˆé¤', weight: '15oz', price: 599, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
        { id: 'combo-5', name: 'Nè²ã€ä¸Šè“‹ã€æ¿è…±çµ„åˆé¤', weight: '15oz', price: 699, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
      ]
    }
  ],
  addons: [
    { id: 'addon-pirate-steak-5oz', name: 'æµ·ç›œç‰›æ’ 5oz åŠ è³¼', price: 200, category: 'ä¸»é¤åŠ è³¼', isAvailable: true },
    { id: 'addon-top-blade-5oz', name: 'ç‰¹é¸æ¿è…± 5oz åŠ è³¼', price: 200, category: 'ä¸»é¤åŠ è³¼', isAvailable: true },
    { id: 'addon-ribeye-cap-5oz', name: 'è€é¥•ä¸Šè“‹ 5oz åŠ è³¼', price: 200, category: 'ä¸»é¤åŠ è³¼', isAvailable: true },
    { id: 'addon-filet-mignon-5oz', name: 'ç´è²åŠ› 5oz åŠ è³¼', price: 250, category: 'ä¸»é¤åŠ è³¼', isAvailable: true },
    { id: 'addon-duck-breast', name: 'æ«»æ¡ƒé´¨èƒ¸ åŠ è³¼', price: 150, category: 'ä¸»é¤åŠ è³¼', isAvailable: true },
    { id: 'addon-sea-bass', name: 'é®®å«©é±¸é­š åŠ è³¼', price: 150, category: 'ä¸»é¤åŠ è³¼', isAvailable: true },
    { id: 'addon-chicken-leg', name: 'é®®å«©é›è…¿ åŠ è³¼', price: 120, category: 'ä¸»é¤åŠ è³¼', isAvailable: true },
    { id: 'addon-pork-chop', name: 'ç¾å‘³è±¬æ’ åŠ è³¼', price: 120, category: 'ä¸»é¤åŠ è³¼', isAvailable: true },
    { id: 'addon-fried-fish', name: 'è‹±å¼ç‚¸é­š åŠ è³¼', price: 120, category: 'ä¸»é¤åŠ è³¼', isAvailable: true },
    { id: 'addon-jp-pork-cutlet', name: 'æ—¥å¼è±¬æ’ åŠ è³¼', price: 120, category: 'ä¸»é¤åŠ è³¼', isAvailable: false },
    { id: 'addon-dessert', name: 'æ˜¯æ—¥ç”œå“ åŠ è³¼', price: 30, category: 'å…¶ä»–åŠ è³¼', isAvailable: true },
  ]
};

// ==================== åˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', () => {
  loadMenuFromAPI();
  setupOrderType();
  refreshKitchen();
  loadStats();
  setInterval(refreshKitchen, 10000);
  setInterval(loadStats, 30000);
});

// ==================== è¼‰å…¥èœå–® (ä¿®å¾©ç‰ˆ) ====================
async function loadMenuFromAPI() {
  try {
    const response = await fetch(`${SCRIPT_URL}?action=getMenu`, {
      method: 'GET',
      mode: 'cors',
      cache: 'no-cache',
      credentials: 'omit', // é¿å… CORS èˆ‡ç™»å…¥å•é¡Œ
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const text = await response.text();
    let data;
    
    try {
      data = JSON.parse(text);
    } catch (parseErr) {
      console.error('JSON è§£æå¤±æ•—:', parseErr);
      console.error('å›æ‡‰å…§å®¹:', text.substring(0, 200));
      throw new Error('ä¼ºæœå™¨å›æ‡‰éæœ‰æ•ˆ JSON (å¯èƒ½éœ€é‡æ–°éƒ¨ç½² Web App ç‚º "ä»»ä½•äºº")');
    }
    
    if (data.success !== true || !data.menu || !data.addons) {
      throw new Error(data.message || 'ä¼ºæœå™¨å›æ‡‰ç„¡æ•ˆèœå–®è³‡æ–™');
    }
    
    menuData = data;
    isUsingFallback = false;
    document.getElementById('apiError').classList.add('d-none');
    
  } catch (error) {
    console.error('è¼‰å…¥èœå–®å¤±æ•—:', error);
    menuData = FALLBACK_MENU;
    isUsingFallback = true;
    showApiError(error.message);
  } finally {
    renderCategories();
    updateMenuUI();
  }
}

function showApiError(msg) {
  const alert = document.getElementById('apiError');
  alert.querySelector('strong').textContent = `ä¼ºæœå™¨é€£æ¥å¤±æ•—ï¼š${msg}`;
  alert.classList.remove('d-none');
}

function updateMenuUI() {
  const itemsDiv = document.getElementById('menuItems').querySelector('.text-center');
  if (isUsingFallback) {
    itemsDiv.innerHTML = `
      <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> ä½¿ç”¨å…§å»ºèœå–® (ä¼ºæœå™¨æš«æ™‚ç„¡æ³•é€£æ¥)
      </div>
    `;
  } else {
    itemsDiv.remove();
  }
}

// åˆ‡æ›å…§ç”¨/å¤–å¸¶
function setupOrderType() {
  const orderType = document.getElementById('orderType');
  const dineInFields = document.getElementById('dineInFields');
  orderType.addEventListener('change', () => {
    dineInFields.style.display = orderType.value === 'å…§ç”¨' ? 'block' : 'none';
  });
}

function renderCategories() {
  const container = document.getElementById('categories');
  container.innerHTML = menuData.menu.map(cat => `
    <div class="col-md-6 col-lg-4">
      <div class="card category-card text-center p-4 h-100" onclick="selectCategory('${cat.title.replace(/'/g, "\\'")}')">
        <div class="card-body">
          <h5 class="card-title fw-bold text-primary mb-2">${cat.title}</h5>
          <p class="card-text text-muted small mb-0">${cat.description}</p>
          <div class="mt-3">
            <span class="badge bg-success">${cat.items.filter(i => i.isAvailable).length} é …å¯ç”¨</span>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

function selectCategory(title) {
  document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
  event.target.closest('.category-card').classList.add('selected');
  const cat = menuData.menu.find(c => c.title === title);
  renderItems(cat.items);
}

function renderItems(items) {
  const container = document.getElementById('menuItems');
  container.innerHTML = items.map(item => {
    const available = item.isAvailable;
    const badges = [];
    if (item.customizations.doneness) badges.push('<span class="badge bg-danger me-1">ç‰›æ’</span>');
    if (item.customizations.sauceChoice) badges.push('<span class="badge bg-info me-1">é†¬æ–™</span>');
    if (item.customizations.drinkChoice) badges.push('<span class="badge bg-warning me-1">é£²æ–™</span>');
    
    return `
      <div class="col-md-6 col-lg-4">
        <div class="card item-card h-100 ${!available ? 'opacity-50' : ''}" ${available ? `onclick="openItemModal('${item.id}')" style="cursor: pointer;"` : 'title="æš«åœä¾›æ‡‰"'}>
          <div class="card-body d-flex flex-column">
            <h6 class="card-title fw-bold mb-2">${item.name}</h6>
            <p class="text-muted small mb-2">${item.weight}</p>
            ${badges.length ? `<div class="mb-2 small">${badges.join('')}</div>` : ''}
            <div class="mt-auto d-flex justify-content-between align-items-end">
              <span class="badge fs-6 ${available ? 'badge-available' : 'badge-unavailable'}">
                ${available ? 'âœ… å¯é»' : 'âŒ æš«åœ'}
              </span>
              <h5 class="text-danger mb-0 fw-bold">$${item.price}</h5>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// ==================== é»é¤æ¨¡æ…‹æ¡† ====================
function openItemModal(itemId) {
  const item = menuData.menu.flatMap(c => c.items).find(i => i.id === itemId);
  if (!item) return alert('èœå–®é …ç›®æœªæ‰¾åˆ°');

  const modal = new bootstrap.Modal(document.createElement('div'));
  const donenessOptions = item.customizations.doneness ? `
    <div class="mb-3">
      <label class="form-label fw-bold">ğŸ¥© ç‰›æ’ç†Ÿåº¦ <span class="text-danger">*</span></label>
      <div class="row g-2">
        ${['3åˆ†ç†Ÿ', '5åˆ†ç†Ÿ', '7åˆ†ç†Ÿ', 'å…¨ç†Ÿ'].map(d => `
          <div class="col-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">${d}</span>
              <input type="number" class="form-control" id="doneness-${d.replace(/ /g, '-')}" min="0" value="0" placeholder="ä»½æ•¸">
            </div>
          </div>
        `).join('')}
      </div>
      <small class="text-muted">ç¸½ä»½æ•¸éœ€ç­‰æ–¼è¨‚è³¼æ•¸é‡</small>
    </div>` : '';

  const sauceOptions = item.customizations.sauceChoice ? `
    <div class="mb-3">
      <label class="form-label fw-bold">ğŸ¥« æ²¾é†¬é¸æ“‡</label>
      <select class="form-select" id="sauceSelect" multiple size="4">
        ${['å·´é†‹', 'æ©™æ±', 'æ¤’é¹½', 'èŠ¥æœ«', 'æ³¡èœ', 'BBQé†¬', 'é»‘èƒ¡æ¤’', 'è’œå‘³é†¬'].map(s => `<option value="${s}">${s}</option>`).join('')}
      </select>
      <small class="text-muted">å¯è¤‡é¸ï¼Œæ¯ä»½é¤é»é™ 2 ç¨®</small>
    </div>` : '';

  const drinkOptions = item.customizations.drinkChoice ? `
    <div class="mb-3">
      <label class="form-label fw-bold">ğŸ¥¤ é£²æ–™é¸æ“‡ <span class="text-danger">*</span></label>
      <div class="row g-2" id="drinkInputs"></div>
      <small class="text-muted">ç¸½ä»½æ•¸éœ€ç­‰æ–¼è¨‚è³¼æ•¸é‡</small>
    </div>` : '';

  const addonOptions = menuData.addons.filter(a => a.isAvailable).length > 0 ? `
    <div class="mb-3">
      <label class="form-label fw-bold">â• åŠ è³¼é …ç›®</label>
      <div class="list-group list-group-flush" id="addonList" style="max-height: 200px; overflow-y: auto;"></div>
    </div>` : '';

  const notesOption = item.customizations.notes ? `
    <div class="mb-3">
      <label class="form-label fw-bold">ğŸ“ ç‰¹æ®Šå‚™è¨»</label>
      <textarea class="form-control" id="itemNotes" rows="2" placeholder="ä¾‹å¦‚ï¼šä¸è¦è”¥ã€å°‘é¹½ã€éæ•è³‡è¨Š..."></textarea>
    </div>` : '';

  const modalHTML = `
    <div class="modal fade" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-plus-circle"></i> ${item.name} ${item.weight}</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="text-center mb-4 p-3 bg-light rounded">
              <h4 class="text-danger mb-1">$${item.price}</h4>
              <small class="text-muted">å–®åƒ¹</small>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">ğŸ“Š è¨‚è³¼æ•¸é‡</label>
              <div class="input-group">
                <button class="btn btn-outline-secondary" onclick="this.nextElementSibling.stepDown()">âˆ’</button>
                <input type="number" class="form-control text-center fw-bold fs-4" id="itemQty" value="1" min="1" style="max-width: 80px;">
                <button class="btn btn-outline-secondary" onclick="this.previousElementSibling.stepUp()">+</button>
              </div>
            </div>
            ${donenessOptions}
            ${sauceOptions}
            ${drinkOptions}
            ${notesOption}
            ${addonOptions}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" onclick="addToCart('${item.id}', this.closest('.modal')._modal)">
              <i class="bi bi-cart-plus"></i> åŠ å…¥è³¼ç‰©è»Š
            </button>
          </div>
        </div>
      </div>
    </div>`;

  document.body.insertAdjacentHTML('beforeend', modalHTML);
  const modalEl = document.body.lastElementChild;
  const bsModal = new bootstrap.Modal(modalEl);
  modalEl._modal = bsModal;
  bsModal.show();

  // åˆå§‹åŒ–é£²æ–™
  if (item.customizations.drinkChoice) {
    const drinks = ['ç„¡ç³–ç´…èŒ¶', 'å†°æ¶¼å¯æ¨‚'];
    document.getElementById('drinkInputs').innerHTML = drinks.map(d => `
      <div class="col-6">
        <div class="input-group input-group-sm">
          <span class="input-group-text">${d}</span>
          <input type="number" class="form-control" id="drink-${d.replace(/ /g, '-')}" min="0" value="0" placeholder="ä»½æ•¸">
        </div>
      </div>
    `).join('');
  }

  // åˆå§‹åŒ–åŠ è³¼
  if (menuData.addons.filter(a => a.isAvailable).length > 0) {
    const addonList = document.getElementById('addonList');
    addonList.innerHTML = menuData.addons.filter(a => a.isAvailable).map(a => `
      <div class="list-group-item px-3 py-2">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="addon-${a.id}">
          <label class="form-check-label d-flex justify-content-between w-100" for="addon-${a.id}">
            <span>${a.name}</span>
            <span class="text-success fw-bold">+$${a.price}</span>
          </label>
        </div>
      </div>
    `).join('');
  }
}

// ==================== åŠ å…¥è³¼ç‰©è»Š ====================
function addToCart(itemId, modalInstance) {
  const item = menuData.menu.flatMap(c => c.items).find(i => i.id === itemId);
  const qty = parseInt(document.getElementById('itemQty').value) || 1;

  // é©—è­‰å¿…å¡«é …ç›®
  if (item.customizations.doneness) {
    const totalDoneness = ['3åˆ†ç†Ÿ', '5åˆ†ç†Ÿ', '7åˆ†ç†Ÿ', 'å…¨ç†Ÿ'].reduce((sum, d) => sum + (parseInt(document.getElementById(`doneness-${d.replace(/ /g, '-')}`)?.value || 0), 0);
    if (totalDoneness !== qty) {
      alert(`è«‹ç¢ºä¿ç†Ÿåº¦ç¸½ä»½æ•¸ = ${qty} ä»½`);
      return;
    }
  }
  if (item.customizations.drinkChoice) {
    const totalDrinks = ['ç„¡ç³–ç´…èŒ¶', 'å†°æ¶¼å¯æ¨‚'].reduce((sum, d) => sum + (parseInt(document.getElementById(`drink-${d.replace(/ /g, '-')}`)?.value || 0), 0);
    if (totalDrinks !== qty) {
      alert(`è«‹ç¢ºä¿é£²æ–™ç¸½ä»½æ•¸ = ${qty} ä»½`);
      return;
    }
  }

  const cartItem = {
    item, 
    quantity: qty,
    selectedDonenesses: {},
    selectedDrinks: {},
    selectedSauces: [],
    selectedAddons: [],
    selectedNotes: document.getElementById('itemNotes')?.value.trim() || ''
  };

  // æ”¶é›†é¸é …
  if (item.customizations.doneness) {
    ['3åˆ†ç†Ÿ', '5åˆ†ç†Ÿ', '7åˆ†ç†Ÿ', 'å…¨ç†Ÿ'].forEach(d => {
      const val = parseInt(document.getElementById(`doneness-${d.replace(/ /g, '-')}`)?.value || 0);
      if (val > 0) cartItem.selectedDonenesses[d] = val;
    });
  }
  if (item.customizations.drinkChoice) {
    ['ç„¡ç³–ç´…èŒ¶', 'å†°æ¶¼å¯æ¨‚'].forEach(d => {
      const val = parseInt(document.getElementById(`drink-${d.replace(/ /g, '-')}`)?.value || 0);
      if (val > 0) cartItem.selectedDrinks[d] = val;
    });
  }
  if (item.customizations.sauceChoice) {
    const select = document.getElementById('sauceSelect');
    cartItem.selectedSauces = Array.from(select.selectedOptions).map(o => ({ name: o.value, quantity: 1 }));
  }
  menuData.addons.forEach(a => {
    const chk = document.getElementById(`addon-${a.id}`);
    if (chk && chk.checked) {
      cartItem.selectedAddons.push({ ...a, quantity: 1 });
    }
  });

  // åˆä½µç›¸åŒé …ç›®
  const existingIndex = cart.findIndex(c => 
    c.item.id === itemId &&
    JSON.stringify(c.selectedDonenesses) === JSON.stringify(cartItem.selectedDonenesses) &&
    JSON.stringify(c.selectedDrinks) === JSON.stringify(cartItem.selectedDrinks) &&
    JSON.stringify(c.selectedSauces) === JSON.stringify(cartItem.selectedSauces) &&
    c.selectedNotes === cartItem.selectedNotes
  );
  
  if (existingIndex > -1) {
    cart[existingIndex].quantity += qty;
  } else {
    cart.push(cartItem);
  }

  renderCart();
  modalInstance.hide();
  setTimeout(() => modalInstance.remove(), 300);
  showSuccess('å·²åŠ å…¥è³¼ç‰©è»Šï¼');
}

// ==================== æ¸²æŸ“è³¼ç‰©è»Š ====================
function renderCart() {
  const container = document.getElementById('cartItems');
  const countEl = document.getElementById('cartCount');
  let total = 0;

  if (cart.length === 0) {
    container.innerHTML = '<div class="text-center py-4"><i class="bi bi-cart-x fs-1 text-muted"></i><p class="text-muted mt-2">å°šæœªé¸è³¼å•†å“</p></div>';
    countEl.textContent = '0';
    document.getElementById('totalAmount').textContent = '$0';
    document.getElementById('submitBtn').disabled = true;
    return;
  }

  countEl.textContent = cart.reduce((sum, c) => sum + c.quantity, 0);
  container.innerHTML = cart.map((cItem, idx) => {
    const itemTotal = cItem.item.price * cItem.quantity + cItem.selectedAddons.reduce((sum, a) => sum + a.price * a.quantity, 0);
    total += itemTotal;

    let details = [];
    if (Object.keys(cItem.selectedDonenesses).length) details.push(`ç†Ÿåº¦: ${Object.entries(cItem.selectedDonenesses).map(([d,q]) => `${d}Ã—${q}`).join(', ')}`);
    if (Object.keys(cItem.selectedDrinks).length) details.push(`é£²æ–™: ${Object.entries(cItem.selectedDrinks).map(([d,q]) => `${d}Ã—${q}`).join(', ')}`);
    if (cItem.selectedSauces.length) details.push(`é†¬æ–™: ${cItem.selectedSauces.map(s => s.name).join(', ')}`);
    if (cItem.selectedAddons.length) details.push(`åŠ è³¼: ${cItem.selectedAddons.map(a => a.name).join(', ')}`);
    if (cItem.selectedNotes) details.push(`å‚™è¨»: ${cItem.selectedNotes}`);

    return `
      <div class="order-item p-3">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div class="flex-grow-1">
            <strong class="d-block mb-1">${cItem.item.name} Ã—${cItem.quantity}</strong>
            ${details.length ? `<small class="text-muted d-block">${details.join(' | ')}</small>` : ''}
          </div>
          <div class="text-end ms-2">
            <div class="fw-bold text-danger fs-5">$${itemTotal}</div>
            <button class="btn btn-sm btn-outline-danger mt-1" onclick="removeFromCart(${idx})">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('totalAmount').textContent = `$${total.toLocaleString()}`;
  document.getElementById('submitBtn').disabled = false;
}

function removeFromCart(idx) {
  if (confirm('ç¢ºå®šç§»é™¤æ­¤é …ç›®ï¼Ÿ')) {
    cart.splice(idx, 1);
    renderCart();
  }
}

function clearCart() {
  if (confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³¼ç‰©è»Šé …ç›®ï¼Ÿ')) {
    cart = [];
    renderCart();
  }
}

function showSuccess(msg) {
  const alert = document.getElementById('orderSuccess');
  alert.textContent = msg;
  alert.classList.remove('d-none');
  setTimeout(() => alert.classList.add('d-none'), 3000);
}

// ==================== é€å‡ºè¨‚å–® ====================
async function submitOrder() {
  const name = document.getElementById('customerName').value.trim();
  if (!name) {
    alert('è«‹å¡«å¯«å§“åï¼');
    document.getElementById('customerName').focus();
    return;
  }
  if (cart.length === 0) {
    alert('è³¼ç‰©è»Šç‚ºç©ºï¼');
    return;
  }

  const totalAmount = cart.reduce((sum, c) => sum + (c.item.price * c.quantity + c.selectedAddons.reduce((aSum, a) => aSum + a.price * a.quantity, 0)), 0);

  const orderData = {
    customerName: name,
    customerPhone: document.getElementById('customerPhone').value.trim(),
    tableNumber: document.getElementById('orderType').value === 'å…§ç”¨' ? document.getElementById('tableNumber').value.trim() : '',
    orderType: document.getElementById('orderType').value,
    items: cart,
    totalAmount: totalAmount
  };

  try {
    document.getElementById('submitBtn').innerHTML = '<span class="loading me-2"></span>é€å‡ºä¸­...';
    document.getElementById('submitBtn').disabled = true;

    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      mode: 'cors',
      cache: 'no-cache',
      credentials: 'omit',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: 'createOrder', orderData })
    });

    if (!response.ok) throw new Error(`HTTP ${response.status}`);

    const text = await response.text();
    let result;
    try {
      result = JSON.parse(text);
    } catch {
      throw new Error('ä¼ºæœå™¨å›æ‡‰ç„¡æ•ˆ (æª¢æŸ¥éƒ¨ç½²è¨­å®š)');
    }

    if (result.success && result.orderId) {
      showSuccess(`è¨‚å–®é€å‡ºæˆåŠŸï¼ç·¨è™Ÿï¼š${result.orderId}`);
      cart = [];
      renderCart();
      document.getElementById('customerName').value = '';
      document.getElementById('customerPhone').value = '';
      document.getElementById('tableNumber').value = '';
      refreshKitchen();
    } else {
      throw new Error(result.message || 'æœªçŸ¥éŒ¯èª¤');
    }
  } catch (error) {
    console.error('è¨‚å–®é€å‡ºå¤±æ•—:', error);
    alert(`é€å‡ºå¤±æ•—ï¼š${error.message}\n\næç¤ºï¼šè«‹ç¢ºèª Google Apps Script å·²éƒ¨ç½²ç‚ºã€Œä»»ä½•äººã€å­˜å–ï¼Œä¸¦æª¢æŸ¥ Code.gs ä¸­çš„ doPost å‡½å¼ã€‚`);
  } finally {
    document.getElementById('submitBtn').innerHTML = '<i class="bi bi-check-circle"></i> é€å‡ºè¨‚å–®';
    document.getElementById('submitBtn').disabled = cart.length === 0;
  }
}

// ==================== å»šæˆ¿ç®¡ç† ====================
async function refreshKitchen() {
  try {
    const response = await fetch(`${SCRIPT_URL}?action=getAllOrders`, { 
      method: 'GET', 
      mode: 'cors', 
      credentials: 'omit' 
    });
    const text = await response.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch {
      throw new Error('å›æ‡‰ç„¡æ•ˆ');
    }
    if (!data.success) throw new Error(data.message || 'ç„¡è³‡æ–™');

    const container = document.getElementById('kitchenOrders');
    const pendingOrders = data.orders.filter(o => o.status !== 'å·²å®Œæˆ').sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    if (pendingOrders.length === 0) {
      container.innerHTML = '<div class="col-12"><div class="alert alert-success text-center"><i class="bi bi-check-circle fs-1 mb-3 d-block"></i><h5>ğŸ‰ æš«ç„¡å¾…è™•ç†è¨‚å–®</h5><p class="text-muted">å»šæˆ¿ä¼‘æ¯æ™‚é–“ï½</p></div></div>';
      return;
    }

    container.innerHTML = pendingOrders.map(order => {
      const statusMap = { 'ç¢ºèªä¸­': 'info', 'è£½ä½œä¸­': 'warning', 'å¯ä»¥å–é¤': 'success', 'å·²å®Œæˆ': 'secondary' };
      const statusClass = `status-${order.status}`;
      const badgeClass = `bg-${statusMap[order.status] || 'secondary'}`;
      
      return `
        <div class="col-md-6 col-lg-4">
          <div class="card kitchen-card ${statusClass}">
            <div class="card-header d-flex justify-content-between align-items-center bg-light">
              <strong class="text-primary">#${order.id}</strong>
              <span class="badge ${badgeClass} fs-6">${order.status}</span>
            </div>
            <div class="card-body">
              <div class="mb-2"><strong>ğŸ‘¤ ${order.customerName}</strong> ${order.customerPhone ? `(${order.customerPhone})` : ''}</div>
              <div class="mb-2"><i class="bi bi-clock"></i> ${new Date(order.timestamp).toLocaleString('zh-TW')}</div>
              <div class="mb-3">
                <span class="badge bg-${order.orderType === 'å…§ç”¨' ? 'info' : 'warning'} me-1">${order.orderType}</span>
                ${order.tableNumber ? `<span class="badge bg-secondary">æ¡Œ ${order.tableNumber}</span>` : ''}
              </div>
              <hr class="my-2">
              <div class="mb-0">
                ${order.items.map(it => `
                  <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <span class="flex-grow-1">${it.name} Ã—${it.quantity}</span>
                    ${it.details ? `<small class="text-muted d-block w-100 text-truncate" title="${it.details}">${it.details}</small>` : ''}
                  </div>
                `).join('')}
              </div>
              <div class="mt-3 text-end">
                <strong class="text-success">$${order.totalAmount}</strong>
              </div>
            </div>
            <div class="card-footer bg-light">
              <div class="btn-group w-100" role="group">
                ${order.status === 'ç¢ºèªä¸­' ? 
                  `<button class="btn btn-warning btn-sm flex-fill" onclick="updateStatus('${order.id}', 'è£½ä½œä¸­')"><i class="bi bi-play"></i> é–‹å§‹è£½ä½œ</button>` : 
                  ''
                }
                ${order.status === 'è£½ä½œä¸­' ? 
                  `<button class="btn btn-info btn-sm flex-fill" onclick="updateStatus('${order.id}', 'å¯ä»¥å–é¤')"><i class="bi bi-check-lg"></i> å¯ä»¥å–é¤</button>` : 
                  ''
                }
                ${order.status === 'å¯ä»¥å–é¤' ? 
                  `<button class="btn btn-success btn-sm flex-fill" onclick="updateStatus('${order.id}', 'å·²å®Œæˆ')"><i class="bi bi-check2-all"></i> å®Œæˆ</button>` : 
                  `<button class="btn btn-secondary btn-sm flex-fill" onclick="updateStatus('${order.id}', 'å·²å®Œæˆ')"><i class="bi bi-check-lg"></i> æ¨™è¨˜å®Œæˆ</button>`
                }
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  } catch (error) {
    console.error('åˆ·æ–°å»šæˆ¿å¤±æ•—:', error);
    document.getElementById('kitchenOrders').innerHTML = `
      <div class="col-12">
        <div class="alert alert-warning text-center">
          <i class="bi bi-exclamation-triangle fs-1 mb-3 d-block"></i>
          <h5>è¼‰å…¥å·¥å–®å¤±æ•—</h5>
          <p class="text-muted">${error.message}</p>
          <button class="btn btn-outline-warning" onclick="refreshKitchen()">é‡è©¦</button>
        </div>
      </div>
    `;
  }
}

async function updateStatus(orderId, status) {
  if (!confirm(`ç¢ºèªå°‡è¨‚å–® #${orderId} è¨­ç‚º "${status}"ï¼Ÿ`)) return;
  
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      mode: 'cors',
      credentials: 'omit',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: 'updateOrderStatus', orderId, status })
    });
    const text = await response.text();
    const result = JSON.parse(text);
    if (result.success) {
      showSuccess(`è¨‚å–® ${orderId} å·²æ›´æ–°ç‚º ${status}`);
      refreshKitchen();
    } else {
      alert('æ›´æ–°å¤±æ•—: ' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (error) {
    alert('ç¶²è·¯éŒ¯èª¤: ' + error.message);
  }
}

function printKitchen() {
  window.print();
}

// ==================== éŠ·å”®çµ±è¨ˆ ====================
async function loadStats() {
  try {
    const response = await fetch(`${SCRIPT_URL}?action=getSalesStats`, { 
      method: 'GET', 
      mode: 'cors', 
      credentials: 'omit' 
    });
    const text = await response.text();
    const data = JSON.parse(text);
    if (!data.success) throw new Error(data.message || 'ç„¡è³‡æ–™');

    document.getElementById('todayRevenue').textContent = `$${data.todayRevenue.toLocaleString()}`;
    document.getElementById('monthRevenue').textContent = `$${data.monthRevenue.toLocaleString()}`;
    document.getElementById('totalOrders').textContent = data.totalOrders.toLocaleString();
    document.getElementById('topItem').textContent = data.topItems[0]?.name || 'ç„¡è³‡æ–™';

    // æ¯æ—¥è¶¨å‹¢åœ–
    if (dailyChart) dailyChart.destroy();
    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
    dailyChart = new Chart(dailyCtx, {
      type: 'line',
      data: {
        labels: data.dailyRevenue.slice(-7).map(d => new Date(d.date).toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' })),
        datasets: [{
          label: 'ç‡Ÿæ”¶ (NT$)',
          data: data.dailyRevenue.slice(-7).map(d => d.revenue),
          borderColor: 'rgb(46, 204, 113)',
          backgroundColor: 'rgba(46, 204, 113, 0.1)',
          fill: true,
          tension: 0.4,
          pointBackgroundColor: 'rgb(46, 204, 113)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) { return `$${context.parsed.y.toLocaleString()}`; }
            }
          }
        },
        scales: {
          y: { beginAtZero: true, ticks: { callback: function(value) { return '$' + value.toLocaleString(); } } }
        }
      }
    });

    // ç†±éŠ·å“é …åœ–
    if (topItemsChart) topItemsChart.destroy();
    const topCtx = document.getElementById('topItemsChart').getContext('2d');
    topItemsChart = new Chart(topCtx, {
      type: 'doughnut',
      data: {
        labels: data.topItems.map(i => i.name),
        datasets: [{
          data: data.topItems.map(i => i.quantity),
          backgroundColor: [
            '#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6',
            '#1abc9c', '#e67e22', '#95a5a6'
          ],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: function(context) { return `${context.label}: Ã—${context.parsed}`; }
            }
          }
        }
      }
    });

  } catch (error) {
    console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', error);
    // ä½¿ç”¨æ¨¡æ“¬è³‡æ–™
    document.getElementById('todayRevenue').textContent = '$1,250';
    document.getElementById('monthRevenue').textContent = '$28,500';
    document.getElementById('totalOrders').textContent = '156';
    document.getElementById('topItem').textContent = 'æµ·ç›œç‰›æ’å¥—é¤';
  }
}

// ==================== å·¥å…·å‡½å¼ ====================
function refreshAll() {
  loadMenuFromAPI();
  refreshKitchen();
  loadStats();
  showSuccess('å·²åˆ·æ–°æ‰€æœ‰è³‡æ–™');
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
