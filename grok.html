<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>美味廚房 - 店家管理系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>body { font-family: 'Noto Sans TC', sans-serif; }</style>
  <script src="https://unpkg.com/react@19/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@19/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const API_URL = 'https://script.google.com/macros/s/AKfycbzMAk3nYwDvX-oEUA2Juz8HfLlN6ykcp-1Jow9gyr5ffw5xBmEDO9Lv5_Mi6xXq16Z2Ig/exec';

    const api = {
      async get(path) {
        const res = await fetch(`${API_URL}?action=${path}`);
        return await res.json();
      },
      async post(action, data) {
        const res = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action, ...data })
        });
        return await res.json();
      }
    };

    const StatusBadge = ({ status }) => {
      const colors = {
        '確認中': 'bg-blue-500',
        '準備中': 'bg-yellow-500',
        '可以取餐': 'bg-purple-500',
        '完成': 'bg-green-600'
      };
      return <span className={`px-3 py-1 text-white text-sm font-bold rounded-full ${colors[status] || 'bg-gray-500'}`}>{status}</span>;
    };

    const AdminApp = () => {
      const [activeTab, setActiveTab] = useState('orders');
      const [orders, setOrders] = useState([]);
      const [menu, setMenu] = useState([]);
      const [stats, setStats] = useState(null);
      const [loading, setLoading] = useState(true);

      const refreshData = async () => {
        setLoading(true);
        const [orderRes, menuRes, statsRes] = await Promise.all([
          api.get('getAllOrders'),
          api.get('getMenu'),
          api.get('getSalesStats')
        ]);
        if (orderRes.success) setOrders(orderRes.orders);
        if (menuRes.success) setMenu([...menuRes.menu, ...menuRes.addons.map(a => ({...a, isAddon: true}))]);
        if (statsRes.success) setStats(statsRes);
        setLoading(false);
      };

      useEffect(() => { refreshData(); }, []);

      const updateStatus = async (id, status) => {
        await api.post('updateStatus', { orderId: id, status });
        refreshData();
      };

      const toggleAvailability = async (id, current) => {
        await api.post('updateMenuItem', { itemId: id, updates: { isAvailable: !current } });
        refreshData();
      };

      const printOrder = async (id) => {
        const res = await api.post('printOrder', { orderId: id });
        if (res.success) {
          const win = window.open('', '_blank');
          win.document.write(res.html);
          win.document.close();
          setTimeout(() => win.print(), 500);
        }
      };

      if (loading) return <div className="flex justify-center items-center h-screen"><div className="animate-spin rounded-full h-12 w-12 border-t-4 border-green-600"></div></div>;

      return (
        <div className="min-h-screen bg-gray-100">
          <header className="bg-white shadow-md p-4">
            <h1 className="text-2xl font-bold text-green-800">美味廚房 - 店家管理系統</h1>
          </header>

          <div className="container mx-auto p-4">
            <div className="flex gap-2 mb-6 flex-wrap">
              {['orders', 'stats', 'menu'].map(tab => (
                <button key={tab} onClick={() => setActiveTab(tab)}
                  className={`px-6 py-2 rounded-lg font-semibold transition ${activeTab === tab ? 'bg-green-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}`}>
                  {tab === 'orders' ? '訂單管理' : tab === 'stats' ? '銷售統計' : '菜單管理'}
                </button>
              ))}
              <button onClick={refreshData} className="ml-auto bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">刷新</button>
            </div>

            {activeTab === 'orders' && (
              <div className="space-y-4">
                {orders.map(order => (
                  <div key={order.id} className="bg-white p-5 rounded-lg shadow">
                    <div className="flex justify-between items-start mb-3">
                      <div>
                        <h3 className="font-bold text-lg">訂單 #{order.id}</h3>
                        <p className="text-sm text-gray-600">{new Date(order.timestamp).toLocaleString('zh-TW')}</p>
                        <p className="text-sm">顧客：{order.customerName} ({order.customerPhone}) {order.tableNumber && `| 桌號：${order.tableNumber}`}</p>
                      </div>
                      <div className="flex gap-2 items-center">
                        <StatusBadge status={order.status} />
                        <button onClick={() => printOrder(order.id)} className="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">列印</button>
                      </div>
                    </div>
                    <div className="border-t pt-3 space-y-1 text-sm">
                      {order.items.map((it, i) => (
                        <div key={i} className="flex justify-between">
                          <span>{it.item.name} x{it.quantity}</span>
                          <span>${it.totalPrice}</span>
                        </div>
                      ))}
                    </div>
                    <div className="flex justify-between items-center mt-3 pt-3 border-t">
                      <span className="font-bold">總計 ${order.totalAmount}</span>
                      <div className="flex gap-1">
                        {['確認中','準備中','可以取餐','完成'].map(s => (
                          <button key={s} onClick={() => updateStatus(order.id, s)}
                            className={`px-3 py-1 text-xs rounded ${order.status === s ? 'bg-green-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}`}>
                            {s}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {activeTab === 'stats' && stats && (
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="bg-white p-6 rounded-lg shadow text-center">
                  <h3 className="text-3xl font-bold text-green-600">${stats.totalRevenue}</h3>
                  <p className="text-gray-600">今日營業額</p>
                </div>
                <div className="bg-white p-6 rounded-lg shadow text-center">
                  <h3 className="text-3xl font-bold text-blue-600">{stats.orderCount}</h3>
                  <p className="text-gray-600">今日訂單數</p>
                </div>
                <div className="bg-white p-6 rounded-lg shadow">
                  <h3 className="font-bold mb-2">熱門商品</h3>
                  <ol className="space-y-1 text-sm">
                    {stats.topItems.map((it, i) => (
                      <li key={i} className="flex justify-between">
                        <span>{i+1}. {it.name}</span>
                        <span className="font-semibold">{it.quantity} 份</span>
                      </li>
                    ))}
                  </ol>
                </div>
              </div>
            )}

            {activeTab === 'menu' && (
              <div className="space-y-4">
                {menu.map(item => (
                  <div key={item.id} className="bg-white p-4 rounded-lg shadow flex justify-between items-center">
                    <div>
                      <h4 className="font-semibold">{item.name} {item.weight && `(${item.weight})`}</h4>
                      <p className="text-sm text-gray-600">${item.price} | {item.isAddon ? item.category : ''}</p>
                    </div>
                    <button onClick={() => toggleAvailability(item.id, item.isAvailable)}
                      className={`px-4 py-2 rounded font-semibold ${item.isAvailable ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>
                      {item.isAvailable ? '上架中' : '已下架'}
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AdminApp />);
  </script>
</body>
</html>
