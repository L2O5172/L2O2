<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>美味廚房 - 店家管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>body { font-family: 'Noto Sans TC', sans-serif; }</style>
  <script src="https://unpkg.com/react@19/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@19/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- 無 source map 警告的 Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const API_URL = 'https://script.google.com/macros/s/AKfycbyTYHEB7P9cYbsB8O6LjjJeroZqE3Kzij4ad25uLNenxjD6Onm6tVyxi7eOCz8Vo9F4Ng/exec';

    const api = {
      get: (action) => fetch(`${API_URL}?action=${action}`).then(r => r.json()),
      post: (action, data) => fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ action, ...data })
      }).then(r => r.json())
    };

    const StatusBadge = ({ status }) => {
      const colors = {
        '確認中': 'bg-blue-500',
        '準備中': 'bg-yellow-500',
        '可以取餐': 'bg-purple-500',
        '完成': 'bg-green-600'
      };
      return <span className={`px-3 py-1 text-white text-sm font-bold rounded-full ${colors[status] || 'bg-gray-500'}`}>{status}</span>;
    };

    const AdminApp = () => {
      const [tab, setTab] = useState('orders');
      const [orders, setOrders] = useState([]);
      const [stats, setStats] = useState(null);
      const [loading, setLoading] = useState(true);
      const chartRef = useRef(null);
      const chartInstance = useRef(null);

      const refresh = async () => {
        setLoading(true);
        const [o, s] = await Promise.all([api.get('getAllOrders'), api.get('getSalesStats')]);
        if (o.success) setOrders(o.orders);
        if (s.success) setStats(s);
        setLoading(false);
      };

      useEffect(() => { refresh(); }, []);

      useEffect(() => {
        if (stats && tab === 'stats' && chartRef.current) {
          if (chartInstance.current) chartInstance.current.destroy();
          const ctx = chartRef.current.getContext('2d');
          chartInstance.current = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: stats.topItems.map(i => i.name),
              datasets: [{
                label: '銷售數量',
                data: stats.topItems.map(i => i.quantity),
                backgroundColor: 'rgba(34, 197, 94, 0.6)'
              }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
          });
        }
        return () => { if (chartInstance.current) chartInstance.current.destroy(); };
      }, [stats, tab]);

      const updateStatus = async (id, status) => {
        await api.post('updateStatus', { orderId: id, status });
        refresh();
      };

      if (loading) return <div className="flex justify-center items-center h-screen"><div className="animate-spin rounded-full h-12 w-12 border-t-4 border-green-600"></div></div>;

      return (
        <div className="min-h-screen">
          <header className="bg-white shadow-md p-4">
            <h1 className="text-2xl font-bold text-green-800">美味廚房 - 店家管理</h1>
          </header>

          <div className="container mx-auto p-4">
            <div className="flex gap-2 mb-6 flex-wrap">
              {['orders', 'stats'].map(t => (
                <button key={t} onClick={() => setTab(t)}
                  className={`px-6 py-2 rounded-lg font-semibold ${tab === t ? 'bg-green-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}`}>
                  {t === 'orders' ? '訂單管理' : '銷售統計'}
                </button>
              ))}
              <button onClick={refresh} className="ml-auto bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">刷新</button>
            </div>

            {tab === 'orders' && (
              <div className="space-y-4">
                {orders.map(order => (
                  <div key={order.id} className="bg-white p-5 rounded-lg shadow">
                    <div className="flex justify-between items-start mb-3">
                      <div>
                        <h3 className="font-bold text-lg">訂單 #{order.id}</h3>
                        <p className="text-sm text-gray-600">{new Date(order.timestamp).toLocaleString('zh-TW')}</p>
                        <p className="text-sm">顧客：{order.customerName} | {order.orderType}</p>
                      </div>
                      <StatusBadge status={order.status} />
                    </div>
                    <div className="border-t pt-3 space-y-1 text-sm">
                      {order.items.map((it, i) => (
                        <div key={i} className="flex justify-between">
                          <span>{it.item.name} x{it.quantity}</span>
                          <span>${it.totalPrice}</span>
                        </div>
                      ))}
                    </div>
                    <div className="flex justify-between items-center mt-3 pt-3 border-t">
                      <span className="font-bold">總計 ${order.totalAmount}</span>
                      <div className="flex gap-1">
                        {['確認中','準備中','可以取餐','完成'].map(s => (
                          <button key={s} onClick={() => updateStatus(order.id, s)}
                            className={`px-3 py-1 text-xs rounded ${order.status === s ? 'bg-green-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}`}>
                            {s}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {tab === 'stats' && stats && (
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div className="bg-white p-6 rounded-lg shadow text-center">
                  <h3 className="text-3xl font-bold text-green-600">${stats.totalRevenue}</h3>
                  <p className="text-gray-600">今日營業額</p>
                </div>
                <div className="bg-white p-6 rounded-lg shadow text-center">
                  <h3 className="text-3xl font-bold text-blue-600">{stats.orderCount}</h3>
                  <p className="text-gray-600">今日訂單數</p>
                </div>
                <div className="bg-white p-6 rounded-lg shadow">
                  <h3 className="font-bold mb-3">熱門商品</h3>
                  <canvas ref={chartRef}></canvas>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AdminApp />);
  </script>
</body>
</html>
