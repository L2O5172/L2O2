<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>美味廚房點餐系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body class="bg-slate-100">
  <div id="root"></div>

  <!-- 移除 importmap，改用 CDN 完整導入 React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    // === 所有常量放在最上面，避免作用域問題 ===
    const Doneness = {
      Three: '3分熟',
      Five: '5分熟',
      Seven: '7分熟',
      WellDone: '全熟'
    };

    const DONENESS_LEVELS = [Doneness.Three, Doneness.Five, Doneness.Seven, Doneness.WellDone];
    const SAUCE_CHOICES = ["巴醋", "橙汁", "椒鹽", "芥末", "泡菜", "BBQ醬", "黑胡椒", "蒜味醬"];
    const DRINK_CHOICES = ["無糖紅茶", "冰涼可樂"];

    const FALLBACK_MENU = [ /* ... 你的 MENU_DATA 複製進來 ... */ ];
    const FALLBACK_ADDONS = [ /* ... 你的 ADDONS 複製進來 ... */ ];

    const API_URL = 'https://script.google.com/macros/s/AKfycbysLyXmbsHSQ-nT7oN8lh2gPQPlNNLqM1EbCbAtmGdzq2U8OY5OGFQxLjqbD2W7KpEF/exec';

    // === Icons ===
    const PlusIcon = ({ className = "h-5 w-5" }) => (
      <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
      </svg>
    );

    const MinusIcon = ({ className = "h-5 w-5" }) => (
      <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 12H6" />
      </svg>
    );

    const TrashIcon = ({ className = "h-5 w-5" }) => (
      <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
    );

    const CloseIcon = ({ className = "h-6 w-6" }) => (
      <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
      </svg>
    );

    const CartIcon = ({ className = "h-6 w-6" }) => (
      <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m-6 4a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
      </svg>
    );

    const CheckIcon = ({ className = "h-6 w-6" }) => (
      <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
      </svg>
    );

    const RefreshIcon = ({ className = "h-5 w-5" }) => (
      <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
    );

    // === API Service ===
    const apiService = {
      async getMenuAndAddons() {
        try {
          const res = await fetch(`${API_URL}?action=getMenu`);
          if (!res.ok) throw new Error('Network error');
          const data = await res.json();
          if (!data.menu || !data.addons) throw new Error('Invalid data');
          return { ...data, from: 'api' };
        } catch (e) {
          console.warn('API failed, using fallback', e);
          return { menu: FALLBACK_MENU, addons: FALLBACK_ADDONS, from: 'fallback' };
        }
      },

      async submitOrder(orderData) {
        const simplifiedItems = orderData.items.map(item => ({
          name: `${item.item.name}${item.item.weight ? ` (${item.item.weight})` : ''}`,
          quantity: item.quantity,
          totalPrice: item.totalPrice,
          customizations: {
            doneness: item.selectedDonenesses ? Object.entries(item.selectedDonenesses).map(([d, q]) => `${d} x${q}`).join(', ') : 'N/A',
            drinks: item.selectedDrinks ? Object.entries(item.selectedDrinks).map(([d, q]) => `${d} x${q}`).join(', ') : 'N/A',
            sauces: item.selectedSauces.map(s => `${s.name}${s.quantity > 1 ? ` x${s.quantity}` : ''}`).join(', ') || 'None',
            addons: item.selectedAddons.map(a => `${a.name} x${a.quantity}`).join(', ') || 'None',
            notes: item.selectedNotes || 'None',
          }
        }));

        const payload = {
          action: 'createOrder',
          orderData: {
            customerName: orderData.customerInfo.name,
            customerPhone: orderData.customerInfo.phone,
            tableNumber: orderData.customerInfo.tableNumber,
            items: JSON.stringify(simplifiedItems, null, 2),
            totalAmount: orderData.totalPrice,
            timestamp: new Date().toISOString(),
          },
        };

        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`Server error: ${res.status} ${txt}`);
        }

        const result = await res.json();
        if (!result.success) throw new Error(result.message || 'Unknown error');
        return result;
      }
    };

    // === Components ===
    const Menu = ({ menuData, onSelectItem }) => (
      <div className="space-y-12">
        {menuData.map(cat => (
          <div key={cat.title}>
            <div className="mb-6 pb-2 border-b-2 border-green-700">
              <h2 className="text-3xl font-bold text-slate-800">{cat.title}</h2>
              <p className="text-sm text-slate-500 mt-1">{cat.description}</p>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
              {cat.items.map(item => (
                <div key={item.id} className="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col hover:scale-105 transition-transform">
                  <div className="p-6 flex-grow flex flex-col justify-between">
                    <div>
                      <h3 className="text-xl font-semibold text-slate-900">{item.name}</h3>
                      {item.weight && <p className="text-sm text-slate-500">{item.weight}</p>}
                      <p className="text-2xl font-bold text-green-700 mt-2">${item.price}</p>
                      {item.customizations && (
                        <div className="mt-2 flex flex-wrap gap-1">
                          {item.customizations.doneness && <span className="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">可選熟度</span>}
                          {item.customizations.sauceChoice && <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">可選醬料</span>}
                          {item.customizations.drinkChoice && <span className="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full">可選附餐</span>}
                        </div>
                      )}
                    </div>
                    <button onClick={() => onSelectItem(item)} className="mt-4 w-full flex items-center justify-center bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">
                      <PlusIcon className="h-5 w-5 mr-2" /> 加入餐點
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    );

    const ItemModal = ({ item, addons, onClose, onAddToCart }) => {
      const [quantity, setQuantity] = useState(1);
      const isSteak = !!item.customizations?.doneness;
      const [donenessQuantities, setDonenessQuantities] = useState({});
      const [drinkQuantities, setDrinkQuantities] = useState({});
      const [notes, setNotes] = useState('');
      const [selectedAddons, setSelectedAddons] = useState([]);
      const [selectedSauces, setSelectedSauces] = useState([]);

      const allocatedDonenessCount = useMemo(() => Object.values(donenessQuantities).reduce((a, b) => a + b, 0), [donenessQuantities]);
      const allocatedDrinkCount = useMemo(() => Object.values(drinkQuantities).reduce((a, b) => a + b, 0), [drinkQuantities]);
      const totalSauceCount = useMemo(() => selectedSauces.reduce((a, s) => a + s.quantity, 0), [selectedSauces]);
      const totalSauceLimit = quantity * 2;

      const addonGroups = useMemo(() => addons.reduce((acc, a) => {
        (acc[a.category] = acc[a.category] || []).push(a);
        return acc;
      }, {}), [addons]);

      const handleDonenessChange = useCallback((d, change) => {
        setDonenessQuantities(prev => {
          const cur = prev[d] || 0;
          const next = cur + change;
          if (next < 0 || (change > 0 && allocatedDonenessCount >= quantity)) return prev;
          const newObj = { ...prev };
          if (next === 0) delete newObj[d]; else newObj[d] = next;
          return newObj;
        });
      }, [allocatedDonenessCount, quantity]);

      const handleDrinkChange = useCallback((d, change) => {
        setDrinkQuantities(prev => {
          const cur = prev[d] || 0;
          const next = cur + change;
          if (next < 0 || (change > 0 && allocatedDrinkCount >= quantity)) return prev;
          const newObj = { ...prev };
          if (next === 0) delete newObj[d]; else newObj[d] = next;
          return newObj;
        });
      }, [allocatedDrinkCount, quantity]);

      const handleAddonChange = useCallback((addon, change) => {
        setSelectedAddons(prev => {
          const existing = prev.find(a => a.id === addon.id);
          if (existing) {
            const newQ = existing.quantity + change;
            return newQ <= 0 ? prev.filter(a => a.id !== addon.id) : prev.map(a => a.id === addon.id ? { ...a, quantity: newQ } : a);
          }
          return change > 0 ? [...prev, { ...addon, quantity: change }] : prev;
        });
      }, []);

      const handleSauceChange = useCallback((name, change) => {
        setSelectedSauces(prev => {
          const existing = prev.find(s => s.name === name);
          if (existing) {
            const newQ = existing.quantity + change;
            if (newQ < 0 || (change > 0 && totalSauceCount >= totalSauceLimit)) return prev;
            return newQ === 0 ? prev.filter(s => s.name !== name) : prev.map(s => s.name === name ? { ...s, quantity: newQ } : s);
          }
          return change > 0 && totalSauceCount < totalSauceLimit ? [...prev, { name, quantity: 1 }] : prev;
        });
      }, [totalSauceCount, totalSauceLimit]);

      const handleSubmit = () => {
        if (isSteak && allocatedDonenessCount !== quantity) { alert(`請分配所有 ${quantity} 份餐點的熟度`); return; }
        if (item.customizations?.drinkChoice && allocatedDrinkCount !== quantity) { alert(`請選擇所有 ${quantity} 份餐點的飲料`); return; }
        onAddToCart(item, quantity, { donenesses: donenessQuantities, drinks: drinkQuantities, addons: selectedAddons, sauces: selectedSauces, notes: notes.trim() });
        onClose();
      };

      const totalAddonPrice = selectedAddons.reduce((s, a) => s + a.price * a.quantity, 0);
      const totalPrice = item.price * quantity + totalAddonPrice;

      return (
        <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" onClick={onClose}>
          <div className="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
            <header className="p-6 relative border-b">
              <button onClick={onClose} className="absolute top-4 right-4"><CloseIcon /></button>
              <h2 className="text-2xl font-bold">{item.name}{item.weight && ` (${item.weight})`}</h2>
              <p className="text-xl font-semibold text-green-700 mt-2">${item.price}</p>
            </header>
            <main className="px-6 py-4 space-y-6 overflow-y-auto">
              {/* 數量、熟度、飲料、醬料、加購、備註... 略，保持不變 */}
              {/* 請將原本 ItemModal 的 JSX 內容貼在這裡 */}
            </main>
            <footer className="p-6 border-t bg-slate-50">
              <button onClick={handleSubmit} className="w-full bg-green-600 text-white font-bold py-4 rounded-lg hover:bg-green-700 text-lg">
                加入購物車 - 總計 ${totalPrice}
              </button>
            </footer>
          </div>
        </div>
      );
    };

    // === 其他組件 Cart, App 保持不變 ===
    // ... 請將 Cart 和 App 組件完整貼上（略）

    // === 渲染 ===
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
  </script>
</body>
</html>
