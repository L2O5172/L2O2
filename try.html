<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>美味廚房點餐系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        @media print {
            body > *:not(.print-container) {
                display: none !important;
            }
            .print-area {
                display: block !important;
            }
            .print-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                display: block !important;
                font-size: 12px;
            }
            .print-container button, .print-container a, .no-print {
                display: none !important;
            }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0"
  }
}
</script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React from 'react';
        import ReactDOM from 'react-dom/client';

        // From constants.ts
        const Doneness = {
          Three: '3分熟',
          Five: '5分熟',
          Seven: '7分熟',
          WellDone: '全熟',
        };

        const MENU_DATA = [
          {
            title: "套餐",
            description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤飲料",
            items: [
              { id: 'set-1', name: '香煎海盜牛排套餐', weight: '7oz', price: 299, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
              { id: 'set-2', name: '香煎海盜牛排套餐', weight: '14oz', price: 399, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
              { id: 'set-3', name: '香煎海盜牛排套餐', weight: '21oz', price: 499, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
              { id: 'set-4', name: '香煎特選板腱套餐', weight: '10oz', price: 399, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
              { id: 'set-5', name: '香煎老饕上蓋套餐', weight: '7oz', price: 399, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
              { id: 'set-6', name: '香煎紐菲力套餐', weight: '7oz', price: 499, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
              { id: 'set-7', name: '香煎櫻桃鴨胸套餐', weight: '10oz', price: 320, customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
              { id: 'set-8', name: '香煎鮮嫩鱸魚套餐', weight: '10oz', price: 320, customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
              { id: 'set-9', name: '香煎鮮嫩雞腿套餐', weight: '10oz', price: 250, customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
              { id: 'set-10', name: '香煎美味豬排套餐', weight: '10oz', price: 299, customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
              { id: 'set-11', name: '英式炸魚套餐', weight: '10oz', price: 250, customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
              { id: 'set-12', name: '日式豬排套餐', weight: '10oz', price: 250, customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: false },
            ]
          },
          {
            title: "組合餐",
            description: "附: ①日湯 ②麵包 ③主餐 ④脆薯 ⑤沙拉 ⑥飲料",
            items: [
              { id: 'combo-1', name: '日豬、雞腿、上蓋組合餐', weight: '15oz', price: 529, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
              { id: 'combo-2', name: '炸魚、雞腿、板腱組合餐', weight: '15oz', price: 529, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
              { id: 'combo-3', name: '鱸魚、鴨胸、豬排組合餐', weight: '15oz', price: 529, customizations: { doneness: false, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
              { id: 'combo-4', name: '鴨胸、鱸魚、上蓋組合餐', weight: '15oz', price: 599, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
              { id: 'combo-5', name: 'N菲、上蓋、板腱組合餐', weight: '15oz', price: 699, customizations: { doneness: true, sauceChoice: true, drinkChoice: true, notes: true }, isAvailable: true },
            ]
          }
        ];

        const ADDONS = [
            { id: 'addon-pirate-steak-5oz', name: '海盜牛排 5oz 加購', price: 200, category: '主餐加購', isAvailable: true },
            { id: 'addon-top-blade-5oz', name: '特選板腱 5oz 加購', price: 200, category: '主餐加購', isAvailable: true },
            { id: 'addon-ribeye-cap-5oz', name: '老饕上蓋 5oz 加購', price: 200, category: '主餐加購', isAvailable: true },
            { id: 'addon-filet-mignon-5oz', name: '紐菲力 5oz 加購', price: 250, category: '主餐加購', isAvailable: true },
            { id: 'addon-duck-breast', name: '櫻桃鴨胸 加購', price: 150, category: '主餐加購', isAvailable: true },
            { id: 'addon-sea-bass', name: '鮮嫩鱸魚 加購', price: 150, category: '主餐加購', isAvailable: true },
            { id: 'addon-chicken-leg', name: '鮮嫩雞腿 加購', price: 120, category: '主餐加購', isAvailable: true },
            { id: 'addon-pork-chop', name: '美味豬排 加購', price: 120, category: '主餐加購', isAvailable: true },
            { id: 'addon-fried-fish', name: '英式炸魚 加購', price: 120, category: '主餐加購', isAvailable: true },
            { id: 'addon-jp-pork-cutlet', name: '日式豬排 加購', price: 120, category: '主餐加購', isAvailable: false },
            { id: 'addon-dessert', name: '是日甜品 加購', price: 30, category: '其他加購', isAvailable: true },
        ];

        const DONENESS_LEVELS = [Doneness.Three, Doneness.Five, Doneness.Seven, Doneness.WellDone];
        const SAUCE_CHOICES = ["巴醋", "橙汁", "椒鹽", "芥末", "泡菜", "BBQ醬", "黑胡椒", "蒜味醬"];
        const DRINK_CHOICES = ["無糖紅茶", "冰涼可樂"];

        // From components/icons.tsx
        const PlusIcon = ({ className = "h-5 w-5" }) => (
          <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
        );

        const MinusIcon = ({ className = "h-5 w-5" }) => (
          <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 12H6" />
          </svg>
        );

        const TrashIcon = ({ className = "h-5 w-5" }) => (
          <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        );

        const CloseIcon = ({ className = "h-6 w-6" }) => (
          <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        );

        const CartIcon = ({ className = "h-6 w-6" }) => (
          <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m-6 4a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
          </svg>
        );

        const CheckIcon = ({ className = "h-6 w-6" }) => (
          <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
          </svg>
        );
        
        const SearchIcon = ({ className = "h-5 w-5" }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        );

        const RefreshIcon = ({ className = "h-5 w-5" }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        );
        
        const PencilIcon = ({ className = "h-5 w-5" }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" />
            </svg>
        );


        // From apiService.ts
        const API_URL = 'https://script.google.com/macros/s/AKfycbx83vpj3iuB6rPorzWodu9pVw3UyMSzsfUBwQZe9a90ZSvWdZvr16D_uhIbjV3mpvvJ/exec';

        const apiService = {
          async getMenuAndAddons() {
            try {
              const response = await fetch(`${API_URL}?action=getMenu`);
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              const data = await response.json();
              if (!data.menu || !data.addons) {
                throw new Error('Invalid data structure from API');
              }
              return { ...data, from: 'api' };
            } catch (error) {
              console.warn("API fetch failed, using fallback.", error);
              return { menu: MENU_DATA, addons: ADDONS, from: 'fallback' };
            }
          },

          async submitOrder(orderData) {
            try {
                const payload = {
                    action: 'createOrder',
                    orderData: {
                        customerName: orderData.customerInfo.name,
                        customerPhone: orderData.customerInfo.phone,
                        tableNumber: orderData.customerInfo.tableNumber,
                        orderType: orderData.orderType,
                        items: orderData.items, // Pass the full cart items array
                        totalAmount: orderData.totalPrice,
                        timestamp: new Date().toISOString(),
                    },
                };
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} ${response.statusText}. Response: ${errorText}`);
                }
                
                const responseText = await response.text();
                try {
                    const result = JSON.parse(responseText);
                    if (!result.success) {
                        throw new Error(result.message || 'The server indicated an unknown error.');
                    }
                    return result; // Should include orderId now
                } catch (e) {
                    throw new Error(`Received an invalid response from the server: ${responseText}`);
                }

            } catch (error) {
                console.error("Failed to submit order:", error);
                if (error instanceof Error) {
                    throw error;
                }
                throw new Error('An unknown error occurred during order submission.');
            }
          },
          async getOrderStatus(orderId) {
             try {
                const response = await fetch(`${API_URL}?action=getOrderStatus&orderId=${orderId}`);
                if (!response.ok) {
                    throw new Error('查詢時發生網路錯誤');
                }
                return await response.json();
             } catch (error) {
                console.error("Failed to get order status:", error);
                return { success: false, message: error.message };
             }
          }
        };
        
        // NEW OrderQueryModal component
        const OrderQueryModal = ({ isOpen, onClose }) => {
            const [orderIdInput, setOrderIdInput] = React.useState('');
            const [searchResult, setSearchResult] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [orderHistory, setOrderHistory] = React.useState([]);
            
            const printRef = React.useRef(null);

            const handleSearch = async (idToSearch) => {
                const orderId = idToSearch || orderIdInput.trim();
                if (!orderId) {
                    setError('請輸入訂單編號');
                    return;
                }
                setIsLoading(true);
                setError(null);
                setSearchResult(null);
                const result = await apiService.getOrderStatus(orderId);
                if (result.success) {
                    setSearchResult(result.order);
                } else {
                    setError(result.message || '查詢失敗，請確認訂單編號是否正確。');
                }
                setIsLoading(false);
            };

            const handleFormSubmit = (e) => {
                e.preventDefault();
                handleSearch();
            }

            const handleHistorySearch = (id) => {
                setOrderIdInput(id);
                handleSearch(id);
            }

            const clearHistory = () => {
                localStorage.removeItem('steakhouse-orders');
                setOrderHistory([]);
            }
            
            const handlePrint = () => {
                window.print();
            };
            
            const handleLineShare = () => {
                if (!searchResult || !searchResult.items) return;
                const itemsText = searchResult.items.map(item => `- ${item.item.name} x${item.quantity}`).join('\n');
                const text = `我的訂單 #${searchResult.id}\n類型: ${searchResult.orderType}\n狀態: ${searchResult.status}\n\n餐點:\n${itemsText}\n\n總金額: $${searchResult.totalAmount}\n感謝您的訂購！`;
                const url = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
                window.open(url, '_blank');
            };
            
            const getStatusColor = (status) => {
                switch (status) {
                    case '製作中': return 'bg-yellow-500 text-white';
                    case '已完成': return 'bg-green-600 text-white';
                    case '待處理': return 'bg-blue-500 text-white';
                    default: return 'bg-slate-500 text-white';
                }
            };

            React.useEffect(() => {
                if (isOpen) {
                    const savedOrders = JSON.parse(localStorage.getItem('steakhouse-orders') || '[]');
                    setOrderHistory(savedOrders);
                } else {
                    setTimeout(() => {
                        setOrderIdInput('');
                        setSearchResult(null);
                        setError(null);
                        setIsLoading(false);
                    }, 300);
                }
            }, [isOpen]);

            return (
                <div className={`fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4 transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                        <header className="p-5 relative border-b">
                            <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-800"><CloseIcon /></button>
                            <h2 className="text-2xl font-bold text-slate-800">查詢訂單狀態</h2>
                        </header>
                        <main className="px-6 py-4 space-y-4 overflow-y-auto">
                            <form onSubmit={handleFormSubmit} className="flex items-center gap-2">
                                <input 
                                    type="text" 
                                    value={orderIdInput}
                                    onChange={e => setOrderIdInput(e.target.value)}
                                    placeholder="請輸入您的訂單編號 (例如 ORD-...)"
                                    className="flex-grow p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-green-500 outline-none"
                                />
                                <button type="submit" disabled={isLoading} className="flex items-center justify-center bg-green-600 text-white font-semibold py-3 px-5 rounded-md hover:bg-green-700 disabled:bg-slate-400">
                                    {isLoading ? <div className="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div> : '查詢'}
                                </button>
                            </form>
                            
                            {orderHistory.length > 0 && (
                                <div className="space-y-2">
                                    <div className="flex justify-between items-center">
                                      <h4 className="text-sm font-semibold text-slate-500">查詢紀錄:</h4>
                                      <button onClick={clearHistory} className="text-xs text-slate-400 hover:text-red-500">清除紀錄</button>
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        {orderHistory.map(id => (
                                            <button key={id} onClick={() => handleHistorySearch(id)} className="bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-mono px-2 py-1 rounded">
                                                {id}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {error && <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert"><p>{error}</p></div>}
                            
                            {searchResult && (
                                <>
                                <div ref={printRef} className="print-area">
                                  <div className="print-container bg-slate-50 p-4 rounded-lg border space-y-3">
                                    <h3 className="text-xl font-bold text-slate-800">訂單詳情</h3>
                                    <div className="flex justify-between items-center">
                                        <p className="text-slate-600">訂單編號:</p>
                                        <p className="font-mono font-semibold">{searchResult.id}</p>
                                    </div>
                                     <div className="flex justify-between items-center">
                                        <p className="text-slate-600">訂單狀態:</p>
                                        <span className={`px-3 py-1 text-sm font-bold rounded-full ${getStatusColor(searchResult.status)}`}>{searchResult.status}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <p className="text-slate-600">訂單類型:</p>
                                        <p className="font-semibold">{searchResult.orderType}</p>
                                    </div>
                                    <div className="border-t pt-3">
                                        <h4 className="font-semibold mb-2">餐點項目:</h4>
                                        <ul className="space-y-2 text-slate-700 text-sm">
                                            {(searchResult.items || []).map((item, index) => (
                                                <li key={item.cartId || index} className="border-b pb-2 last:border-b-0">
                                                    <p className="font-medium">{item.item.name} x{item.quantity}</p>
                                                    <div className="text-xs text-slate-500 pl-2">
                                                        {item.selectedDonenesses && Object.keys(item.selectedDonenesses).length > 0 && <p>熟度: {Object.entries(item.selectedDonenesses).map(([d, q]) => `${d}x${q}`).join(', ')}</p>}
                                                        {item.selectedNotes && <p>備註: {item.selectedNotes}</p>}
                                                    </div>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                    <div className="flex justify-between items-center border-t pt-3 mt-3">
                                        <p className="text-lg font-bold">總金額:</p>
                                        <p className="text-xl font-bold text-green-700">${searchResult.totalAmount}</p>
                                    </div>
                                  </div>
                                </div>
                                <div className="flex gap-2 justify-end no-print">
                                    <button onClick={handleLineShare} className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">LINE 分享</button>
                                    <button onClick={handlePrint} className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">列印訂單</button>
                                </div>
                                </>
                            )}
                        </main>
                         <footer className="p-4 border-t bg-slate-50 text-center">
                            <button onClick={onClose} className="w-full sm:w-auto bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-lg hover:bg-slate-300 transition-colors">
                                關閉
                            </button>
                        </footer>
                    </div>
                </div>
            );
        };


        // From components/Menu.tsx
        const Menu = ({ menuData, onSelectItem }) => {
          return (
            <div className="space-y-12">
              {menuData.map((category) => (
                <div key={category.title} id={category.title}>
                  <div className="mb-6 pb-2 border-b-2 border-green-700">
                    <h2 className="text-3xl font-bold text-slate-800">{category.title}</h2>
                    <p className="text-sm text-slate-500 mt-1">{category.description}</p>
                  </div>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    {category.items.map((item) => (
                      <div key={item.id} className={`bg-white rounded-lg shadow-lg overflow-hidden flex flex-col transition-transform transform hover:scale-105 relative ${!item.isAvailable ? 'opacity-60 bg-slate-50 cursor-not-allowed' : ''}`}>
                        {!item.isAvailable && <div className="absolute top-4 right-4 bg-red-600 text-white text-sm font-bold px-3 py-1 rounded-full z-10 transform -rotate-12">售罄</div>}
                        <div className="p-6 flex-grow flex flex-col justify-between">
                          <div>
                            <h3 className="text-xl font-semibold text-slate-900">{item.name.replace(/半全餐|半套餐/g, '套餐')}</h3>
                            {item.weight && <p className="text-sm text-slate-500">{item.weight}</p>}
                            <p className="text-2xl font-bold text-green-700 mt-2">${item.price}</p>
                            {item.customizations && (
                              <div className="mt-2 flex flex-wrap gap-1">
                                {item.customizations.doneness && <span className="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">可選熟度</span>}
                                {item.customizations.sauceChoice && <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">可選醬料</span>}
                                {item.customizations.drinkChoice && <span className="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full">可選附餐</span>}
                              </div>
                            )}
                          </div>
                          <button
                            onClick={() => onSelectItem(item, category)}
                            disabled={!item.isAvailable}
                            className="mt-4 w-full flex items-center justify-center bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed"
                          >
                            <PlusIcon className="h-5 w-5 mr-2" />
                            <span>{item.isAvailable ? '加入餐點' : '已售完'}</span>
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          );
        };

        // From components/ItemModal.tsx
        const ItemModal = ({ selectedItem, editingItem, addons, onClose, onConfirmSelection }) => {
          const { item, category } = selectedItem;
          const [quantity, setQuantity] = React.useState(1);
          const isSteak = !!item.customizations?.doneness;

          const [donenessQuantities, setDonenessQuantities] = React.useState({});
          const [drinkQuantities, setDrinkQuantities] = React.useState({});
          const [notes, setNotes] = React.useState('');
          const [selectedAddons, setSelectedAddons] = React.useState([]);
          const [selectedSauces, setSelectedSauces] = React.useState([]);

          React.useEffect(() => {
            if (editingItem) {
              setQuantity(editingItem.quantity);
              setDonenessQuantities(editingItem.selectedDonenesses || {});
              setDrinkQuantities(editingItem.selectedDrinks || {});
              setSelectedSauces(editingItem.selectedSauces || []);
              setSelectedAddons(editingItem.selectedAddons || []);
              setNotes(editingItem.selectedNotes || '');
            } else {
              setQuantity(1);
              setDonenessQuantities({});
              setDrinkQuantities({});
              setSelectedSauces([]);
              setSelectedAddons([]);
              setNotes('');
            }
          }, [editingItem, selectedItem]);

          const allocatedDonenessCount = React.useMemo(() => Object.values(donenessQuantities).reduce((sum, count) => sum + count, 0), [donenessQuantities]);
          const allocatedDrinkCount = React.useMemo(() => Object.values(drinkQuantities).reduce((sum, count) => sum + count, 0), [drinkQuantities]);
          const totalSauceCount = React.useMemo(() => selectedSauces.reduce((sum, sauce) => sum + sauce.quantity, 0), [selectedSauces]);
          const totalSauceLimit = quantity * 2;

          const addonGroups = React.useMemo(() => {
            return addons.reduce((acc, addon) => {
              (acc[addon.category] = acc[addon.category] || []).push(addon);
              return acc;
            }, {});
          }, [addons]);

          const handleDonenessChange = React.useCallback((doneness, change) => {
            setDonenessQuantities(prev => {
                const newQuantities = { ...prev };
                const currentCount = newQuantities[doneness] || 0;
                const newCount = currentCount + change;
                
                if (newCount < 0) return prev;
                if (change > 0 && allocatedDonenessCount >= quantity) return prev;

                if (newCount === 0) {
                    delete newQuantities[doneness];
                } else {
                    newQuantities[doneness] = newCount;
                }
                return newQuantities;
            });
          }, [allocatedDonenessCount, quantity]);

          const handleDrinkChange = React.useCallback((drink, change) => {
            setDrinkQuantities(prev => {
                const newQuantities = { ...prev };
                const currentCount = newQuantities[drink] || 0;
                const newCount = currentCount + change;
                
                if (newCount < 0) return prev;
                if (change > 0 && allocatedDrinkCount >= quantity) return prev;
                
                if (newCount === 0) {
                    delete newQuantities[drink];
                } else {
                    newQuantities[drink] = newCount;
                }
                return newQuantities;
            });
          }, [allocatedDrinkCount, quantity]);

          const handleAddonQuantityChange = React.useCallback((addon, change) => {
            if (!addon.isAvailable && change > 0) return;
            setSelectedAddons(prev => {
              const existingAddon = prev.find(a => a.id === addon.id);
              if (existingAddon) {
                const newQuantity = existingAddon.quantity + change;
                return newQuantity <= 0 ? prev.filter(a => a.id !== addon.id) : prev.map(a => a.id === addon.id ? { ...a, quantity: newQuantity } : a);
              } else if (change > 0) {
                return [...prev, { ...addon, quantity: change }];
              }
              return prev;
            });
          }, []);

          const handleSauceChange = React.useCallback((sauceName, change) => {
            setSelectedSauces(prev => {
              const existingSauce = prev.find(s => s.name === sauceName);
              if (existingSauce) {
                const newQuantity = existingSauce.quantity + change;
                if (newQuantity < 0) return prev;
                if (totalSauceCount >= totalSauceLimit && change > 0) return prev;
                if (newQuantity === 0) return prev.filter(s => s.name !== sauceName);
                return prev.map(s => s.name === sauceName ? { ...s, quantity: newQuantity } : s);
              } else if (change > 0 && totalSauceCount < totalSauceLimit) {
                return [...prev, { name: sauceName, quantity: 1 }];
              }
              return prev;
            });
          }, [totalSauceCount, totalSauceLimit]);

          const handleSubmit = () => {
            if (isSteak && allocatedDonenessCount !== quantity) { alert(`請分配所有 ${quantity} 份餐點的熟度`); return; }
            if (item.customizations?.drinkChoice && allocatedDrinkCount !== quantity) { alert(`請選擇所有 ${quantity} 份餐點的飲料`); return; }

            const options = { 
                donenesses: donenessQuantities,
                drinks: drinkQuantities,
                addons: selectedAddons, 
                sauces: selectedSauces, 
                notes: notes.trim() 
            };
            onConfirmSelection(item, quantity, options, category);
            onClose();
          };
          
          const totalAddonPrice = selectedAddons.reduce((sum, addon) => sum + (addon.price * addon.quantity), 0);
          const totalPrice = (item.price * quantity) + totalAddonPrice;

          return (
            <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" onClick={onClose}>
              <div className="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                <header className="p-6 relative border-b">
                  <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-800"><CloseIcon /></button>
                  <h2 className="text-2xl font-bold text-slate-800">{item.name.replace(/半全餐|半套餐/g, '套餐')}{item.weight && ` (${item.weight})`}</h2>
                  <p className="text-xl font-semibold text-green-700 mt-2">${item.price}</p>
                </header>
                <main className="px-6 py-4 space-y-6 overflow-y-auto">
                  <div className="flex items-center justify-between">
                    <h3 className="text-lg font-semibold text-slate-700">數量</h3>
                    <div className="flex items-center gap-2">
                      <button onClick={() => setQuantity(q => Math.max(1, q - 1))} className="p-2 rounded-full bg-slate-200 hover:bg-slate-300"><MinusIcon /></button>
                      <span className="text-xl font-bold w-12 text-center">{quantity}</span>
                      <button onClick={() => setQuantity(q => q + 1)} className="p-2 rounded-full bg-slate-200 hover:bg-slate-300"><PlusIcon /></button>
                    </div>
                  </div>
                  {isSteak && (
                    <div>
                      <div className="flex justify-between items-baseline mb-3">
                        <h3 className="text-lg font-semibold text-slate-700">牛排熟度*</h3>
                        <span className={`font-semibold ${allocatedDonenessCount === quantity ? 'text-green-600' : 'text-red-500'}`}>已分配 {allocatedDonenessCount} / {quantity}</span>
                      </div>
                      <div className="space-y-3">
                        {DONENESS_LEVELS.map(d => (
                          <div key={d} className="flex items-center justify-between bg-slate-50 p-3 rounded-lg">
                            <span className="font-medium text-slate-800">{d}</span>
                            <div className="flex items-center gap-3">
                              <button onClick={() => handleDonenessChange(d, -1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300"><MinusIcon className="h-4 w-4" /></button>
                              <span className="text-lg font-semibold w-8 text-center">{donenessQuantities[d] || 0}</span>
                              <button onClick={() => handleDonenessChange(d, 1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300" disabled={allocatedDonenessCount >= quantity}><PlusIcon className="h-4 w-4" /></button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  {item.customizations?.drinkChoice && (
                    <div>
                        <div className="flex justify-between items-baseline mb-3">
                            <h3 className="text-lg font-semibold text-slate-700">飲料*</h3>
                            <span className={`font-semibold ${allocatedDrinkCount === quantity ? 'text-green-600' : 'text-red-500'}`}>已選擇 {allocatedDrinkCount} / {quantity}</span>
                        </div>
                        <div className="space-y-3">
                            {DRINK_CHOICES.map(drink => (
                                <div key={drink} className="flex items-center justify-between bg-slate-50 p-3 rounded-lg">
                                    <span className="font-medium text-slate-800">{drink}</span>
                                    <div className="flex items-center gap-3">
                                        <button onClick={() => handleDrinkChange(drink, -1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300"><MinusIcon className="h-4 w-4" /></button>
                                        <span className="text-lg font-semibold w-8 text-center">{drinkQuantities[drink] || 0}</span>
                                        <button onClick={() => handleDrinkChange(drink, 1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300" disabled={allocatedDrinkCount >= quantity}><PlusIcon className="h-4 w-4" /></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                  )}
                  {item.customizations?.sauceChoice && (
                    <div>
                      <div className="flex justify-between items-baseline mb-3">
                        <h3 className="text-lg font-semibold text-slate-700">主菜沾醬 (每份選2)</h3>
                        <span className={`font-semibold ${totalSauceCount === totalSauceLimit ? 'text-green-600' : 'text-slate-500'}`}>已選 {totalSauceCount} / {totalSauceLimit}</span>
                      </div>
                      <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        {SAUCE_CHOICES.map(sauce => (
                          <div key={sauce} className="flex items-center justify-between bg-slate-50 p-2 rounded-lg">
                            <span className="font-medium text-slate-800 text-sm">{sauce}</span>
                            <div className="flex items-center gap-2">
                              <button onClick={() => handleSauceChange(sauce, -1)} className="p-1 rounded-full bg-slate-200 hover:bg-slate-300"><MinusIcon className="h-4 w-4" /></button>
                              <span className="text-md font-semibold w-5 text-center">{selectedSauces.find(s => s.name === sauce)?.quantity || 0}</span>
                              <button onClick={() => handleSauceChange(sauce, 1)} className="p-1 rounded-full bg-slate-200 hover:bg-slate-300" disabled={totalSauceCount >= totalSauceLimit}><PlusIcon className="h-4 w-4" /></button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  {Object.entries(addonGroups).map(([category, addonList]) => (
                    <div key={category}>
                      <h3 className="text-lg font-semibold text-slate-700 mb-3">{category}</h3>
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        {addonList.map(addon => (
                          <div key={addon.id} className={`flex items-center justify-between p-3 rounded-md ${addon.isAvailable ? 'bg-slate-100' : 'bg-slate-200 opacity-60'}`}>
                            <div>
                              <span className={`text-slate-800 text-sm ${!addon.isAvailable ? 'line-through' : ''}`}>{addon.name}</span>
                              <span className="ml-2 font-semibold text-slate-500 text-sm">+${addon.price}</span>
                              {!addon.isAvailable && <span className="ml-2 text-red-500 text-xs font-bold">售完</span>}
                            </div>
                            <div className="flex items-center gap-2">
                              <button onClick={() => handleAddonQuantityChange(addon, -1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300 disabled:bg-slate-300" disabled={!addon.isAvailable}><MinusIcon className="h-4 w-4" /></button>
                              <span className="text-lg font-semibold w-6 text-center">{selectedAddons.find(a => a.id === addon.id)?.quantity || 0}</span>
                              <button onClick={() => handleAddonQuantityChange(addon, 1)} className="p-1.5 rounded-full bg-slate-200 hover:bg-slate-300 disabled:bg-slate-300" disabled={!addon.isAvailable}><PlusIcon className="h-4 w-4" /></button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                   {item.customizations?.notes && (
                    <div>
                      <h3 className="text-lg font-semibold text-slate-700 mb-3">備註</h3>
                      <textarea value={notes} onChange={e => setNotes(e.target.value)} rows={2} placeholder="有任何特殊需求嗎？" className="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-green-500 outline-none"></textarea>
                    </div>
                  )}
                </main>
                <footer className="p-6 border-t bg-slate-50">
                  <button onClick={handleSubmit} className="w-full bg-green-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-green-700 transition-colors text-lg">
                    {editingItem ? `更新 ${totalPrice} 到購物車` : `加入 ${totalPrice} 到購物車`}
                  </button>
                </footer>
              </div>
            </div>
          );
        };

        // From components/Cart.tsx
        const CartSuccessView = ({ handleNewOrder, orderId, orderData }) => {
            const [orderDetails, setOrderDetails] = React.useState(null);
            const printRef = React.useRef(null);

            React.useEffect(() => {
                if (orderId && orderData) {
                    // Immediately build the details object so the UI can render.
                    // Assume 'Pending' status until we hear back from the server.
                    const initialDetails = {
                        id: orderId,
                        status: '待處理',
                        orderType: orderData.orderType,
                        items: orderData.items,
                        totalAmount: orderData.totalPrice
                    };
                    setOrderDetails(initialDetails);
            
                    const fetchStatus = async () => {
                        const result = await apiService.getOrderStatus(orderId);
                        if (result.success && result.order.status) {
                            // Update the state with the real status
                            setOrderDetails(prevDetails => ({
                                ...prevDetails,
                                status: result.order.status
                            }));
                        }
                        // If it fails, we just stick with '待處理'
                    };
                    fetchStatus();
                } else {
                    setOrderDetails(null);
                }
            }, [orderId, orderData]);
            
            const aggregatedOptions = React.useMemo(() => {
                if (!orderDetails || !orderDetails.items) return { drinks: {}, sauces: {}, addons: {} };
                
                const drinks = {};
                const sauces = {};
                const addons = {};

                orderDetails.items.forEach(cartItem => {
                    if (cartItem.selectedDrinks) {
                        Object.entries(cartItem.selectedDrinks).forEach(([name, quantity]) => {
                            drinks[name] = (drinks[name] || 0) + quantity;
                        });
                    }
                    if (cartItem.selectedSauces) {
                        cartItem.selectedSauces.forEach(sauce => {
                            sauces[sauce.name] = (sauces[sauce.name] || 0) + sauce.quantity;
                        });
                    }
                    if (cartItem.selectedAddons) {
                        cartItem.selectedAddons.forEach(addon => {
                            addons[addon.name] = {
                                quantity: (addons[addon.name]?.quantity || 0) + addon.quantity,
                                price: addon.price
                            };
                        });
                    }
                });

                return { drinks, sauces, addons };
            }, [orderDetails]);

            const handlePrint = () => {
                window.print();
            };

            const handleLineShare = () => {
                if (!orderDetails || !orderDetails.items) return;
                const itemsText = orderDetails.items.map(item => `- ${item.item.name} x${item.quantity}`).join('\n');
                const text = `我的訂單 #${orderDetails.id}\n類型: ${orderDetails.orderType}\n狀態: ${orderDetails.status}\n\n餐點:\n${itemsText}\n\n總金額: $${orderDetails.totalAmount}\n感謝您的訂購！`;
                const url = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
                window.open(url, '_blank');
            };

            return (
                <>
                <div className="flex flex-col h-full">
                    <div className="flex justify-between items-center p-5 border-b no-print">
                        <h2 className="text-2xl font-bold text-slate-800">訂單確認</h2>
                        <button onClick={handleNewOrder} className="text-slate-500 hover:text-slate-800"><CloseIcon /></button>
                    </div>
                    <div className="flex-grow flex flex-col justify-center items-center p-6 text-center">
                        <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
                            <CheckIcon className="h-8 w-8 text-green-600" />
                        </div>
                        <h3 className="text-2xl font-bold text-slate-800 mb-2">訂單提交成功!</h3>
                        <p className="text-slate-500 mb-4">我們會盡快為您準備餐點。</p>
                                                
                        {!orderDetails ? <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-green-700 my-4"></div> : (
                            <div className="w-full text-left">
                                <div ref={printRef} className="print-area w-full bg-slate-50 p-4 rounded-lg mb-4 border space-y-2">
                                    <div className="print-container">
                                        <h3 className="text-lg font-bold text-slate-800 text-center mb-3">訂單摘要</h3>
                                        <div className="flex justify-between items-baseline">
                                            <p className="text-sm text-slate-600">訂單編號:</p>
                                            <p className="font-mono font-bold text-slate-800">{orderDetails.id}</p>
                                        </div>
                                         <div className="flex justify-between items-baseline">
                                            <p className="text-sm text-slate-600">類型:</p>
                                            <p className="font-semibold">{orderDetails.orderType}</p>
                                        </div>
                                         <div className="flex justify-between items-baseline mb-2">
                                            <p className="text-sm text-slate-600">狀態:</p>
                                            <p className="font-semibold">{orderDetails.status}</p>
                                        </div>
                                        
                                        <div className="border-t border-slate-300 pt-2 mt-2">
                                            <div className="max-h-[20rem] overflow-y-auto pr-2 text-sm space-y-4">
                                                <div className="bg-white rounded-lg p-3">
                                                    <h4 className="text-base font-bold text-slate-700 mb-2 pb-1 border-b">餐點列表</h4>
                                                    <div className="space-y-3 text-sm">
                                                    {orderDetails.items.map((item, index) => (
                                                      <div key={item.cartId || index}>
                                                          <p className="font-medium text-slate-800">{item.item.name.replace(/半全餐|半套餐/g, '套餐')} <span className="font-normal">x{item.quantity}</span></p>
                                                          <div className="text-xs text-slate-500 pl-2">
                                                            {item.selectedDonenesses && Object.keys(item.selectedDonenesses).length > 0 && <p>熟度: {Object.entries(item.selectedDonenesses).map(([d, q]) => `${d}x${q}`).join(', ')}</p>}
                                                            {item.selectedNotes && <p>備註: {item.selectedNotes}</p>}
                                                          </div>
                                                      </div>
                                                    ))}
                                                    </div>
                                                </div>

                                                {(Object.keys(aggregatedOptions.drinks).length > 0 || Object.keys(aggregatedOptions.sauces).length > 0 || Object.keys(aggregatedOptions.addons).length > 0) && (
                                                    <div className="bg-slate-100 rounded-lg p-3 text-xs">
                                                        <h5 className="font-bold text-slate-600 border-b pb-1 mb-2">訂單選項總覽</h5>
                                                        <div className="text-slate-700 space-y-1">
                                                            {Object.keys(aggregatedOptions.drinks).length > 0 && <p><span className="font-semibold">飲料:</span> {Object.entries(aggregatedOptions.drinks).map(([name, q]) => `${name} x${q}`).join(', ')}</p>}
                                                            {Object.keys(aggregatedOptions.sauces).length > 0 && <p><span className="font-semibold">沾醬:</span> {Object.entries(aggregatedOptions.sauces).map(([name, q]) => `${name} x${q}`).join(', ')}</p>}
                                                            {Object.keys(aggregatedOptions.addons).length > 0 && (
                                                                <div>
                                                                    <p className="font-semibold">加購:</p>
                                                                    <ul className="list-disc list-inside pl-2">
                                                                    {Object.entries(aggregatedOptions.addons).map(([name, {quantity, price}]) => (
                                                                        <li key={name}>{name} x{quantity} (+${price * quantity})</li>
                                                                    ))}
                                                                    </ul>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="flex justify-between items-center border-t border-slate-300 pt-2 mt-3">
                                            <p className="text-lg font-bold">總金額:</p>
                                            <p className="text-xl font-bold text-green-700">${orderDetails.totalAmount}</p>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex gap-2 justify-center mt-4 no-print">
                                    <button onClick={handleLineShare} className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">LINE 分享</button>
                                    <button onClick={handlePrint} className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">列印訂單</button>
                                </div>
                            </div>
                        )}
                        
                        <button onClick={handleNewOrder} className="mt-6 w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors no-print">
                            繼續點餐
                        </button>
                    </div>
                </div>
                </>
            );
        };


        const CartMainView = ({
            onClose, cartItems, onUpdateQuantity, onRemoveItem, onEditItem, customerInfo, 
            onInfoChange, totalPrice, handleCheckout, isCheckingOut, orderType, setOrderType, validationError
        }) => {
            const aggregatedOptions = React.useMemo(() => {
                const drinks = {};
                const sauces = {};
                const addons = {};

                cartItems.forEach(cartItem => {
                    if (cartItem.selectedDrinks) {
                        Object.entries(cartItem.selectedDrinks).forEach(([name, quantity]) => {
                            drinks[name] = (drinks[name] || 0) + quantity;
                        });
                    }
                    if (cartItem.selectedSauces) {
                        cartItem.selectedSauces.forEach(sauce => {
                            sauces[sauce.name] = (sauces[sauce.name] || 0) + sauce.quantity;
                        });
                    }
                    if (cartItem.selectedAddons) {
                        cartItem.selectedAddons.forEach(addon => {
                            addons[addon.name] = {
                                quantity: (addons[addon.name]?.quantity || 0) + addon.quantity,
                                price: addon.price
                            };
                        });
                    }
                });

                return { drinks, sauces, addons };
            }, [cartItems]);

            return (
                <div className="flex flex-col h-full">
                  <div className="flex justify-between items-center p-5 border-b">
                    <h2 className="text-2xl font-bold text-slate-800">我的購物車</h2>
                    <button onClick={onClose} className="text-slate-500 hover:text-slate-800"><CloseIcon /></button>
                  </div>
                  
                  {cartItems.length === 0 ? (
                    <div className="flex-grow flex flex-col justify-center items-center text-slate-500 p-4">
                      <CartIcon className="w-24 h-24 mb-4 text-slate-300"/>
                      <p className="text-lg">您的購物車是空的</p>
                    </div>
                  ) : (
                    <>
                    <div className="flex-grow overflow-y-auto">
                      <div className="p-5 space-y-6">
                        <div className="bg-slate-50 rounded-lg p-4">
                            <h3 className="text-lg font-bold text-slate-700 mb-3 pb-2 border-b">餐點列表</h3>
                            <div className="space-y-4">
                            {cartItems.map((item, index) => (
                              <div key={item.cartId} className="flex items-start gap-3">
                                <div className="pt-1 font-semibold text-slate-500">{index + 1}.</div>
                                <div className="flex-grow">
                                  <button onClick={() => onEditItem(item.cartId)} className="font-semibold text-left hover:text-blue-600 hover:underline transition-colors focus:outline-none">
                                      {item.item.name.replace(/半全餐|半套餐/g, '套餐')} <span className="font-normal text-slate-500">x{item.quantity}</span>
                                  </button>
                                  <div className="text-sm text-slate-600 mt-1 space-y-0.5">
                                    {item.selectedDonenesses && Object.keys(item.selectedDonenesses).length > 0 && <p>熟度: {Object.entries(item.selectedDonenesses).map(([d, q]) => `${d}x${q}`).join(', ')}</p>}
                                    {item.selectedNotes && <p className="text-blue-600">備註: {item.selectedNotes}</p>}
                                  </div>
                                </div>
                                <div className="text-right flex flex-col items-end">
                                  <p className="font-bold text-lg">${item.totalPrice}</p>
                                  <div className="flex items-center gap-2 mt-3">
                                    <button onClick={() => onUpdateQuantity(item.cartId, item.quantity - 1)} className="p-1 rounded-full bg-slate-200 hover:bg-slate-300"><MinusIcon className="h-4 w-4" /></button>
                                    <span className="font-semibold w-8 text-center">{item.quantity}</span>
                                    <button onClick={() => onUpdateQuantity(item.cartId, item.quantity + 1)} className="p-1 rounded-full bg-slate-200 hover:bg-slate-300"><PlusIcon className="h-4 w-4" /></button>
                                    <button onClick={() => onRemoveItem(item.cartId)} className="text-red-500 hover:text-red-700 ml-1"><TrashIcon className="h-5 w-5"/></button>
                                  </div>
                                </div>
                              </div>
                            ))}
                            </div>
                        </div>

                        <div className="bg-slate-100 rounded-lg p-4 space-y-3">
                            <h3 className="text-md font-bold text-slate-600 border-b pb-2">訂單選項總覽</h3>
                            <div className="text-sm text-slate-700 space-y-1">
                                {Object.keys(aggregatedOptions.drinks).length > 0 && <p><span className="font-semibold">飲料:</span> {Object.entries(aggregatedOptions.drinks).map(([name, q]) => `${name} x${q}`).join(', ')}</p>}
                                {Object.keys(aggregatedOptions.sauces).length > 0 && <p><span className="font-semibold">沾醬:</span> {Object.entries(aggregatedOptions.sauces).map(([name, q]) => `${name} x${q}`).join(', ')}</p>}
                                {Object.keys(aggregatedOptions.addons).length > 0 && (
                                    <div>
                                        <p className="font-semibold">加購:</p>
                                        <ul className="list-disc list-inside pl-2">
                                        {Object.entries(aggregatedOptions.addons).map(([name, {quantity, price}]) => (
                                            <li key={name}>{name} x{quantity} (+${price * quantity})</li>
                                        ))}
                                        </ul>
                                    </div>
                                )}
                            </div>
                        </div>

                      </div>
                      <div className="p-5 border-t bg-slate-100">
                        <div className="mb-4">
                            <h3 className="text-lg font-semibold mb-2 text-slate-700">用餐方式</h3>
                            <div className="flex w-full bg-slate-200 rounded-lg p-1">
                                <button onClick={() => setOrderType('內用')} className={`flex-1 py-2 rounded-md font-semibold transition-colors ${orderType === '內用' ? 'bg-green-600 text-white shadow' : 'text-slate-600'}`}>內用</button>
                                <button onClick={() => setOrderType('外帶')} className={`flex-1 py-2 rounded-md font-semibold transition-colors ${orderType === '外帶' ? 'bg-green-600 text-white shadow' : 'text-slate-600'}`}>外帶</button>
                            </div>
                        </div>

                        <h3 className="text-lg font-semibold mb-3 text-slate-700">顧客資訊</h3>
                        <div className="space-y-3">
                          <input type="text" placeholder="姓名 *" value={customerInfo.name} onChange={(e) => onInfoChange('name', e.target.value)} className="w-full p-2 border border-slate-300 rounded-md" required />
                          <input type="tel" placeholder="電話 * (10位數字)" value={customerInfo.phone} onChange={(e) => onInfoChange('phone', e.target.value)} className="w-full p-2 border border-slate-300 rounded-md" pattern="[0-9]{10}" required />
                          {orderType === '內用' && (
                            <input type="text" placeholder="桌號 (可選)" value={customerInfo.tableNumber} onChange={(e) => onInfoChange('tableNumber', e.target.value)} className="w-full p-2 border border-slate-300 rounded-md" />
                          )}
                        </div>
                      </div>
                    </div>
                    <div className="p-5 border-t bg-slate-50">
                      <div className="flex justify-between items-center mb-4">
                        <span className="text-xl font-medium">總計</span>
                        <span className="text-3xl font-bold text-green-700">${totalPrice}</span>
                      </div>
                      {validationError && (
                          <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-3 mb-3 rounded-md text-center" role="alert">
                            <p className="font-bold">{validationError}</p>
                          </div>
                      )}
                      <button onClick={handleCheckout} disabled={isCheckingOut} className="w-full bg-green-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-green-700 transition-colors text-lg disabled:bg-slate-400 disabled:cursor-not-allowed">
                        {isCheckingOut ? "提交中..." : "確認訂單"}
                      </button>
                    </div>
                    </>
                  )}
                </div>
            )
        };

        const Cart = ({ isOpen, onClose, cartItems, onUpdateQuantity, onRemoveItem, onEditItem, onSubmitOrder }) => {
          const [isCheckingOut, setIsCheckingOut] = React.useState(false);
          const [customerInfo, setCustomerInfo] = React.useState({ name: '', phone: '', tableNumber: '' });
          const [orderType, setOrderType] = React.useState('內用');
          const [orderSubmitted, setOrderSubmitted] = React.useState(false);
          const [submittedOrderId, setSubmittedOrderId] = React.useState(null);
          const [submittedOrderData, setSubmittedOrderData] = React.useState(null);
          const [validationError, setValidationError] = React.useState(null);


          React.useEffect(() => {
            if (!isOpen) {
                setTimeout(() => {
                    setOrderSubmitted(false);
                    setIsCheckingOut(false);
                    setSubmittedOrderId(null);
                    setSubmittedOrderData(null);
                    setOrderType('內用'); // Reset on close
                    setValidationError(null);
                }, 300);
            }
          }, [isOpen]);
          
          React.useEffect(() => {
              if (orderType === '外帶') {
                  setCustomerInfo(prev => ({ ...prev, tableNumber: '' }));
              }
          }, [orderType]);
          
          const handleCustomerInfoChange = (field, value) => {
              if (validationError) {
                  setValidationError(null);
              }
              setCustomerInfo(prev => ({ ...prev, [field]: value }));
          };

          const totalPrice = React.useMemo(() => cartItems.reduce((total, item) => total + item.totalPrice, 0), [cartItems]);

          const handleCheckout = async () => {
            setValidationError(null);
            if (!customerInfo.name.trim()) {
              setValidationError('請填寫您的姓名');
              return;
            }
             if (!customerInfo.phone.trim()) {
              setValidationError('請填寫您的電話');
              return;
            }
            if (!/^[0-9]{10}$/.test(customerInfo.phone)) {
                setValidationError('請輸入有效的手機號碼（10位數字）');
                return;
            }

            setIsCheckingOut(true);
            try {
              const orderData = { items: cartItems, totalPrice, customerInfo, orderType };
              const result = await onSubmitOrder(orderData);
              if (result.success && result.orderId) {
                setSubmittedOrderId(result.orderId);
                setSubmittedOrderData(orderData);
                setOrderSubmitted(true);
              } else {
                setValidationError('訂單提交失敗: ' + (result.message || '未知錯誤'));
              }
            } catch (error) {
              setValidationError('訂單提交失敗: ' + error.message);
            } finally {
              setIsCheckingOut(false);
            }
          };

          const handleNewOrder = () => {
            onClose();
          };
          
          return (
            <>
              <div className={`fixed inset-0 bg-black bg-opacity-50 z-30 transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={onClose} />
              <div className={`fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-lg z-40 transform transition-transform duration-300 ease-in-out ${isOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                {orderSubmitted ? 
                    <CartSuccessView 
                        handleNewOrder={handleNewOrder} 
                        orderId={submittedOrderId} 
                        orderData={submittedOrderData}
                    /> : 
                    <CartMainView 
                        onClose={onClose}
                        cartItems={cartItems}
                        onUpdateQuantity={onUpdateQuantity}
                        onRemoveItem={onRemoveItem}
                        onEditItem={onEditItem}
                        customerInfo={customerInfo}
                        onInfoChange={handleCustomerInfoChange}
                        orderType={orderType}
                        setOrderType={setOrderType}
                        totalPrice={totalPrice}
                        handleCheckout={handleCheckout}
                        isCheckingOut={isCheckingOut}
                        validationError={validationError}
                    />
                }
              </div>
            </>
          );
        };

        // From App.tsx
        const App = () => {
            const [cart, setCart] = React.useState([]);
            const [isCartOpen, setIsCartOpen] = React.useState(false);
            const [selectedItem, setSelectedItem] = React.useState(null);
            const [editingCartItem, setEditingCartItem] = React.useState(null);
            const [isQueryModalOpen, setIsQueryModalOpen] = React.useState(false);

            const [menuData, setMenuData] = React.useState([]);
            const [addons, setAddons] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [isRefreshing, setIsRefreshing] = React.useState(false);
            const [notification, setNotification] = React.useState(null);

            const fetchData = React.useCallback(async () => {
                setNotification(null);
                const { menu, addons, from } = await apiService.getMenuAndAddons();

                if (from === 'api' && (!menu || menu.length === 0 || menu.every(cat => cat.items.length === 0))) {
                    setMenuData(MENU_DATA); // Use fallback data
                    setAddons(ADDONS);
                    setNotification('成功連接伺服器，但菜單是空的。請檢查後台 Google Sheet 是否已填入資料，或執行「一鍵設定工作表」。');
                } else {
                    setMenuData(menu);
                    setAddons(addons);
                    if (from === 'fallback') {
                        setNotification('無法連接伺服器，目前顯示的是離線菜單。');
                    }
                }
            }, []);

            React.useEffect(() => {
                const initialLoad = async () => {
                    setLoading(true);
                    try {
                        await fetchData();
                    } catch (error) {
                        console.error("An unexpected error occurred during initial load:", error);
                    } finally {
                        setLoading(false);
                    }
                };
                initialLoad();
            }, [fetchData]);

            const handleRefresh = async () => {
                setIsRefreshing(true);
                await fetchData();
                setIsRefreshing(false);
            };

            const handleSelectItem = (item, category) => {
                if (!item.isAvailable) return;
                setSelectedItem({ item, category });
            };

            const handleCloseModal = () => {
                setSelectedItem(null);
                setEditingCartItem(null);
            };
            
            const handleEditItem = (cartId) => {
                const itemToEdit = cart.find(i => i.cartId === cartId);
                if(itemToEdit) {
                    const category = menuData.find(c => c.title === itemToEdit.categoryTitle) || { title: itemToEdit.categoryTitle, description: '' };
                    setEditingCartItem(itemToEdit);
                    setSelectedItem({ item: itemToEdit.item, category });
                }
            };
            
            const createCartItemObject = (item, quantity, options, category) => {
                const { donenesses, drinks, addons, notes, sauces } = options;
                
                const generateStableObjectString = (obj) => {
                    if (!obj || Object.keys(obj).length === 0) return '';
                    return JSON.stringify(Object.fromEntries(Object.entries(obj).filter(([, val]) => val && Number(val) > 0).sort(([keyA], [keyB]) => keyA.localeCompare(keyB))));
                };
                
                const totalAddonPrice = (addons || []).reduce((sum, addon) => sum + (addon.price * addon.quantity), 0);
                const totalPrice = item.price * quantity + totalAddonPrice;

                const cartKeyFields = {
                    id: item.id,
                    donenesses: generateStableObjectString(donenesses),
                    drinks: generateStableObjectString(drinks),
                    notes: notes,
                    addons: (addons || []).map((a) => `${a.id}:${a.quantity}`).sort().join(','),
                    sauces: (sauces || []).map((s) => `${s.name}:${s.quantity}`).sort().join(','),
                };
                const cartKey = JSON.stringify(cartKeyFields);

                return {
                    cartKey,
                    item,
                    quantity,
                    categoryTitle: category.title,
                    selectedDonenesses: donenesses,
                    selectedDrinks: drinks,
                    selectedAddons: addons || [],
                    selectedSauces: sauces || [],
                    selectedNotes: notes,
                    totalPrice,
                };
            };
            
            const handleConfirmSelection = (item, quantity, options, category) => {
                const newOrUpdatedCartItem = createCartItemObject(item, quantity, options, category);

                if (editingCartItem) {
                    setCart(prevCart => prevCart.map(cartItem => 
                        cartItem.cartId === editingCartItem.cartId 
                        ? { ...newOrUpdatedCartItem, cartId: editingCartItem.cartId } 
                        : cartItem
                    ));
                } else {
                     setCart(prevCart => {
                        const existingItemIndex = prevCart.findIndex(cartItem => cartItem.cartKey === newOrUpdatedCartItem.cartKey);

                        if (existingItemIndex > -1) {
                            const updatedCart = [...prevCart];
                            const existingItem = updatedCart[existingItemIndex];
                            const newQuantity = existingItem.quantity + quantity;
                            const totalAddonPrice = (existingItem.selectedAddons || []).reduce((sum, addon) => sum + (addon.price * addon.quantity), 0);
                             const newTotalPrice = (item.price * newQuantity) + totalAddonPrice;


                            updatedCart[existingItemIndex] = { 
                                ...existingItem, 
                                quantity: newQuantity,
                                totalPrice: newTotalPrice
                            };
                            return updatedCart;
                        } else {
                             const finalCartItem = { 
                                ...newOrUpdatedCartItem,
                                cartId: `${newOrUpdatedCartItem.cartKey}-${Date.now()}`,
                            };
                            return [...prevCart, finalCartItem];
                        }
                    });
                }
            };
            
            const handleUpdateQuantity = (cartId, newQuantity) => {
                setCart(prevCart => {
                    if (newQuantity <= 0) {
                        return prevCart.filter(item => item.cartId !== cartId);
                    }
                    return prevCart.map(item => {
                        if (item.cartId === cartId) {
                            const totalAddonPrice = item.selectedAddons.reduce((sum, addon) => sum + (addon.price * addon.quantity), 0);
                            const newTotalPrice = (item.item.price * newQuantity) + totalAddonPrice;
                            return { ...item, quantity: newQuantity, totalPrice: newTotalPrice };
                        }
                        return item;
                    });
                });
            };

            const handleRemoveFromCart = (cartId) => {
                setCart(prevCart => prevCart.filter(item => item.cartId !== cartId));
            };

            const handleSubmitOrder = async (orderData) => {
                const result = await apiService.submitOrder(orderData);
                if (result.success) {
                    setCart([]);
                    if (result.orderId) {
                        const savedOrders = JSON.parse(localStorage.getItem('steakhouse-orders') || '[]');
                        if (!savedOrders.includes(result.orderId)) {
                            savedOrders.unshift(result.orderId); // Add to the beginning
                            localStorage.setItem('steakhouse-orders', JSON.stringify(savedOrders.slice(0, 10))); // Keep last 10
                        }
                    }
                }
                return result;
            };
            
            const cartItemCount = React.useMemo(() => cart.reduce((total, item) => total + item.quantity, 0), [cart]);

            if (loading) {
                return (
                    <div className="min-h-screen flex flex-col justify-center items-center bg-slate-100">
                        <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-green-700"></div>
                        <p className="mt-4 text-slate-600 text-lg">正在載入菜單...</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-100 text-slate-800">
                     {notification && (
                        <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 text-center" role="alert">
                            <p className="font-bold">{notification}</p>
                        </div>
                    )}
                    <header className="bg-white shadow-md sticky top-0 z-20">
                        <div className="container mx-auto px-4 py-4 sm:px-6 lg:px-8 flex justify-between items-center">
                            <h1 className="text-2xl sm:text-3xl font-bold text-green-800 tracking-wider">美味廚房點餐系統</h1>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setIsQueryModalOpen(true)} className="flex items-center gap-2 px-3 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors text-sm font-medium">
                                    <SearchIcon className="h-4 w-4"/>
                                    <span>查詢訂單</span>
                                </button>
                                <button onClick={handleRefresh} disabled={isRefreshing} className="flex items-center gap-2 px-3 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors text-sm font-medium disabled:opacity-50">
                                    <RefreshIcon className={`h-4 w-4 ${isRefreshing ? 'animate-spin' : ''}`}/>
                                    <span>{isRefreshing ? '刷新中' : '刷新'}</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="container mx-auto p-4 md:p-6 lg:p-8">
                        <Menu menuData={menuData} onSelectItem={handleSelectItem} />
                    </main>

                    <footer className="container mx-auto px-4 py-8 sm:px-6 lg:px-8 text-center text-slate-500 text-sm">
                        <div className="border-t border-slate-200 pt-8 space-y-2">
                            <p>＊店內最低消費為一份餐點</p>
                            <p>＊不收服務費，用完餐請回收餐具</p>
                            <p>＊用餐限九十分鐘請勿飲酒</p>
                            <p>＊餐點內容以現場出餐為準，餐點現點現做請耐心等候</p>
                        </div>
                    </footer>

                    {cartItemCount > 0 && (
                        <button
                            onClick={() => setIsCartOpen(true)}
                            className="fixed bottom-6 right-6 lg:bottom-10 lg:right-10 flex items-center justify-center bg-green-700 text-white rounded-full shadow-lg hover:bg-green-800 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-700 focus:ring-opacity-50 h-16 w-16"
                            aria-label={`查看購物車，共有 ${cartItemCount} 項商品`}
                        >
                            <CartIcon className="h-8 w-8" />
                            <span className="absolute -top-1 -right-1 flex h-6 w-6 items-center justify-center rounded-full bg-red-500 text-xs font-bold">{cartItemCount}</span>
                        </button>
                    )}

                    <Cart
                        isOpen={isCartOpen}
                        onClose={() => setIsCartOpen(false)}
                        cartItems={cart}
                        onUpdateQuantity={handleUpdateQuantity}
                        onRemoveItem={handleRemoveFromCart}
                        onEditItem={handleEditItem}
                        onSubmitOrder={handleSubmitOrder}
                    />

                    {selectedItem && (
                        <ItemModal
                            selectedItem={selectedItem}
                            editingItem={editingCartItem}
                            addons={addons}
                            onClose={handleCloseModal}
                            onConfirmSelection={handleConfirmSelection}
                        />
                    )}
                    
                    <OrderQueryModal
                        isOpen={isQueryModalOpen}
                        onClose={() => setIsQueryModalOpen(false)}
                    />
                </div>
            );
        };

        // From index.tsx
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error("Could not find root element to mount to");
        }
        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
    </script>
</body>
</html>
